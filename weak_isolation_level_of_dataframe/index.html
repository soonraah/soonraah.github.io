<!doctype html>
<html lang="jp">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name="hugo-theme" content="Axiom 0.7.0">



  <link rel="icon" type="image/png" sizes="32x32" href="/image/brand/favicon.png">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link rel="apple-touch-icon" href="/">
  <link rel="canonical" href="https://soonraah.github.io/weak_isolation_level_of_dataframe/">
<link rel="preload" as="style" href="/bundle.css?v=1595258565" media="all">
<link rel="stylesheet" href="/bundle.css?v=1595258565" media="all">
<style>.cdata pre{color:#edf2f7;background-color:#2d3748}.cdata :not(pre)>code{color:#805ad5;background-color:#f7fafc}.chroma .err{color:#fed7d7;background-color:#9b2c2c}.chroma .hl{background-color:#4a5568}.chroma .ln{color:#a0aec0}.chroma .k,.chroma .kc,.chroma .kd,.chroma .kn,.chroma .kp,.chroma .kr{color:#63b3ed}.chroma .kt{color:#b794f4}.chroma .na{color:#f6e05e}.chroma .nb{color:#f6ad55}.chroma .nc{color:#fc8181}.chroma .no{color:#68d391}.chroma .nd{color:#fc8181}.chroma .ne{color:#fc8181}.chroma .nf{color:#f6ad55}.chroma .nt{color:#fc8181}.chroma .l{color:#b794f4}.chroma .dl,.chroma .ld,.chroma .s,.chroma .s2,.chroma .sa,.chroma .sb,.chroma .sc,.chroma .sd{color:#68d391}.chroma .se{color:#a0aec0}.chroma .s1,.chroma .sh,.chroma .si,.chroma .sr,.chroma .ss,.chroma .sx{color:#68d391}.chroma .il,.chroma .m,.chroma .mb,.chroma .mf,.chroma .mh,.chroma .mi,.chroma .mo{color:#b794f4}.chroma .o,.chroma .ow{color:#90cdf4}.chroma .p{color:#cbd5e0}.chroma .c,.chroma .c1,.chroma .ch,.chroma .cm,.chroma .cp,.chroma .cpf,.chroma .cs{color:#a0aec0}.chroma .ge{font-style:italic}.chroma .gs{font-weight:700}</style>



<title>Spark DataFrame クエリの弱い分離レベル : Froglog</title>

<meta property="og:title" content="Spark DataFrame クエリの弱い分離レベル">
<meta property="og:site_name" content="Froglog">
<meta property="og:url" content="https://soonraah.github.io/weak_isolation_level_of_dataframe/">
<link rel="image_src" href="https://soonraah.github.io/">
<meta property="og:image" content="https://soonraah.github.io/">
<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">
<meta property="og:type" content="article">
<meta property="og:locale" content="jp">
<meta property="og:description" content="Spark バッチ処理の問題を調べていたら分離レベルという概念にたどりついた。 分離レベルについて調べたので、Spark の問題の内容と絡めて記しておく。 考えてみれば当たり前でたいした話ではない。 分離レベルとは トランザクションの挙動についての暗黙の理解 アドホックな分析クエリやプロダクションコード中のクエリを書くとき、その単一のクエリのトランザクションにおいて「同時に実行されている別のクエリの commit 前の状態や commit 結果に影響され、このクエリの結果がおかしくなるかもしれない」ということは通常考えない。 トランザクションはデータベースのある時点の状態に対して正しく処理される、というほぼ無意識の理解をおそらくほとんどの開発者が持っている。 多くの場合この理解は間違っていない。 それはなぜかというと DB 等のデータ処理フレームワークがある強さの分離レベルを提供しているからである。 いろいろな分離レベル ACID 特性のうちの1つ、分離性 (Isolation) の程度を表すのが分離レベル。  トランザクション中に行われる操作の過程が他の操作から隠蔽されることを指し、日本語では分離性、独立性または隔離性ともいう。より形式的には、独立性とはトランザクション履歴が直列化されていることと言える。この性質と性能はトレードオフの関係にあるため、一般的にはこの性質の一部を緩和して実装される場合が多い。 — Wikipedia ACID (コンピュータ科学)  分離レベルには名前のついたものがいくつかあり、分離性の保証の強さが異なる。 具体的にはトランザクションの並行性の問題への対応力が異なる。 名著「データ指向アプリケーションデザイン」の第7章で分離レベルについて詳しく述べられているので、以下ではそちらからの引用。 分離レベルを弱い順に並べる。   read uncommitted  このレベルではダーティライトは生じませんが、ダーティリードは妨げられません。    read committed">
<meta name="description" content="Spark バッチ処理の問題を調べていたら分離レベルという概念にたどりついた。 分離レベルについて調べたので、Spark の問題の内容と絡めて記しておく。 考えてみれば当たり前でたいした話ではない。 分離レベルとは トランザクションの挙動についての暗黙の理解 アドホックな分析クエリやプロダクションコード中のクエリを書くとき、その単一のクエリのトランザクションにおいて「同時に実行されている別のクエリの commit 前の状態や commit 結果に影響され、このクエリの結果がおかしくなるかもしれない」ということは通常考えない。 トランザクションはデータベースのある時点の状態に対して正しく処理される、というほぼ無意識の理解をおそらくほとんどの開発者が持っている。 多くの場合この理解は間違っていない。 それはなぜかというと DB 等のデータ処理フレームワークがある強さの分離レベルを提供しているからである。 いろいろな分離レベル ACID 特性のうちの1つ、分離性 (Isolation) の程度を表すのが分離レベル。  トランザクション中に行われる操作の過程が他の操作から隠蔽されることを指し、日本語では分離性、独立性または隔離性ともいう。より形式的には、独立性とはトランザクション履歴が直列化されていることと言える。この性質と性能はトレードオフの関係にあるため、一般的にはこの性質の一部を緩和して実装される場合が多い。 — Wikipedia ACID (コンピュータ科学)  分離レベルには名前のついたものがいくつかあり、分離性の保証の強さが異なる。 具体的にはトランザクションの並行性の問題への対応力が異なる。 名著「データ指向アプリケーションデザイン」の第7章で分離レベルについて詳しく述べられているので、以下ではそちらからの引用。 分離レベルを弱い順に並べる。   read uncommitted  このレベルではダーティライトは生じませんが、ダーティリードは妨げられません。    read committed">
<meta property="og:updated_time" content="2020-07-19T13:00:00Z">
<meta property="fb:app_id" content="">
<meta name="author" content="soonraah">
<meta property="article:author" content="https://soonraah.github.io/">
<meta property="article:published_time" content="2020-07-19T13:00:00Z">
<meta property="article:modified_time" content="2020-07-19T13:00:00Z">
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": "Spark DataFrame クエリの弱い分離レベル",
  "alternativeHeadline": "Spark バッチ処理の問題を調べていたら分離レベルという概念にたどりついた。 分離レベルについて調べたので、Spark の問題の内容と絡めて記しておく。 考えてみれば当たり前でたいした話ではない。 分離レベルとは トランザクションの挙動についての暗黙の理解 アドホックな分析クエリやプロダクションコード中のクエリを書くとき、その単一のクエリのトランザクションにおいて「同時に実行されている別のクエリの commit 前の状態や commit 結果に影響され、このクエリの結果がおかしくなるかもしれない」ということは通常考えない。 トランザクションはデータベースのある時点の状態に対して正しく処理される、というほぼ無意識の理解をおそらくほとんどの開発者が持っている。 多くの場合この理解は間違っていない。 それはなぜかというと DB 等のデータ処理フレームワークがある強さの分離レベルを提供しているからである。 いろいろな分離レベル ACID 特性のうちの1つ、分離性 (Isolation) の程度を表すのが分離レベル。  トランザクション中に行われる操作の過程が他の操作から隠蔽されることを指し、日本語では分離性、独立性または隔離性ともいう。より形式的には、独立性とはトランザクション履歴が直列化されていることと言える。この性質と性能はトレードオフの関係にあるため、一般的にはこの性質の一部を緩和して実装される場合が多い。 — Wikipedia ACID (コンピュータ科学)  分離レベルには名前のついたものがいくつかあり、分離性の保証の強さが異なる。 具体的にはトランザクションの並行性の問題への対応力が異なる。 名著「データ指向アプリケーションデザイン」の第7章で分離レベルについて詳しく述べられているので、以下ではそちらからの引用。 分離レベルを弱い順に並べる。   read uncommitted  このレベルではダーティライトは生じませんが、ダーティリードは妨げられません。    read committed",
  "url": "https://soonraah.github.io/weak_isolation_level_of_dataframe/",
  "image": "https://soonraah.github.io/",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://soonraah.github.io/weak_isolation_level_of_dataframe/"
  },
  "description": "Spark バッチ処理の問題を調べていたら分離レベルという概念にたどりついた。 分離レベルについて調べたので、Spark の問題の内容と絡めて記しておく。 考えてみれば当たり前でたいした話ではない。 分離レベルとは トランザクションの挙動についての暗黙の理解 アドホックな分析クエリやプロダクションコード中のクエリを書くとき、その単一のクエリのトランザクションにおいて「同時に実行されている別のクエリの commit 前の状態や commit 結果に影響され、このクエリの結果がおかしくなるかもしれない」ということは通常考えない。 トランザクションはデータベースのある時点の状態に対して正しく処理される、というほぼ無意識の理解をおそらくほとんどの開発者が持っている。 多くの場合この理解は間違っていない。 それはなぜかというと DB 等のデータ処理フレームワークがある強さの分離レベルを提供しているからである。 いろいろな分離レベル ACID 特性のうちの1つ、分離性 (Isolation) の程度を表すのが分離レベル。  トランザクション中に行われる操作の過程が他の操作から隠蔽されることを指し、日本語では分離性、独立性または隔離性ともいう。より形式的には、独立性とはトランザクション履歴が直列化されていることと言える。この性質と性能はトレードオフの関係にあるため、一般的にはこの性質の一部を緩和して実装される場合が多い。 — Wikipedia ACID (コンピュータ科学)  分離レベルには名前のついたものがいくつかあり、分離性の保証の強さが異なる。 具体的にはトランザクションの並行性の問題への対応力が異なる。 名著「データ指向アプリケーションデザイン」の第7章で分離レベルについて詳しく述べられているので、以下ではそちらからの引用。 分離レベルを弱い順に並べる。   read uncommitted  このレベルではダーティライトは生じませんが、ダーティリードは妨げられません。    read committed",
  "author": {
    "@type": "Person",
    "name": "soonraah"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Froglog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://soonraah.github.io/"
    }
  },
  "datePublished": "2020-07-19T13:00:00Z",
  "dateModified": "2020-07-19T13:00:00Z",
  "articleBody": "\u003cp\u003eSpark バッチ処理の問題を調べていたら分離レベルという概念にたどりついた。\n分離レベルについて調べたので、Spark の問題の内容と絡めて記しておく。\n考えてみれば当たり前でたいした話ではない。\u003c/p\u003e\n\u003ch1 id=\"分離レベルとは\"\u003e分離レベルとは\u003c/h1\u003e\n\u003ch2 id=\"トランザクションの挙動についての暗黙の理解\"\u003eトランザクションの挙動についての暗黙の理解\u003c/h2\u003e\n\u003cp\u003eアドホックな分析クエリやプロダクションコード中のクエリを書くとき、その単一のクエリのトランザクションにおいて「同時に実行されている別のクエリの commit 前の状態や commit 結果に影響され、このクエリの結果がおかしくなるかもしれない」ということは通常考えない。\nトランザクションはデータベースのある時点の状態に対して正しく処理される、というほぼ無意識の理解をおそらくほとんどの開発者が持っている。\u003c/p\u003e\n\u003cp\u003e多くの場合この理解は間違っていない。\nそれはなぜかというと DB 等のデータ処理フレームワークがある強さの分離レベルを提供しているからである。\u003c/p\u003e\n\u003ch2 id=\"いろいろな分離レベル\"\u003eいろいろな分離レベル\u003c/h2\u003e\n\u003cp\u003eACID 特性のうちの1つ、分離性 (Isolation) の程度を表すのが分離レベル。\u003c/p\u003e\n\n\u003cblockquote\u003e\n  \u003cp\u003eトランザクション中に行われる操作の過程が他の操作から隠蔽されることを指し、日本語では分離性、独立性または隔離性ともいう。より形式的には、独立性とはトランザクション履歴が直列化されていることと言える。この性質と性能はトレードオフの関係にあるため、一般的にはこの性質の一部を緩和して実装される場合が多い。\u003c/p\u003e\n  \u003cfooter\u003e\u0026#8212; Wikipedia \u003ccite title=\"ACID (コンピュータ科学)\"\u003e\u003ca rel=\"noopener nofollow\" href=\"https://ja.wikipedia.org/wiki/ACID_%28%E3%82%B3%E3%83%B3%E3%83%94%E3%83%A5%E3%83%BC%E3%82%BF%E7%A7%91%E5%AD%A6%29\"\u003eACID (コンピュータ科学)\u003c/a\u003e\u003c/cite\u003e\u003c/footer\u003e\n\u003c/blockquote\u003e\n\n\u003cp\u003e分離レベルには名前のついたものがいくつかあり、分離性の保証の強さが異なる。\n具体的にはトランザクションの並行性の問題への対応力が異なる。\n名著「\u003ca href=\"https://www.oreilly.co.jp/books/9784873118703/\"\u003eデータ指向アプリケーションデザイン\u003c/a\u003e」の第7章で分離レベルについて詳しく述べられているので、以下ではそちらからの引用。\n分離レベルを弱い順に並べる。\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003eread uncommitted\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eこのレベルではダーティライトは生じませんが、ダーティリードは妨げられません。\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eread committed\u003c/p\u003e\n\u003cblockquote\u003e\n\u003col\u003e\n\u003cli\u003eデータベースからの読み取りを行った際に見えるデータは、コミットされたもののみであること（ダーティリードは生じない）。\u003c/li\u003e\n\u003cli\u003eデータベースへの書き込みを行う場合、上書きするのはコミットされたデータのみであること（ダーティライトは生じない）。\u003c/li\u003e\n\u003c/ol\u003e\n\u003c/blockquote\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003esnapshot isolation\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eスナップショット分離の考え方は、それぞれのトランザクションがデータベースの一貫性のあるスナップショットから読み取りを行うというものです。すなわち、トランザクションが読み取るデータは、すべてそのトランザクションの開始時点のデータベースにコミット済みのものだけということです。\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eserializability\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eこの分離レベルはトランザクションが並行して実行されていても、最終的な答えはそれぞれが1つずつ順番に、並行ではなく実行された場合と同じになることを保証します。\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e日本語で「分離レベル」を検索すると snapshot isolation の代わりに repeatable read が出てくる事が多い。\nしかし repeatable read の名前は実装によって意味が違っていたりして扱いが難しいらしい。\u003c/p\u003e\n\u003ch2 id=\"分離レベルと-race-condition-の関係\"\u003e分離レベルと race condition の関係\u003c/h2\u003e\n\u003cp\u003e以下に各分離レベルとトランザクションの並行性の問題 (race condition) の関係を示す。\n各 race condition の説明については割愛するが、複数のトランザクションが並行して実行されることにより起こりうる期待されていない挙動だと思えばよい。\n○はその分離レベルにおいてその race condition が発生しないことを示す。\n△は条件によっては発生する。\u003c/p\u003e\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth\u003e\u003c/th\u003e\n\u003cth\u003edirty read\u003c/th\u003e\n\u003cth\u003edirty write\u003c/th\u003e\n\u003cth\u003eread skew (nonrepeatable read)\u003c/th\u003e\n\u003cth\u003elost update\u003c/th\u003e\n\u003cth\u003ewrite skew\u003c/th\u003e\n\u003cth\u003ephantom read\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd\u003eread uncommitted\u003c/td\u003e\n\u003ctd\u003e○\u003c/td\u003e\n\u003ctd\u003e-\u003c/td\u003e\n\u003ctd\u003e-\u003c/td\u003e\n\u003ctd\u003e-\u003c/td\u003e\n\u003ctd\u003e-\u003c/td\u003e\n\u003ctd\u003e-\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eread committed\u003c/td\u003e\n\u003ctd\u003e○\u003c/td\u003e\n\u003ctd\u003e○\u003c/td\u003e\n\u003ctd\u003e-\u003c/td\u003e\n\u003ctd\u003e-\u003c/td\u003e\n\u003ctd\u003e-\u003c/td\u003e\n\u003ctd\u003e-\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003esnapshot isolation\u003c/td\u003e\n\u003ctd\u003e○\u003c/td\u003e\n\u003ctd\u003e○\u003c/td\u003e\n\u003ctd\u003e○\u003c/td\u003e\n\u003ctd\u003e△\u003c/td\u003e\n\u003ctd\u003e-\u003c/td\u003e\n\u003ctd\u003e△\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eserializability\u003c/td\u003e\n\u003ctd\u003e○\u003c/td\u003e\n\u003ctd\u003e○\u003c/td\u003e\n\u003ctd\u003e○\u003c/td\u003e\n\u003ctd\u003e○\u003c/td\u003e\n\u003ctd\u003e○\u003c/td\u003e\n\u003ctd\u003e○\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\u003cp\u003e下に行くほど強い分離レベルとなっている。\n分離レベルが強くなるほど race condition が発生しにくくなるが、一方で lock 等によりパフォーマンスが下がっていくというトレードオフがある。\u003c/p\u003e\n\u003ch1 id=\"各種データベースの分離レベル\"\u003e各種データベースの分離レベル\u003c/h1\u003e\n\u003cp\u003eここでは MySQL と Hive においてどの分離レベルが提供されているかを見てみる。\u003c/p\u003e\n\u003ch2 id=\"mysql-の場合\"\u003eMySQL の場合\u003c/h2\u003e\n\u003cp\u003eMySQL の分離レベルについては以下のドキュメントで述べられている。\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://dev.mysql.com/doc/refman/8.0/en/innodb-transaction-isolation-levels.html\"\u003e15.7.2.1 Transaction Isolation Levels\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eMySQL (というか InnoDB?) では次の4つの分離レベルを設定することができる。\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003eREAD UNCOMMITTED\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eREAD COMMITTED\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eREPEATABLE READ\u003c/code\u003e (default)\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eSERIALIZABLE\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eデフォルトの分離レベルは \u003ccode\u003eREPEATABLE READ\u003c/code\u003e だが、これは前述の snapshot isolation に相当するらしい。\n分離レベルは、例えば \u003ccode\u003eset transaction\u003c/code\u003e 構文により次のようにして指定できる。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"chroma\"\u003e\u003ccode class=\"language-mysql\" data-lang=\"mysql\"\u003e\u003cspan class=\"kt\"\u003eset\u003c/span\u003e \u003cspan class=\"n\"\u003etransaction\u003c/span\u003e \u003cspan class=\"n\"\u003eisolation\u003c/span\u003e \u003cspan class=\"n\"\u003elevel\u003c/span\u003e \u003cspan class=\"n\"\u003eSERIALIZABLE\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eこの場合は現在のセッション内で実行される次のトランザクションについて適用される。\nすべてのセッションやすべてのトランザクション等の指定もできる。\n詳しくは以下。\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://dev.mysql.com/doc/refman/8.0/en/set-transaction.html\"\u003e13.3.7 SET TRANSACTION Statement\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"hive-の場合\"\u003eHive の場合\u003c/h2\u003e\n\u003cp\u003eHive についてはドキュメントに次のような記載がある。\u003c/p\u003e\n\n\u003cblockquote\u003e\n  \u003cp\u003eAt this time only snapshot level isolation is supported.  When a given query starts it will be provided with a consistent snapshot of the data.\u003c/p\u003e\n  \u003cfooter\u003e\u0026#8212; Apache Hive \u003ccite title=\"Hive Transactions\"\u003e\u003ca rel=\"noopener nofollow\" href=\"https://cwiki.apache.org/confluence/display/Hive/Hive\u0026#43;Transactions#HiveTransactions-Limitations\"\u003eHive Transactions\u003c/a\u003e\u003c/cite\u003e\u003c/footer\u003e\n\u003c/blockquote\u003e\n\n\u003cp\u003eHive は snapshot isolation のみ提供しているとのこと。\u003c/p\u003e\n\n\u003cblockquote\u003e\n  \u003cp\u003eThe default DummyTxnManager emulates behavior of old Hive versions: has no transactions and uses hive.lock.manager property to create lock manager for tables, partitions and databases.\u003c/p\u003e\n  \u003cfooter\u003e\u0026#8212; Apache Hive \u003ccite title=\"Hive Transactions\"\u003e\u003ca rel=\"noopener nofollow\" href=\"https://cwiki.apache.org/confluence/display/Hive/Hive\u0026#43;Transactions#HiveTransactions-Transaction/LockManager\"\u003eHive Transactions\u003c/a\u003e\u003c/cite\u003e\u003c/footer\u003e\n\u003c/blockquote\u003e\n\n\u003cp\u003elock は小さくとも partition の単位になるのだろうか。\nであるとすると予想通りだが MySQL よりもいかつい挙動になっている。\u003c/p\u003e\n\u003cp\u003eこのように多くの DB では snapshot isolation の分離レベルが基本となっている。\u003c/p\u003e\n\u003ch1 id=\"spark-クエリの分離レベル\"\u003eSpark クエリの分離レベル\u003c/h1\u003e\n\u003cp\u003eでは Spark のクエリはどうだろうか。\nここからようやく本題となる。\u003c/p\u003e\n\u003ch2 id=\"read-committed-相当\"\u003eread committed 相当\u003c/h2\u003e\n\u003cp\u003eSpark において \u003ccode\u003eDataFrame\u003c/code\u003e を用いたデータ処理を記述するとき、それは1つの SQL クエリを書くのと近い感覚になる。\nそもそも \u003ccode\u003eDataFrame\u003c/code\u003e は SQL-like な使い心地を目的として作られた API だから当然だ。\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eDataFrame\u003c/code\u003e で記述された処理は実行時に \u003ccode\u003eRDD\u003c/code\u003e として翻訳されるが、分離レベルを考えるにあたって \u003ccode\u003eRDD\u003c/code\u003e の特性がキーとなってくる。\u003c/p\u003e\n\n\u003cblockquote\u003e\n  \u003cp\u003eBy default, each transformed RDD may be recomputed each time you run an action on it.\u003c/p\u003e\n  \u003cfooter\u003e\u0026#8212; Apache Spark \u003ccite title=\"RDD Operations\"\u003e\u003ca rel=\"noopener nofollow\" href=\"https://spark.apache.org/docs/3.0.0/rdd-programming-guide.html#rdd-operations\"\u003eRDD Operations\u003c/a\u003e\u003c/cite\u003e\u003c/footer\u003e\n\u003c/blockquote\u003e\n\n\u003cp\u003eあまり良い説明を見つけられなかったが、1回の action を伴う処理においても同じ \u003ccode\u003eRDD\u003c/code\u003e が複数回参照されるとき、その \u003ccode\u003eRDD\u003c/code\u003e までの計算は通常やり直されることになる。\u003c/p\u003e\n\u003cp\u003eしたがって例えば self join のようなことをするとき、同じデータソースを2回読みに行くということが起こってしまう。\nHDFS や S3 上のファイル、JDBC 経由の外部 DB など Spark は様々なデータソースを扱うことができるが、通常 Spark がその2回の読み込みに対して lock をかけたりすることはできない。\u003c/p\u003e\n\u003cp\u003eつまり non-repeatable read や phantom read を防ぐことができない。\nread committed という弱い分離レベルに相当するということになってしまう。\u003c/p\u003e\n\u003cp\u003e分離レベルという言葉はトランザクションという概念に対して使われるものであり、\u003ccode\u003eDataFrame\u003c/code\u003e のクエリをトランザクションと呼んでいいのかはわからない。\nなので分離レベルという言葉をここで使うのが適切でないかもしれないということは述べておく。\u003c/p\u003e\n\u003ch2 id=\"検証\"\u003e検証\u003c/h2\u003e\n\u003cp\u003eMySQL からデータを読み取り Spark で処理することを考える。\nまず local の MySQL で次のような table を用意する。\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003emysql\u0026gt; describe employees;\n+---------------+---------+------+-----+---------+-------+\n| Field         | Type    | Null | Key | Default | Extra |\n+---------------+---------+------+-----+---------+-------+\n| id            | int(11) | NO   | PRI | NULL    |       |\n| salary        | int(11) | YES  |     | NULL    |       |\n| department_id | int(11) | YES  |     | NULL    |       |\n+---------------+---------+------+-----+---------+-------+\n3 rows in set (0.03 sec)\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e部署 (department) ごとの給料 (salary) の平均から各従業員の給料がどれくらい離れているかの差分を見たいものとする。\nSpark のコードは次のようになる。\nSpark のバージョンはこれを書いている時点での最新 3.0.0 とした。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"chroma\"\u003e\u003ccode class=\"language-scala\" data-lang=\"scala\"\u003e\u003cspan class=\"k\"\u003epackage\u003c/span\u003e \u003cspan class=\"nn\"\u003ecom.example\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003eimport\u003c/span\u003e \u003cspan class=\"nn\"\u003eorg.apache.spark.sql.functions.avg\u003c/span\u003e\n\u003cspan class=\"k\"\u003eimport\u003c/span\u003e \u003cspan class=\"nn\"\u003eorg.apache.spark.sql.SparkSession\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003eobject\u003c/span\u003e \u003cspan class=\"nc\"\u003eIsolationLevelExperiment\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"k\"\u003edef\u003c/span\u003e \u003cspan class=\"n\"\u003emain\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eargs\u003c/span\u003e\u003cspan class=\"k\"\u003e:\u003c/span\u003e \u003cspan class=\"kt\"\u003eArray\u003c/span\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"kt\"\u003eString\u003c/span\u003e\u003cspan class=\"o\"\u003e])\u003c/span\u003e\u003cspan class=\"k\"\u003e:\u003c/span\u003e \u003cspan class=\"kt\"\u003eUnit\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// Prepare SparkSession\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"k\"\u003eval\u003c/span\u003e \u003cspan class=\"n\"\u003espark\u003c/span\u003e \u003cspan class=\"k\"\u003e=\u003c/span\u003e \u003cspan class=\"nc\"\u003eSparkSession\u003c/span\u003e\n      \u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ebuilder\u003c/span\u003e\u003cspan class=\"o\"\u003e()\u003c/span\u003e\n      \u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eappName\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Isolation Level Experiment\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n      \u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003emaster\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;local[*]\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n      \u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003egetOrCreate\u003c/span\u003e\u003cspan class=\"o\"\u003e()\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eimport\u003c/span\u003e \u003cspan class=\"nn\"\u003espark.implicits._\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// Read from MySQL\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"k\"\u003eval\u003c/span\u003e \u003cspan class=\"n\"\u003edfEmployee\u003c/span\u003e \u003cspan class=\"k\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003espark\u003c/span\u003e\n      \u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eread\u003c/span\u003e\n      \u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eformat\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;jdbc\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n      \u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eoption\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;url\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;jdbc:mysql://localhost\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n      \u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eoption\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;dbtable\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;db_name.employees\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n      \u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eoption\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;user\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;user_name\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n      \u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eoption\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;password\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;********\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n      \u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eoption\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;driver\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;com.mysql.cj.jdbc.Driver\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n      \u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eload\u003c/span\u003e\n      \u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ecache\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// Get average salary\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"k\"\u003eval\u003c/span\u003e \u003cspan class=\"n\"\u003edfAvg\u003c/span\u003e \u003cspan class=\"k\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003edfEmployee\u003c/span\u003e\n      \u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003egroupBy\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e$\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;department_id\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n      \u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eagg\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eavg\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e$\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;salary\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e).\u003c/span\u003e\u003cspan class=\"n\"\u003eas\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;avg_salary\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e))\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// Calculate diff\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"k\"\u003eval\u003c/span\u003e \u003cspan class=\"n\"\u003edfResult\u003c/span\u003e \u003cspan class=\"k\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003edfEmployee\u003c/span\u003e\n      \u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eas\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;e\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n      \u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ejoin\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\n        \u003cspan class=\"n\"\u003edfAvg\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eas\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;a\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e),\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e$\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;e.department_id\u0026#34;\u003c/span\u003e \u003cspan class=\"o\"\u003e===\u003c/span\u003e \u003cspan class=\"n\"\u003e$\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;a.department_id\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"s\"\u003e\u0026#34;left_outer\u0026#34;\u003c/span\u003e\n      \u003cspan class=\"o\"\u003e)\u003c/span\u003e\n      \u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eselect\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e$\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;e.id\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e$\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;e.department_id\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e$\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;e.salary\u0026#34;\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003e$\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;a.avg_salary\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e).\u003c/span\u003e\u003cspan class=\"n\"\u003eas\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;salary_diff\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n      \u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// Output results\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"n\"\u003edfResult\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eshow\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003espark\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003estop\u003c/span\u003e\u003cspan class=\"o\"\u003e()\u003c/span\u003e\n  \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eこのコードを実行する前に MySQL の \u003ca href=\"https://dev.mysql.com/doc/refman/8.0/en/query-log.html\"\u003egeneral query log\u003c/a\u003e を ON にする。\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003emysql\u0026gt; set global general_log = 'ON';\nQuery OK, 0 rows affected (0.02 sec)\n\nmysql\u0026gt; show global variables like 'general_log%';\n+------------------+--------------------------------------+\n| Variable_name    | Value                                |\n+------------------+--------------------------------------+\n| general_log      | ON                                   |\n| general_log_file | /usr/local/var/mysql/MacBook-Pro.log |\n+------------------+--------------------------------------+\n2 rows in set (0.01 sec)\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eこれによって MySQL に対して発行されたクエリがログとして記録されるようになる。\u003c/p\u003e\n\u003cp\u003e直感的に snapshot isolation になっているのであれば MySQL に対する select 文は1回だけ発行されるはずである。\nしかし前述のとおり \u003ccode\u003eRDD\u003c/code\u003e や \u003ccode\u003eDataFrame\u003c/code\u003e の処理は途中の状態を通常保存せず、同じ \u003ccode\u003eRDD\u003c/code\u003e や \u003ccode\u003eDataFrame\u003c/code\u003e を参照していたとしても再計算される。\n上記コードの例だと \u003ccode\u003edfEmployee\u003c/code\u003e が2回参照されている。\u003c/p\u003e\n\u003cp\u003eコードを実行すると general query log には次のように、データ取得のための select 文が2つ記録されていた。\nそれぞれ \u003ccode\u003ejoin()\u003c/code\u003e の左右の table のデータソースを示している。\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e8 Query     SELECT `id`,`salary`,`department_id` FROM test_fout_dsp.employees\n7 Query     SELECT `salary`,`department_id` FROM test_fout_dsp.employees WHERE (`department_id` IS NOT NULL)\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e2つの select 文はそれぞれ別のクエリ、トランザクションとして発行されている。\nしたがって前者の select 文が実行された後、後者の select 文が実行される前に別のトランザクションにより \u003ccode\u003eemployees\u003c/code\u003e が更新されたり挿入・削除されたりすると non-repeatable read や phantom read が発生してしまうのである。\u003c/p\u003e\n\u003cp\u003e今回はデータソースへのアクセスを確認するためにデータソースとして MySQL を使ったが、同じことはファイルや他の DB など別のデータソースで起こりうる。\u003c/p\u003e\n\u003ch2 id=\"回避策\"\u003e回避策\u003c/h2\u003e\n\u003cp\u003eプロダクト運用上、non-repeatable read や phantom read が発生しうる状況というのは多くの場合で厄介である。\n一時的なデータソースの状態に依存して問題が発生するため、バグの原因追求がとても困難だからだ。\n見た目上の分離レベルを強くし、これらを避けるには2つの方法が考えられる。\u003c/p\u003e\n\u003ch3 id=\"immutable-なデータにのみアクセスする\"\u003eimmutable なデータにのみアクセスする\u003c/h3\u003e\n\u003cp\u003e単純な話で non-repeatable read や phantom read が発生するようなデータソースを参照しなければよい。\n例えばユーザの行動ログのような蓄積されていくデータが hour 単位で partitioning されているような場合、基本的に過去の partition に対しては変更や挿入・削除は行われない。\nこのような partition にアクセスする分には前述のような厄介な問題は起こらない。\u003c/p\u003e\n\u003ch3 id=\"cache-する\"\u003ecache する\u003c/h3\u003e\n\u003cp\u003eデータソースから読み取った結果の \u003ccode\u003eDataFrame\u003c/code\u003e に対して \u003ccode\u003ecache()\u003c/code\u003e または \u003ccode\u003epersist()\u003c/code\u003e をするとよい。\u003c/p\u003e\n\n\u003cblockquote\u003e\n  \u003cp\u003eSpark SQL can cache tables using an in-memory columnar format by calling spark.catalog.cacheTable(\u0026#34;tableName\u0026#34;) or dataFrame.cache().\u003c/p\u003e\n  \u003cfooter\u003e\u0026#8212; Apache Spark \u003ccite title=\"Caching Data In Memory\"\u003e\u003ca rel=\"noopener nofollow\" href=\"https://spark.apache.org/docs/latest/sql-performance-tuning.html#caching-data-in-memory\"\u003eCaching Data In Memory\u003c/a\u003e\u003c/cite\u003e\u003c/footer\u003e\n\u003c/blockquote\u003e\n\n\u003cp\u003e前述のコードで \u003ccode\u003edfEmployee\u003c/code\u003e に対して \u003ccode\u003e.cache()\u003c/code\u003e をした場合、MySQL へのデータ取得のための select 文の発行は1回になった。\n大きなデータソースを \u003ccode\u003ecache()\u003c/code\u003e するときだけメモリや HDD 容量に気をつけておきたい。\u003c/p\u003e\n\u003ch1 id=\"まとめ\"\u003eまとめ\u003c/h1\u003e\n\u003cp\u003e\u003ccode\u003eDataFrame\u003c/code\u003e はいわゆる RDBMS を操作しているように見えてしまうところが難しいところだろうか。\n「データ指向アプリケーションデザイン」に至極真っ当なことが書いてあったので、その言葉を借りて締めておく。\u003c/p\u003e\n\n\u003cblockquote\u003e\n  \u003cp\u003e何も考えずにツールを信じて依存するのではなく、並行性の問題にはどういったものがあるのか、そしてそれらを回避するにはどうしたら良いのかを、しっかり理解しなければなりません。そうすれば、信頼性があり、正しく動作するアプリケーションを手の届くツールを使って構築できるようになります。\u003c/p\u003e\n  \u003cfooter\u003e\u0026#8212; Martin Kleppmann \u003ccite title=\"データ指向アプリケーションデザイン\"\u003e\u003ca rel=\"noopener nofollow\" href=\"https://www.oreilly.co.jp/books/9784873118703/\"\u003eデータ指向アプリケーションデザイン\u003c/a\u003e\u003c/cite\u003e\u003c/footer\u003e\n\u003c/blockquote\u003e"
}
</script>

<link rel="preload" as="script" href="/bundle.js?v=1595258565">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://stats.g.doubleclick.net">
<link rel="preconnect" href="https://www.googleadservices.com">
<link rel="preload" as="script" href="https://www.googletagmanager.com/gtag/js?id=UA-73329599-2">
<script src="https://www.googletagmanager.com/gtag/js?id=UA-73329599-2"></script>
<script>
  window.dataLayer=window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js',new Date());
  gtag('config','UA-73329599-2');
</script>

</head>
<body>

  <header id="nav" class="header">
  <div class="ax-l-i max-w-6xl">
    <div class="ax-logo">
      <a class="block" href="/" title="Froglog"><span class="font-semibold text-raven-900">Froglog</span></a>
    </div>
    <div class="ax-user">
      <a class="p-2 w-8 h-8 block text-raven-500 hover:text-gray-800 focus:text-gray-800 focus:outline-none" target="_blank" rel="noopener nofollow" href="https://www.google.com/search?q=site:soonraah.github.io" title="Search">
        <svg class="fill-current" viewBox="0 0 32 32" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M2.67 12.804c0-5.6 4.544-10.134 10.133-10.134s10.134 4.544 10.134 10.134-4.544 10.133-10.134 10.133S2.67 18.393 2.67 12.804zm28.943 16.923l-8.868-8.868c4.287-5.3 3.68-13.012-1.378-17.57S8.564-1.066 3.75 3.75s-5.017 12.558-.46 17.618 12.28 5.665 17.57 1.378l8.868 8.868a1.33 1.33 0 0 0 2.231-.597c.123-.46-.008-.952-.345-1.29h0z"/></svg>

      </a>
      <a class="p-2 block text-base leading-none text-raven-500 hover:text-gray-800 focus:text-gray-800 focus:outline-none" href="/posts/">
        Posts
      </a>
      <a class="p-2 block text-base leading-none text-raven-500 hover:text-gray-800 focus:text-gray-800 focus:outline-none" href="/tags/">
        Tags
      </a>
      <a class="p-2 block text-base leading-none text-raven-500 hover:text-gray-800 focus:text-gray-800 focus:outline-none" href="/about/">
        About
      </a>
    </div>
  </div>

  
</header>

  <main>
<div class="default-single">
  <div class="ax-title ax-l-o">
    <div class="ax-l-i max-w-680">
      <h1 class="post-title font-content-title font-normal leading-tight tracking-default text-40">Spark DataFrame クエリの弱い分離レベル</h1>

      <div class="ax-meta flex items-center mt-5">
        <div class="flex-grow min-w-0">
          <div class="flex items-center">
  <div class="flex-shrink-0">
    <img
    class="w-12 h-12 sm:w-14 sm:h-14 object-cover p-3px rounded-full border border-blue-300"
    src="/image/author/soonraah.png"
    alt="soonraah">
  </div>
  <div class="flex-shrink-0 ml-2 leading-tight font-content-sans">
    <a class="block text-sm text-raven-800 hover:text-raven-900 hover:underline focus:underline" target="_blank" rel="noopener nofollow" title="soonraah" href="https://soonraah.github.io/">soonraah</a>
    <time class="text-sm text-raven-500" datetime="2020-07-19T13:00:00Z">2020-07-19 22:00</time>
  </div>
</div>

        </div>
        <div>
          <div class="flex items-center">
  <a class="flex-shrink-0 block text-raven-800 hover:text-raven-900" target="_blank" rel="noopener nofollow" title="Share on Twitter" href="https://twitter.com/intent/tweet?text=Spark%20DataFrame%20%e3%82%af%e3%82%a8%e3%83%aa%e3%81%ae%e5%bc%b1%e3%81%84%e5%88%86%e9%9b%a2%e3%83%ac%e3%83%99%e3%83%ab%20by%20%40soonraah%20https%3a%2f%2fsoonraah.github.io%2fweak_isolation_level_of_dataframe%2f"><svg class="w-6 h-6 fill-current" viewBox="0 0 32 32" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M32 6.078c-1.2.522-2.458.868-3.78 1.036 1.36-.812 2.398-2.088 2.886-3.626a13.11 13.11 0 0 1-4.16 1.588C25.742 3.794 24.026 3 22.154 3a6.56 6.56 0 0 0-6.556 6.562c0 .52.044 1.02.152 1.496-5.454-.266-10.28-2.88-13.522-6.862-.566.982-.898 2.106-.898 3.316a6.57 6.57 0 0 0 2.914 5.452 6.48 6.48 0 0 1-2.964-.808v.072c0 3.188 2.274 5.836 5.256 6.446-.534.146-1.116.216-1.72.216-.42 0-.844-.024-1.242-.112.85 2.598 3.262 4.508 6.13 4.57a13.18 13.18 0 0 1-8.134 2.798c-.538 0-1.054-.024-1.57-.1C2.906 27.93 6.35 29 10.064 29c12.072 0 18.672-10 18.672-18.668 0-.3-.01-.57-.024-.848C30.014 8.56 31.108 7.406 32 6.078z"/></svg>
</a>
  <a class="ml-3 flex-shrink-0 block text-raven-800 hover:text-raven-900" target="_blank" rel="noopener nofollow" title="Share on Facebook" href="https://www.facebook.com/dialog/share?app_id=&display=page&href=https%3a%2f%2fsoonraah.github.io%2fweak_isolation_level_of_dataframe%2f"><svg class="w-6 h-6 fill-current" viewBox="-7 -3.5 39 39" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M30.234 0H1.765C.8.001 0 .79 0 1.766v28.47C.001 31.2.79 32 1.766 32h15.328V19.625h-4.156V14.78h4.156v-3.564c0-4.134 2.523-6.384 6.21-6.384 1.766 0 3.284.13 3.726.2v4.32h-2.543c-2.006 0-2.394.953-2.394 2.352v3.085h4.797l-.625 4.844h-4.172V32h8.14C31.21 32 32 31.2 32 30.234V1.765C32 .8 31.21 0 30.234 0z"/></svg>
</a>
</div>

        </div>
      </div>
    </div>
  </div><div class="ax-content ax-l-o">
    <div class="ax-l-i max-w-680">
      <article class="cdata">
<p>Spark バッチ処理の問題を調べていたら分離レベルという概念にたどりついた。
分離レベルについて調べたので、Spark の問題の内容と絡めて記しておく。
考えてみれば当たり前でたいした話ではない。</p>
<h1 id="分離レベルとは">分離レベルとは</h1>
<h2 id="トランザクションの挙動についての暗黙の理解">トランザクションの挙動についての暗黙の理解</h2>
<p>アドホックな分析クエリやプロダクションコード中のクエリを書くとき、その単一のクエリのトランザクションにおいて「同時に実行されている別のクエリの commit 前の状態や commit 結果に影響され、このクエリの結果がおかしくなるかもしれない」ということは通常考えない。
トランザクションはデータベースのある時点の状態に対して正しく処理される、というほぼ無意識の理解をおそらくほとんどの開発者が持っている。</p>
<p>多くの場合この理解は間違っていない。
それはなぜかというと DB 等のデータ処理フレームワークがある強さの分離レベルを提供しているからである。</p>
<h2 id="いろいろな分離レベル">いろいろな分離レベル</h2>
<p>ACID 特性のうちの1つ、分離性 (Isolation) の程度を表すのが分離レベル。</p>

<blockquote>
  <p>トランザクション中に行われる操作の過程が他の操作から隠蔽されることを指し、日本語では分離性、独立性または隔離性ともいう。より形式的には、独立性とはトランザクション履歴が直列化されていることと言える。この性質と性能はトレードオフの関係にあるため、一般的にはこの性質の一部を緩和して実装される場合が多い。</p>
  <footer>&#8212; Wikipedia <cite title="ACID (コンピュータ科学)"><a rel="noopener nofollow" href="https://ja.wikipedia.org/wiki/ACID_%28%E3%82%B3%E3%83%B3%E3%83%94%E3%83%A5%E3%83%BC%E3%82%BF%E7%A7%91%E5%AD%A6%29">ACID (コンピュータ科学)</a></cite></footer>
</blockquote>

<p>分離レベルには名前のついたものがいくつかあり、分離性の保証の強さが異なる。
具体的にはトランザクションの並行性の問題への対応力が異なる。
名著「<a href="https://www.oreilly.co.jp/books/9784873118703/">データ指向アプリケーションデザイン</a>」の第7章で分離レベルについて詳しく述べられているので、以下ではそちらからの引用。
分離レベルを弱い順に並べる。</p>
<ul>
<li>
<p>read uncommitted</p>
<blockquote>
<p>このレベルではダーティライトは生じませんが、ダーティリードは妨げられません。</p>
</blockquote>
</li>
<li>
<p>read committed</p>
<blockquote>
<ol>
<li>データベースからの読み取りを行った際に見えるデータは、コミットされたもののみであること（ダーティリードは生じない）。</li>
<li>データベースへの書き込みを行う場合、上書きするのはコミットされたデータのみであること（ダーティライトは生じない）。</li>
</ol>
</blockquote>
</li>
<li>
<p>snapshot isolation</p>
<blockquote>
<p>スナップショット分離の考え方は、それぞれのトランザクションがデータベースの一貫性のあるスナップショットから読み取りを行うというものです。すなわち、トランザクションが読み取るデータは、すべてそのトランザクションの開始時点のデータベースにコミット済みのものだけということです。</p>
</blockquote>
</li>
<li>
<p>serializability</p>
<blockquote>
<p>この分離レベルはトランザクションが並行して実行されていても、最終的な答えはそれぞれが1つずつ順番に、並行ではなく実行された場合と同じになることを保証します。</p>
</blockquote>
</li>
</ul>
<p>日本語で「分離レベル」を検索すると snapshot isolation の代わりに repeatable read が出てくる事が多い。
しかし repeatable read の名前は実装によって意味が違っていたりして扱いが難しいらしい。</p>
<h2 id="分離レベルと-race-condition-の関係">分離レベルと race condition の関係</h2>
<p>以下に各分離レベルとトランザクションの並行性の問題 (race condition) の関係を示す。
各 race condition の説明については割愛するが、複数のトランザクションが並行して実行されることにより起こりうる期待されていない挙動だと思えばよい。
○はその分離レベルにおいてその race condition が発生しないことを示す。
△は条件によっては発生する。</p>
<table>
<thead>
<tr>
<th></th>
<th>dirty read</th>
<th>dirty write</th>
<th>read skew (nonrepeatable read)</th>
<th>lost update</th>
<th>write skew</th>
<th>phantom read</th>
</tr>
</thead>
<tbody>
<tr>
<td>read uncommitted</td>
<td>○</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>read committed</td>
<td>○</td>
<td>○</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>snapshot isolation</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>△</td>
<td>-</td>
<td>△</td>
</tr>
<tr>
<td>serializability</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
</tr>
</tbody>
</table>
<p>下に行くほど強い分離レベルとなっている。
分離レベルが強くなるほど race condition が発生しにくくなるが、一方で lock 等によりパフォーマンスが下がっていくというトレードオフがある。</p>
<h1 id="各種データベースの分離レベル">各種データベースの分離レベル</h1>
<p>ここでは MySQL と Hive においてどの分離レベルが提供されているかを見てみる。</p>
<h2 id="mysql-の場合">MySQL の場合</h2>
<p>MySQL の分離レベルについては以下のドキュメントで述べられている。</p>
<ul>
<li><a href="https://dev.mysql.com/doc/refman/8.0/en/innodb-transaction-isolation-levels.html">15.7.2.1 Transaction Isolation Levels</a></li>
</ul>
<p>MySQL (というか InnoDB?) では次の4つの分離レベルを設定することができる。</p>
<ul>
<li><code>READ UNCOMMITTED</code></li>
<li><code>READ COMMITTED</code></li>
<li><code>REPEATABLE READ</code> (default)</li>
<li><code>SERIALIZABLE</code></li>
</ul>
<p>デフォルトの分離レベルは <code>REPEATABLE READ</code> だが、これは前述の snapshot isolation に相当するらしい。
分離レベルは、例えば <code>set transaction</code> 構文により次のようにして指定できる。</p>
<div class="highlight"><pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="kt">set</span> <span class="n">transaction</span> <span class="n">isolation</span> <span class="n">level</span> <span class="n">SERIALIZABLE</span><span class="p">;</span>
</code></pre></div><p>この場合は現在のセッション内で実行される次のトランザクションについて適用される。
すべてのセッションやすべてのトランザクション等の指定もできる。
詳しくは以下。</p>
<ul>
<li><a href="https://dev.mysql.com/doc/refman/8.0/en/set-transaction.html">13.3.7 SET TRANSACTION Statement</a></li>
</ul>
<h2 id="hive-の場合">Hive の場合</h2>
<p>Hive についてはドキュメントに次のような記載がある。</p>

<blockquote>
  <p>At this time only snapshot level isolation is supported.  When a given query starts it will be provided with a consistent snapshot of the data.</p>
  <footer>&#8212; Apache Hive <cite title="Hive Transactions"><a rel="noopener nofollow" href="https://cwiki.apache.org/confluence/display/Hive/Hive&#43;Transactions#HiveTransactions-Limitations">Hive Transactions</a></cite></footer>
</blockquote>

<p>Hive は snapshot isolation のみ提供しているとのこと。</p>

<blockquote>
  <p>The default DummyTxnManager emulates behavior of old Hive versions: has no transactions and uses hive.lock.manager property to create lock manager for tables, partitions and databases.</p>
  <footer>&#8212; Apache Hive <cite title="Hive Transactions"><a rel="noopener nofollow" href="https://cwiki.apache.org/confluence/display/Hive/Hive&#43;Transactions#HiveTransactions-Transaction/LockManager">Hive Transactions</a></cite></footer>
</blockquote>

<p>lock は小さくとも partition の単位になるのだろうか。
であるとすると予想通りだが MySQL よりもいかつい挙動になっている。</p>
<p>このように多くの DB では snapshot isolation の分離レベルが基本となっている。</p>
<h1 id="spark-クエリの分離レベル">Spark クエリの分離レベル</h1>
<p>では Spark のクエリはどうだろうか。
ここからようやく本題となる。</p>
<h2 id="read-committed-相当">read committed 相当</h2>
<p>Spark において <code>DataFrame</code> を用いたデータ処理を記述するとき、それは1つの SQL クエリを書くのと近い感覚になる。
そもそも <code>DataFrame</code> は SQL-like な使い心地を目的として作られた API だから当然だ。</p>
<p><code>DataFrame</code> で記述された処理は実行時に <code>RDD</code> として翻訳されるが、分離レベルを考えるにあたって <code>RDD</code> の特性がキーとなってくる。</p>

<blockquote>
  <p>By default, each transformed RDD may be recomputed each time you run an action on it.</p>
  <footer>&#8212; Apache Spark <cite title="RDD Operations"><a rel="noopener nofollow" href="https://spark.apache.org/docs/3.0.0/rdd-programming-guide.html#rdd-operations">RDD Operations</a></cite></footer>
</blockquote>

<p>あまり良い説明を見つけられなかったが、1回の action を伴う処理においても同じ <code>RDD</code> が複数回参照されるとき、その <code>RDD</code> までの計算は通常やり直されることになる。</p>
<p>したがって例えば self join のようなことをするとき、同じデータソースを2回読みに行くということが起こってしまう。
HDFS や S3 上のファイル、JDBC 経由の外部 DB など Spark は様々なデータソースを扱うことができるが、通常 Spark がその2回の読み込みに対して lock をかけたりすることはできない。</p>
<p>つまり non-repeatable read や phantom read を防ぐことができない。
read committed という弱い分離レベルに相当するということになってしまう。</p>
<p>分離レベルという言葉はトランザクションという概念に対して使われるものであり、<code>DataFrame</code> のクエリをトランザクションと呼んでいいのかはわからない。
なので分離レベルという言葉をここで使うのが適切でないかもしれないということは述べておく。</p>
<h2 id="検証">検証</h2>
<p>MySQL からデータを読み取り Spark で処理することを考える。
まず local の MySQL で次のような table を用意する。</p>
<pre><code>mysql&gt; describe employees;
+---------------+---------+------+-----+---------+-------+
| Field         | Type    | Null | Key | Default | Extra |
+---------------+---------+------+-----+---------+-------+
| id            | int(11) | NO   | PRI | NULL    |       |
| salary        | int(11) | YES  |     | NULL    |       |
| department_id | int(11) | YES  |     | NULL    |       |
+---------------+---------+------+-----+---------+-------+
3 rows in set (0.03 sec)
</code></pre><p>部署 (department) ごとの給料 (salary) の平均から各従業員の給料がどれくらい離れているかの差分を見たいものとする。
Spark のコードは次のようになる。
Spark のバージョンはこれを書いている時点での最新 3.0.0 とした。</p>
<div class="highlight"><pre class="chroma"><code class="language-scala" data-lang="scala"><span class="k">package</span> <span class="nn">com.example</span>

<span class="k">import</span> <span class="nn">org.apache.spark.sql.functions.avg</span>
<span class="k">import</span> <span class="nn">org.apache.spark.sql.SparkSession</span>

<span class="k">object</span> <span class="nc">IsolationLevelExperiment</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">main</span><span class="o">(</span><span class="n">args</span><span class="k">:</span> <span class="kt">Array</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
    <span class="c1">// Prepare SparkSession
</span><span class="c1"></span>    <span class="k">val</span> <span class="n">spark</span> <span class="k">=</span> <span class="nc">SparkSession</span>
      <span class="o">.</span><span class="n">builder</span><span class="o">()</span>
      <span class="o">.</span><span class="n">appName</span><span class="o">(</span><span class="s">&#34;Isolation Level Experiment&#34;</span><span class="o">)</span>
      <span class="o">.</span><span class="n">master</span><span class="o">(</span><span class="s">&#34;local[*]&#34;</span><span class="o">)</span>
      <span class="o">.</span><span class="n">getOrCreate</span><span class="o">()</span>

    <span class="k">import</span> <span class="nn">spark.implicits._</span>

    <span class="c1">// Read from MySQL
</span><span class="c1"></span>    <span class="k">val</span> <span class="n">dfEmployee</span> <span class="k">=</span> <span class="n">spark</span>
      <span class="o">.</span><span class="n">read</span>
      <span class="o">.</span><span class="n">format</span><span class="o">(</span><span class="s">&#34;jdbc&#34;</span><span class="o">)</span>
      <span class="o">.</span><span class="n">option</span><span class="o">(</span><span class="s">&#34;url&#34;</span><span class="o">,</span> <span class="s">&#34;jdbc:mysql://localhost&#34;</span><span class="o">)</span>
      <span class="o">.</span><span class="n">option</span><span class="o">(</span><span class="s">&#34;dbtable&#34;</span><span class="o">,</span> <span class="s">&#34;db_name.employees&#34;</span><span class="o">)</span>
      <span class="o">.</span><span class="n">option</span><span class="o">(</span><span class="s">&#34;user&#34;</span><span class="o">,</span> <span class="s">&#34;user_name&#34;</span><span class="o">)</span>
      <span class="o">.</span><span class="n">option</span><span class="o">(</span><span class="s">&#34;password&#34;</span><span class="o">,</span> <span class="s">&#34;********&#34;</span><span class="o">)</span>
      <span class="o">.</span><span class="n">option</span><span class="o">(</span><span class="s">&#34;driver&#34;</span><span class="o">,</span> <span class="s">&#34;com.mysql.cj.jdbc.Driver&#34;</span><span class="o">)</span>
      <span class="o">.</span><span class="n">load</span>
      <span class="o">.</span><span class="n">cache</span>

    <span class="c1">// Get average salary
</span><span class="c1"></span>    <span class="k">val</span> <span class="n">dfAvg</span> <span class="k">=</span> <span class="n">dfEmployee</span>
      <span class="o">.</span><span class="n">groupBy</span><span class="o">(</span><span class="n">$</span><span class="s">&#34;department_id&#34;</span><span class="o">)</span>
      <span class="o">.</span><span class="n">agg</span><span class="o">(</span><span class="n">avg</span><span class="o">(</span><span class="n">$</span><span class="s">&#34;salary&#34;</span><span class="o">).</span><span class="n">as</span><span class="o">(</span><span class="s">&#34;avg_salary&#34;</span><span class="o">))</span>

    <span class="c1">// Calculate diff
</span><span class="c1"></span>    <span class="k">val</span> <span class="n">dfResult</span> <span class="k">=</span> <span class="n">dfEmployee</span>
      <span class="o">.</span><span class="n">as</span><span class="o">(</span><span class="s">&#34;e&#34;</span><span class="o">)</span>
      <span class="o">.</span><span class="n">join</span><span class="o">(</span>
        <span class="n">dfAvg</span><span class="o">.</span><span class="n">as</span><span class="o">(</span><span class="s">&#34;a&#34;</span><span class="o">),</span>
        <span class="n">$</span><span class="s">&#34;e.department_id&#34;</span> <span class="o">===</span> <span class="n">$</span><span class="s">&#34;a.department_id&#34;</span><span class="o">,</span>
        <span class="s">&#34;left_outer&#34;</span>
      <span class="o">)</span>
      <span class="o">.</span><span class="n">select</span><span class="o">(</span>
        <span class="n">$</span><span class="s">&#34;e.id&#34;</span><span class="o">,</span>
        <span class="n">$</span><span class="s">&#34;e.department_id&#34;</span><span class="o">,</span>
        <span class="o">(</span><span class="n">$</span><span class="s">&#34;e.salary&#34;</span> <span class="o">-</span> <span class="n">$</span><span class="s">&#34;a.avg_salary&#34;</span><span class="o">).</span><span class="n">as</span><span class="o">(</span><span class="s">&#34;salary_diff&#34;</span><span class="o">)</span>
      <span class="o">)</span>

    <span class="c1">// Output results
</span><span class="c1"></span>    <span class="n">dfResult</span><span class="o">.</span><span class="n">show</span>

    <span class="n">spark</span><span class="o">.</span><span class="n">stop</span><span class="o">()</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p>このコードを実行する前に MySQL の <a href="https://dev.mysql.com/doc/refman/8.0/en/query-log.html">general query log</a> を ON にする。</p>
<pre><code>mysql&gt; set global general_log = 'ON';
Query OK, 0 rows affected (0.02 sec)

mysql&gt; show global variables like 'general_log%';
+------------------+--------------------------------------+
| Variable_name    | Value                                |
+------------------+--------------------------------------+
| general_log      | ON                                   |
| general_log_file | /usr/local/var/mysql/MacBook-Pro.log |
+------------------+--------------------------------------+
2 rows in set (0.01 sec)
</code></pre><p>これによって MySQL に対して発行されたクエリがログとして記録されるようになる。</p>
<p>直感的に snapshot isolation になっているのであれば MySQL に対する select 文は1回だけ発行されるはずである。
しかし前述のとおり <code>RDD</code> や <code>DataFrame</code> の処理は途中の状態を通常保存せず、同じ <code>RDD</code> や <code>DataFrame</code> を参照していたとしても再計算される。
上記コードの例だと <code>dfEmployee</code> が2回参照されている。</p>
<p>コードを実行すると general query log には次のように、データ取得のための select 文が2つ記録されていた。
それぞれ <code>join()</code> の左右の table のデータソースを示している。</p>
<pre><code>8 Query     SELECT `id`,`salary`,`department_id` FROM test_fout_dsp.employees
7 Query     SELECT `salary`,`department_id` FROM test_fout_dsp.employees WHERE (`department_id` IS NOT NULL)
</code></pre><p>2つの select 文はそれぞれ別のクエリ、トランザクションとして発行されている。
したがって前者の select 文が実行された後、後者の select 文が実行される前に別のトランザクションにより <code>employees</code> が更新されたり挿入・削除されたりすると non-repeatable read や phantom read が発生してしまうのである。</p>
<p>今回はデータソースへのアクセスを確認するためにデータソースとして MySQL を使ったが、同じことはファイルや他の DB など別のデータソースで起こりうる。</p>
<h2 id="回避策">回避策</h2>
<p>プロダクト運用上、non-repeatable read や phantom read が発生しうる状況というのは多くの場合で厄介である。
一時的なデータソースの状態に依存して問題が発生するため、バグの原因追求がとても困難だからだ。
見た目上の分離レベルを強くし、これらを避けるには2つの方法が考えられる。</p>
<h3 id="immutable-なデータにのみアクセスする">immutable なデータにのみアクセスする</h3>
<p>単純な話で non-repeatable read や phantom read が発生するようなデータソースを参照しなければよい。
例えばユーザの行動ログのような蓄積されていくデータが hour 単位で partitioning されているような場合、基本的に過去の partition に対しては変更や挿入・削除は行われない。
このような partition にアクセスする分には前述のような厄介な問題は起こらない。</p>
<h3 id="cache-する">cache する</h3>
<p>データソースから読み取った結果の <code>DataFrame</code> に対して <code>cache()</code> または <code>persist()</code> をするとよい。</p>

<blockquote>
  <p>Spark SQL can cache tables using an in-memory columnar format by calling spark.catalog.cacheTable(&#34;tableName&#34;) or dataFrame.cache().</p>
  <footer>&#8212; Apache Spark <cite title="Caching Data In Memory"><a rel="noopener nofollow" href="https://spark.apache.org/docs/latest/sql-performance-tuning.html#caching-data-in-memory">Caching Data In Memory</a></cite></footer>
</blockquote>

<p>前述のコードで <code>dfEmployee</code> に対して <code>.cache()</code> をした場合、MySQL へのデータ取得のための select 文の発行は1回になった。
大きなデータソースを <code>cache()</code> するときだけメモリや HDD 容量に気をつけておきたい。</p>
<h1 id="まとめ">まとめ</h1>
<p><code>DataFrame</code> はいわゆる RDBMS を操作しているように見えてしまうところが難しいところだろうか。
「データ指向アプリケーションデザイン」に至極真っ当なことが書いてあったので、その言葉を借りて締めておく。</p>

<blockquote>
  <p>何も考えずにツールを信じて依存するのではなく、並行性の問題にはどういったものがあるのか、そしてそれらを回避するにはどうしたら良いのかを、しっかり理解しなければなりません。そうすれば、信頼性があり、正しく動作するアプリケーションを手の届くツールを使って構築できるようになります。</p>
  <footer>&#8212; Martin Kleppmann <cite title="データ指向アプリケーションデザイン"><a rel="noopener nofollow" href="https://www.oreilly.co.jp/books/9784873118703/">データ指向アプリケーションデザイン</a></cite></footer>
</blockquote>


      </article>
      

      

    </div>
  </div>
</div>

  </main>
  <footer class="footer">
  <div class="ax-l-i max-w-6xl">
    <nav class="flex items-center justify-center">
      <a class="ml-3 first:ml-0 text-sm text-gray-600 hover:text-gray-800" href="/posts/">Posts</a>
      <a class="ml-3 first:ml-0 text-sm text-gray-600 hover:text-gray-800" href="/tags/">Tags</a>
      <a class="ml-3 first:ml-0 text-sm text-gray-600 hover:text-gray-800" href="/about/">About</a>
    </nav>
    <div class="footer-social flex items-center justify-center mt-4">
      <a class="block mx-3 w-6 h-6 text-raven-700 hover:text-raven-900" target="_blank" rel="noopener nofollow" title="Twitter" href="https://twitter.com/soonraah"><svg class="fill-current" viewBox="0 0 32 32" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M32 6.078c-1.2.522-2.458.868-3.78 1.036 1.36-.812 2.398-2.088 2.886-3.626a13.11 13.11 0 0 1-4.16 1.588C25.742 3.794 24.026 3 22.154 3a6.56 6.56 0 0 0-6.556 6.562c0 .52.044 1.02.152 1.496-5.454-.266-10.28-2.88-13.522-6.862-.566.982-.898 2.106-.898 3.316a6.57 6.57 0 0 0 2.914 5.452 6.48 6.48 0 0 1-2.964-.808v.072c0 3.188 2.274 5.836 5.256 6.446-.534.146-1.116.216-1.72.216-.42 0-.844-.024-1.242-.112.85 2.598 3.262 4.508 6.13 4.57a13.18 13.18 0 0 1-8.134 2.798c-.538 0-1.054-.024-1.57-.1C2.906 27.93 6.35 29 10.064 29c12.072 0 18.672-10 18.672-18.668 0-.3-.01-.57-.024-.848C30.014 8.56 31.108 7.406 32 6.078z"/></svg></a>
      <a class="block mx-3 w-6 h-6 text-raven-700 hover:text-raven-900" target="_blank" rel="noopener nofollow" title="Github" href="https://github.com/soonraah"><svg class="fill-current" viewBox="0 0 32 32" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M15.998 0C7.164 0 0 7.35 0 16.417 0 23.67 4.584 29.82 10.944 31.994c.8.15 1.092-.356 1.092-.79l-.022-2.792c-4.45.99-5.4-2.202-5.4-2.202-.726-1.896-1.776-2.4-1.776-2.4-1.454-1.018.108-.998.108-.998 1.606.117 2.45 1.693 2.45 1.693 1.428 2.507 3.746 1.784 4.658 1.363.144-1.06.558-1.784 1.016-2.195-3.552-.415-7.288-1.823-7.288-8.113 0-1.792.624-3.258 1.648-4.406-.166-.415-.714-2.085.156-4.344 0 0 1.344-.44 4.4 1.683 1.276-.364 2.644-.546 4.006-.552a14.98 14.98 0 0 1 4.006.554C23.062 6.37 24.404 6.8 24.404 6.8c.872 2.26.324 3.93.16 4.344 1.026 1.148 1.644 2.614 1.644 4.406 0 6.306-3.74 7.694-7.304 8.1.574.507 1.086 1.51 1.086 3.04l-.02 4.503c0 .44.288.95 1.1.788C27.42 29.817 32 23.667 32 16.417 32 7.35 24.836 0 15.998 0z"/></svg></a>
    </div>

    <div class="footer-copyright text-sm text-center text-gray-500 mt-4">
      &#169; 2020-2020 Froglog
    </div>
    <div class="text-sm sm:text-xs text-center text-gray-500 mt-2">
      Powered by <a href="https://www.axiomtheme.com/?utm_source=theme-footer&utm_medium=website&utm_campaign=referral">Axiom</a>
    </div>
  </div>
</footer>

<script src="/bundle.js?v=1595258565"></script>


</body>
</html>
