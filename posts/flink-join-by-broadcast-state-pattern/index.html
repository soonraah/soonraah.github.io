<!doctype html><html lang=ja dir=auto><head><script async src="https://www.googletagmanager.com/gtag/js?id=G-NSEGH2YT17"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-NSEGH2YT17")</script><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Apache Flink の Broadcast State Pattern を用いた stream data と static data の join | Froglog</title>
<meta name=keywords content="Apache Flink,stream processing"><meta name=description content="star schema における fact table と dimension table の join のようなことを Apache Flink におけるストリーム処理で行いたい。
stream data と static data の join ということになる。
ただし dimension table 側も更新されるため、完全な static というわけではない。
このポストでは Flink v1.11 を前提とした。
join の方法 今回は DataStream API でこれを実現することを考える。
Flink のドキュメントを読むと broadcast state pattern でできそうだ。
The Broadcast State Pattern やり方としては次のようになる。
static data のファイルを FileProcessingMode.PROCESS_CONTINUOUSLY で読み込み DataStream 化 1 を broadcast() stream data の DataStream と 2 を connect() static data を PROCESS_CONTINUOUSLY で読むのは変更を得るため。"><meta name=author content="soonraah"><link rel=canonical href=https://soonraah.github.io/posts/flink-join-by-broadcast-state-pattern/><meta name=google-site-verification content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.5cfc680b1eeaeef9efbced92d46c2a9e876b72ee14fba85846afc4cff9e6e6f8.css integrity="sha256-XPxoCx7q7vnvvO2S1Gwqnodrcu4U+6hYRq/Ez/nm5vg=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://soonraah.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://soonraah.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://soonraah.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://soonraah.github.io/apple-touch-icon.png><link rel=mask-icon href=https://soonraah.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-73329599-2","auto"),ga("send","pageview"))</script><meta property="og:title" content="Apache Flink の Broadcast State Pattern を用いた stream data と static data の join"><meta property="og:description" content="star schema における fact table と dimension table の join のようなことを Apache Flink におけるストリーム処理で行いたい。
stream data と static data の join ということになる。
ただし dimension table 側も更新されるため、完全な static というわけではない。
このポストでは Flink v1.11 を前提とした。
join の方法 今回は DataStream API でこれを実現することを考える。
Flink のドキュメントを読むと broadcast state pattern でできそうだ。
The Broadcast State Pattern やり方としては次のようになる。
static data のファイルを FileProcessingMode.PROCESS_CONTINUOUSLY で読み込み DataStream 化 1 を broadcast() stream data の DataStream と 2 を connect() static data を PROCESS_CONTINUOUSLY で読むのは変更を得るため。"><meta property="og:type" content="article"><meta property="og:url" content="https://soonraah.github.io/posts/flink-join-by-broadcast-state-pattern/"><meta property="og:image" content="https://soonraah.github.io/image/logo/flink_squirrel_color_logo.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-08-06T22:00:00+09:00"><meta property="article:modified_time" content="2020-08-06T22:00:00+09:00"><meta property="og:site_name" content="Froglog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://soonraah.github.io/image/logo/flink_squirrel_color_logo.png"><meta name=twitter:title content="Apache Flink の Broadcast State Pattern を用いた stream data と static data の join"><meta name=twitter:description content="star schema における fact table と dimension table の join のようなことを Apache Flink におけるストリーム処理で行いたい。
stream data と static data の join ということになる。
ただし dimension table 側も更新されるため、完全な static というわけではない。
このポストでは Flink v1.11 を前提とした。
join の方法 今回は DataStream API でこれを実現することを考える。
Flink のドキュメントを読むと broadcast state pattern でできそうだ。
The Broadcast State Pattern やり方としては次のようになる。
static data のファイルを FileProcessingMode.PROCESS_CONTINUOUSLY で読み込み DataStream 化 1 を broadcast() stream data の DataStream と 2 を connect() static data を PROCESS_CONTINUOUSLY で読むのは変更を得るため。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://soonraah.github.io/posts/"},{"@type":"ListItem","position":3,"name":"Apache Flink の Broadcast State Pattern を用いた stream data と static data の join","item":"https://soonraah.github.io/posts/flink-join-by-broadcast-state-pattern/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Apache Flink の Broadcast State Pattern を用いた stream data と static data の join","name":"Apache Flink の Broadcast State Pattern を用いた stream data と static data の join","description":"star schema における fact table と dimension table の join のようなことを Apache Flink におけるストリーム処理で行いたい。\nstream data と static data の join ということになる。\nただし dimension table 側も更新されるため、完全な static というわけではない。\nこのポストでは Flink v1.11 を前提とした。\njoin の方法 今回は DataStream API でこれを実現することを考える。\nFlink のドキュメントを読むと broadcast state pattern でできそうだ。\nThe Broadcast State Pattern やり方としては次のようになる。\nstatic data のファイルを FileProcessingMode.PROCESS_CONTINUOUSLY で読み込み DataStream 化 1 を broadcast() stream data の DataStream と 2 を connect() static data を PROCESS_CONTINUOUSLY で読むのは変更を得るため。","keywords":["Apache Flink","stream processing"],"articleBody":"star schema における fact table と dimension table の join のようなことを Apache Flink におけるストリーム処理で行いたい。\nstream data と static data の join ということになる。\nただし dimension table 側も更新されるため、完全な static というわけではない。\nこのポストでは Flink v1.11 を前提とした。\njoin の方法 今回は DataStream API でこれを実現することを考える。\nFlink のドキュメントを読むと broadcast state pattern でできそうだ。\nThe Broadcast State Pattern やり方としては次のようになる。\nstatic data のファイルを FileProcessingMode.PROCESS_CONTINUOUSLY で読み込み DataStream 化 1 を broadcast() stream data の DataStream と 2 を connect() static data を PROCESS_CONTINUOUSLY で読むのは変更を得るため。\nPROCESS_ONCE で読んでしまうとストリーム処理の開始時に1回読むだけになり、dimension table の変更を得られない。\nこのあたりの仕様については Data Sources を参照。\nその後は broadcast state pattern にそのまま従う。\nしたがって BroadcastProcessFunction or KeyedBroadcastProcessFunction を実装する必要がある。\nその中で static data を取り込んで state として持ち、stream data 側で参照すればよい。\n2つのデータの各 term に対する関係性を以下に示す。\nin star schema stream or static broadcast or not dimension table static data broadcasted fact table stream data non-broadcasted 実験 実験概要 stream data として株価のデータを考える。\n適当に乱数で作った株価が “GOOGL” 等の ticker とともに流れてくる。\n一方、会社情報が記載された dimension table 的なファイルも用意する。\n流れ続ける株価データに対して ticker を key にして会社情報を紐付ける、ということを行う。\nコード 上記を実行するためのコードを以下に示す。\n実行可能なプロジェクトを GitHub に置いたので興味があればどうぞ。\nEntry Point main() の実装。\nMiniClusterWithClientResource は本来は単体テスト用だが、簡単に local で cluster を動かすためにここで使用している。\npackage example import org.apache.flink.api.common.state.MapStateDescriptor import org.apache.flink.api.java.io.TextInputFormat import org.apache.flink.core.fs.Path import org.apache.flink.runtime.testutils.MiniClusterResourceConfiguration import org.apache.flink.streaming.api.functions.source.FileProcessingMode import org.apache.flink.streaming.api.scala.{DataStream, StreamExecutionEnvironment, createTypeInformation} import org.apache.flink.test.util.MiniClusterWithClientResource object FlinkJoinTest { // See https://ci.apache.org/projects/flink/flink-docs-release-1.11/dev/stream/testing.html#testing-flink-jobs private val FlinkCluster = new MiniClusterWithClientResource( new MiniClusterResourceConfiguration .Builder() .setNumberSlotsPerTaskManager(2) .setNumberTaskManagers(1) .build ) def main(args: Array[String]): Unit = { FlinkCluster.before() val env = StreamExecutionEnvironment.getExecutionEnvironment env.setParallelism(2) val companiesMasterFilePath = \"data/companies.csv\" val companies = readCompaniesMaster(companiesMasterFilePath, env) .broadcast(new MapStateDescriptor( \"CompanyState\", classOf[String], // ticker classOf[String] // name )) // the broadcast state pattern // See https://ci.apache.org/projects/flink/flink-docs-release-1.11/dev/stream/state/broadcast_state.html env .fromCollection(new UnboundedStocks) .connect(companies) .process(new StockBroadcastProcessFunction) .print() env.execute(\"flink join test\") FlinkCluster.after() } private def readCompaniesMaster(companiesMasterFilePath: String, env: StreamExecutionEnvironment): DataStream[Company] = { env .readFile( new TextInputFormat(new Path(companiesMasterFilePath)), companiesMasterFilePath, FileProcessingMode.PROCESS_CONTINUOUSLY, 10 * 1000 ) .map { line =\u003e val items = line.split(\",\") Company(items(0), items(1)) } } } Records 各種レコードを表す case class。\nUnboundedStocks は一定のインターバルで Stock を無限に返す iterator であり、stream data 生成に利用する。\ncase class Company(ticker: String, name: String) case class Stock(ticker: String, price: Double) /** * Iterator to generate unbounded stock data */ class UnboundedStocks extends Iterator[Stock] with Serializable { override def hasNext: Boolean = true // unbounded override def next(): Stock = { Thread.sleep(1000) val tickers = Seq(\"GOOGL\", \"AAPL\", \"FB\", \"AMZN\") val ticker = tickers(Random.nextInt(tickers.size)) // one of GAFA val price = 100 + Random.nextDouble() * 300 // random price Stock(ticker, price) } } BroadcastProcessFunction 肝である BroadcastProcessFunction の実装。\npackage example import org.apache.flink.api.common.state.MapStateDescriptor import org.apache.flink.streaming.api.functions.co.BroadcastProcessFunction import org.apache.flink.util.Collector class StockBroadcastProcessFunction extends BroadcastProcessFunction[Stock, Company, (String, String, Double)] { private val StateDescriptor = new MapStateDescriptor( \"CompanyState\", classOf[String], // ticker classOf[String] // name ) override def processElement(value: Stock, ctx: BroadcastProcessFunction[Stock, Company, (String, String, Double)]#ReadOnlyContext, out: Collector[(String, String, Double)]): Unit = { val companyName = ctx.getBroadcastState(StateDescriptor).get(value.ticker) out.collect((value.ticker, Option(companyName).getOrElse(\"-\"), value.price)) } override def processBroadcastElement(value: Company, ctx: BroadcastProcessFunction[Stock, Company, (String, String, Double)]#Context, out: Collector[(String, String, Double)]): Unit = { ctx.getBroadcastState(StateDescriptor).put(value.ticker, value.name) } } 実行結果 上記を実行すると以下のような stream と static が結合された結果レコードが流れ続ける。\n2\u003e (FB,Facebook,158.76057838239333) 1\u003e (GOOGL,Google,288.4271251901199) 2\u003e (AAPL,Apple,191.00515338617706) 1\u003e (FB,Facebook,121.98205452369652) 2\u003e (FB,Facebook,140.05023554456997) この状態で会社情報が記載されている data/companies.csv を更新することを考える。\n例えば “GOOGL” の社名を “Google” から “Alphabet” に変更して保存してみた。\nするとしばらくしてその修正が反映された結果が流れてくるようになる。\n1\u003e (GOOGL,Alphabet,288.1008081843843) 2\u003e (AMZN,Amazon,137.11135563851838) 1\u003e (GOOGL,Alphabet,121.78368168964735) 2\u003e (FB,Facebook,236.53483047124948) 1\u003e (FB,Facebook,220.44300865769645) static data の更新が反映されることが確認できた。\n今回は10秒に1回のインターバルで元ファイルを確認するようにファイルを読んでいるため、変更してからそれが反映されるまで最大10秒程度かかる。\n懸念点 join はできたが次のような懸念点がある。\nレコードの削除に対応していない state を上書きしているだけなので companies.csv から削除されたレコードは感知できない ファイルの更新時に処理が重くなる可能性がある companies.csv の更新タイミングでその中の全レコードを処理してしまう checkpoint が大きくなる state が broadcast されているため、task ごとに重複した state が保存されてしまう See Important Considerations まとめ このように broadcast state pattern によって stream data と static data との join 処理を行うことができた。\nただし、まだちゃんと調べていないが DataStream API ではなく Table API を使えばもう少しカジュアルな感じで近いことができるかもしれない。\n気が向いたらそちらも試してみる。\n追記 Table API を使った場合についての記事を追加しました。\nApache Flink の Temporary Table Function を用いた stream data と static data の join ","wordCount":"545","inLanguage":"ja","image":"https://soonraah.github.io/image/logo/flink_squirrel_color_logo.png","datePublished":"2020-08-06T22:00:00+09:00","dateModified":"2020-08-06T22:00:00+09:00","author":{"@type":"Person","name":"soonraah"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://soonraah.github.io/posts/flink-join-by-broadcast-state-pattern/"},"publisher":{"@type":"Organization","name":"Froglog","logo":{"@type":"ImageObject","url":"https://soonraah.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://soonraah.github.io accesskey=h title="Home (Alt + H)"><img src=https://soonraah.github.io/image/brand/favicon.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://soonraah.github.io/about/ title=About><span>About</span></a></li><li><a href=https://soonraah.github.io/posts/ title=Posts><span>Posts</span></a></li><li><a href=https://soonraah.github.io/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://soonraah.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://soonraah.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://soonraah.github.io>ホーム</a>&nbsp;»&nbsp;<a href=https://soonraah.github.io/posts/>Posts</a></div><h1 class=post-title>Apache Flink の Broadcast State Pattern を用いた stream data と static data の join</h1><div class=post-meta><span title='2020-08-06 22:00:00 +0900 JST'>8月 6, 2020</span>&nbsp;·&nbsp;soonraah</div></header><figure class=entry-cover><img loading=lazy src=https://soonraah.github.io/image/logo/flink_squirrel_color_logo.png alt="Apache Flink"><p><a href=https://flink.apache.org/>Apache Flink</a></p></figure><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>目次</span></summary><div class=inner><ul><li><a href=#join-%e3%81%ae%e6%96%b9%e6%b3%95 aria-label="join の方法">join の方法</a></li><li><a href=#%e5%ae%9f%e9%a8%93 aria-label=実験>実験</a><ul><li><a href=#%e5%ae%9f%e9%a8%93%e6%a6%82%e8%a6%81 aria-label=実験概要>実験概要</a></li><li><a href=#%e3%82%b3%e3%83%bc%e3%83%89 aria-label=コード>コード</a><ul><li><a href=#entry-point aria-label="Entry Point">Entry Point</a></li><li><a href=#records aria-label=Records>Records</a></li><li><a href=#broadcastprocessfunction aria-label=BroadcastProcessFunction>BroadcastProcessFunction</a></li></ul></li><li><a href=#%e5%ae%9f%e8%a1%8c%e7%b5%90%e6%9e%9c aria-label=実行結果>実行結果</a></li></ul></li><li><a href=#%e6%87%b8%e5%bf%b5%e7%82%b9 aria-label=懸念点>懸念点</a></li><li><a href=#%e3%81%be%e3%81%a8%e3%82%81 aria-label=まとめ>まとめ</a><ul><li><a href=#%e8%bf%bd%e8%a8%98 aria-label=追記>追記</a></li></ul></li></ul></div></details></div><div class=post-content><p>star schema における fact table と dimension table の join のようなことを Apache Flink におけるストリーム処理で行いたい。<br>stream data と static data の join ということになる。<br>ただし dimension table 側も更新されるため、完全な static というわけではない。</p><p>このポストでは Flink v1.11 を前提とした。</p><h2 id=join-の方法>join の方法<a hidden class=anchor aria-hidden=true href=#join-の方法>#</a></h2><p>今回は DataStream API でこれを実現することを考える。<br>Flink のドキュメントを読むと broadcast state pattern でできそうだ。</p><ul><li><a href=https://ci.apache.org/projects/flink/flink-docs-release-1.11/dev/stream/state/broadcast_state.html>The Broadcast State Pattern</a></li></ul><p>やり方としては次のようになる。</p><ol><li>static data のファイルを <code>FileProcessingMode.PROCESS_CONTINUOUSLY</code> で読み込み <code>DataStream</code> 化</li><li>1 を <code>broadcast()</code></li><li>stream data の <code>DataStream</code> と 2 を <code>connect()</code></li></ol><p>static data を <code>PROCESS_CONTINUOUSLY</code> で読むのは変更を得るため。<br><code>PROCESS_ONCE</code> で読んでしまうとストリーム処理の開始時に1回読むだけになり、dimension table の変更を得られない。<br>このあたりの仕様については <a href=https://ci.apache.org/projects/flink/flink-docs-release-1.11/dev/datastream_api.html#data-sources>Data Sources</a> を参照。</p><p>その後は broadcast state pattern にそのまま従う。<br>したがって <code>BroadcastProcessFunction</code> or <code>KeyedBroadcastProcessFunction</code> を実装する必要がある。<br>その中で static data を取り込んで state として持ち、stream data 側で参照すればよい。</p><p>2つのデータの各 term に対する関係性を以下に示す。</p><table><thead><tr><th>in star schema</th><th>stream or static</th><th>broadcast or not</th></tr></thead><tbody><tr><td>dimension table</td><td>static data</td><td>broadcasted</td></tr><tr><td>fact table</td><td>stream data</td><td>non-broadcasted</td></tr></tbody></table><h2 id=実験>実験<a hidden class=anchor aria-hidden=true href=#実験>#</a></h2><h3 id=実験概要>実験概要<a hidden class=anchor aria-hidden=true href=#実験概要>#</a></h3><p>stream data として株価のデータを考える。<br>適当に乱数で作った株価が &ldquo;GOOGL&rdquo; 等の ticker とともに流れてくる。<br>一方、会社情報が記載された dimension table 的なファイルも用意する。<br>流れ続ける株価データに対して ticker を key にして会社情報を紐付ける、ということを行う。</p><h3 id=コード>コード<a hidden class=anchor aria-hidden=true href=#コード>#</a></h3><p>上記を実行するためのコードを以下に示す。<br>実行可能なプロジェクトを <a href=https://github.com/soonraah/flink_join_test>GitHub</a> に置いたので興味があればどうぞ。</p><h4 id=entry-point>Entry Point<a hidden class=anchor aria-hidden=true href=#entry-point>#</a></h4><p><code>main()</code> の実装。<br><code>MiniClusterWithClientResource</code> は本来は単体テスト用だが、簡単に local で cluster を動かすためにここで使用している。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>package</span> example
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> org.apache.flink.api.common.state.MapStateDescriptor
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> org.apache.flink.api.java.io.TextInputFormat
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> org.apache.flink.core.fs.Path
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> org.apache.flink.runtime.testutils.MiniClusterResourceConfiguration
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> org.apache.flink.streaming.api.functions.source.FileProcessingMode
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> org.apache.flink.streaming.api.scala.<span style=color:#f92672>{</span><span style=color:#a6e22e>DataStream</span><span style=color:#f92672>,</span> <span style=color:#a6e22e>StreamExecutionEnvironment</span><span style=color:#f92672>,</span> createTypeInformation<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> org.apache.flink.test.util.MiniClusterWithClientResource
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>object</span> <span style=color:#a6e22e>FlinkJoinTest</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// See https://ci.apache.org/projects/flink/flink-docs-release-1.11/dev/stream/testing.html#testing-flink-jobs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>val</span> <span style=color:#a6e22e>FlinkCluster</span> <span style=color:#66d9ef>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>MiniClusterWithClientResource</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>MiniClusterResourceConfiguration</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span><span style=color:#a6e22e>Builder</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>.</span>setNumberSlotsPerTaskManager<span style=color:#f92672>(</span><span style=color:#ae81ff>2</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>.</span>setNumberTaskManagers<span style=color:#f92672>(</span><span style=color:#ae81ff>1</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>.</span>build
</span></span><span style=display:flex><span>  <span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> main<span style=color:#f92672>(</span>args<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Array</span><span style=color:#f92672>[</span><span style=color:#66d9ef>String</span><span style=color:#f92672>])</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Unit</span> <span style=color:#f92672>=</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>FlinkCluster</span><span style=color:#f92672>.</span>before<span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>val</span> env <span style=color:#66d9ef>=</span> <span style=color:#a6e22e>StreamExecutionEnvironment</span><span style=color:#f92672>.</span>getExecutionEnvironment
</span></span><span style=display:flex><span>    env<span style=color:#f92672>.</span>setParallelism<span style=color:#f92672>(</span><span style=color:#ae81ff>2</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>val</span> companiesMasterFilePath <span style=color:#66d9ef>=</span> <span style=color:#e6db74>&#34;data/companies.csv&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>val</span> companies <span style=color:#66d9ef>=</span> readCompaniesMaster<span style=color:#f92672>(</span>companiesMasterFilePath<span style=color:#f92672>,</span> env<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>.</span>broadcast<span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> <span style=color:#a6e22e>MapStateDescriptor</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;CompanyState&#34;</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        classOf<span style=color:#f92672>[</span><span style=color:#66d9ef>String</span><span style=color:#f92672>],</span>    <span style=color:#75715e>// ticker
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        classOf<span style=color:#f92672>[</span><span style=color:#66d9ef>String</span><span style=color:#f92672>]</span>     <span style=color:#75715e>// name
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// the broadcast state pattern
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// See https://ci.apache.org/projects/flink/flink-docs-release-1.11/dev/stream/state/broadcast_state.html
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    env
</span></span><span style=display:flex><span>      <span style=color:#f92672>.</span>fromCollection<span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> <span style=color:#a6e22e>UnboundedStocks</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>.</span>connect<span style=color:#f92672>(</span>companies<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>.</span>process<span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> <span style=color:#a6e22e>StockBroadcastProcessFunction</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>.</span>print<span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    env<span style=color:#f92672>.</span>execute<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;flink join test&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>FlinkCluster</span><span style=color:#f92672>.</span>after<span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>def</span> readCompaniesMaster<span style=color:#f92672>(</span>companiesMasterFilePath<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>String</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                                  env<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>StreamExecutionEnvironment</span><span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>DataStream</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Company</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>=</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    env
</span></span><span style=display:flex><span>      <span style=color:#f92672>.</span>readFile<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>TextInputFormat</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Path</span><span style=color:#f92672>(</span>companiesMasterFilePath<span style=color:#f92672>)),</span>
</span></span><span style=display:flex><span>        companiesMasterFilePath<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>FileProcessingMode</span><span style=color:#f92672>.</span><span style=color:#a6e22e>PROCESS_CONTINUOUSLY</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>10</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1000</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>.</span>map <span style=color:#f92672>{</span> line <span style=color:#66d9ef>=&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>val</span> items <span style=color:#66d9ef>=</span> line<span style=color:#f92672>.</span>split<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;,&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Company</span><span style=color:#f92672>(</span>items<span style=color:#f92672>(</span><span style=color:#ae81ff>0</span><span style=color:#f92672>),</span> items<span style=color:#f92672>(</span><span style=color:#ae81ff>1</span><span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h4 id=records>Records<a hidden class=anchor aria-hidden=true href=#records>#</a></h4><p>各種レコードを表す case class。<br><code>UnboundedStocks</code> は一定のインターバルで <code>Stock</code> を無限に返す iterator であり、stream data 生成に利用する。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>case</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Company</span><span style=color:#f92672>(</span>ticker<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>String</span><span style=color:#f92672>,</span> name<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>String</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>case</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Stock</span><span style=color:#f92672>(</span>ticker<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>String</span><span style=color:#f92672>,</span> price<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Double</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Iterator to generate unbounded stock data
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>UnboundedStocks</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>Iterator</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Stock</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>with</span> <span style=color:#a6e22e>Serializable</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>def</span> hasNext<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Boolean</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>  <span style=color:#75715e>// unbounded
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>def</span> next<span style=color:#f92672>()</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Stock</span> <span style=color:#f92672>=</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Thread</span><span style=color:#f92672>.</span>sleep<span style=color:#f92672>(</span><span style=color:#ae81ff>1000</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>val</span> tickers <span style=color:#66d9ef>=</span> <span style=color:#a6e22e>Seq</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;GOOGL&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;AAPL&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;FB&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;AMZN&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>val</span> ticker <span style=color:#66d9ef>=</span> tickers<span style=color:#f92672>(</span><span style=color:#a6e22e>Random</span><span style=color:#f92672>.</span>nextInt<span style=color:#f92672>(</span>tickers<span style=color:#f92672>.</span>size<span style=color:#f92672>))</span>  <span style=color:#75715e>// one of GAFA
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>val</span> price <span style=color:#66d9ef>=</span> <span style=color:#ae81ff>100</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>Random</span><span style=color:#f92672>.</span>nextDouble<span style=color:#f92672>()</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>300</span>         <span style=color:#75715e>// random price
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>Stock</span><span style=color:#f92672>(</span>ticker<span style=color:#f92672>,</span> price<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h4 id=broadcastprocessfunction>BroadcastProcessFunction<a hidden class=anchor aria-hidden=true href=#broadcastprocessfunction>#</a></h4><p>肝である <code>BroadcastProcessFunction</code> の実装。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>package</span> example
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> org.apache.flink.api.common.state.MapStateDescriptor
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> org.apache.flink.streaming.api.functions.co.BroadcastProcessFunction
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> org.apache.flink.util.Collector
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>StockBroadcastProcessFunction</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>BroadcastProcessFunction</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Stock</span>, <span style=color:#66d9ef>Company</span>, <span style=color:#f92672>(</span><span style=color:#66d9ef>String</span>, <span style=color:#66d9ef>String</span>, <span style=color:#66d9ef>Double</span><span style=color:#f92672>)]</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>val</span> <span style=color:#a6e22e>StateDescriptor</span> <span style=color:#66d9ef>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>MapStateDescriptor</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;CompanyState&#34;</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>    classOf<span style=color:#f92672>[</span><span style=color:#66d9ef>String</span><span style=color:#f92672>],</span>    <span style=color:#75715e>// ticker
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    classOf<span style=color:#f92672>[</span><span style=color:#66d9ef>String</span><span style=color:#f92672>]</span>     <span style=color:#75715e>// name
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>def</span> processElement<span style=color:#f92672>(</span>value<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Stock</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                              ctx<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>BroadcastProcessFunction</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Stock</span>, <span style=color:#66d9ef>Company</span>, <span style=color:#f92672>(</span><span style=color:#66d9ef>String</span>, <span style=color:#66d9ef>String</span>, <span style=color:#66d9ef>Double</span><span style=color:#f92672>)]</span><span style=color:#66d9ef>#</span><span style=color:#a6e22e>ReadOnlyContext</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                              out<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Collector</span><span style=color:#f92672>[(</span><span style=color:#66d9ef>String</span>, <span style=color:#66d9ef>String</span>, <span style=color:#66d9ef>Double</span><span style=color:#f92672>)])</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Unit</span> <span style=color:#f92672>=</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>val</span> companyName <span style=color:#66d9ef>=</span> ctx<span style=color:#f92672>.</span>getBroadcastState<span style=color:#f92672>(</span><span style=color:#a6e22e>StateDescriptor</span><span style=color:#f92672>).</span>get<span style=color:#f92672>(</span>value<span style=color:#f92672>.</span>ticker<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    out<span style=color:#f92672>.</span>collect<span style=color:#f92672>((</span>value<span style=color:#f92672>.</span>ticker<span style=color:#f92672>,</span> <span style=color:#a6e22e>Option</span><span style=color:#f92672>(</span>companyName<span style=color:#f92672>).</span>getOrElse<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;-&#34;</span><span style=color:#f92672>),</span> value<span style=color:#f92672>.</span>price<span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>def</span> processBroadcastElement<span style=color:#f92672>(</span>value<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Company</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                                       ctx<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>BroadcastProcessFunction</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Stock</span>, <span style=color:#66d9ef>Company</span>, <span style=color:#f92672>(</span><span style=color:#66d9ef>String</span>, <span style=color:#66d9ef>String</span>, <span style=color:#66d9ef>Double</span><span style=color:#f92672>)]</span><span style=color:#66d9ef>#</span><span style=color:#a6e22e>Context</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                                       out<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Collector</span><span style=color:#f92672>[(</span><span style=color:#66d9ef>String</span>, <span style=color:#66d9ef>String</span>, <span style=color:#66d9ef>Double</span><span style=color:#f92672>)])</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Unit</span> <span style=color:#f92672>=</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    ctx<span style=color:#f92672>.</span>getBroadcastState<span style=color:#f92672>(</span><span style=color:#a6e22e>StateDescriptor</span><span style=color:#f92672>).</span>put<span style=color:#f92672>(</span>value<span style=color:#f92672>.</span>ticker<span style=color:#f92672>,</span> value<span style=color:#f92672>.</span>name<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=実行結果>実行結果<a hidden class=anchor aria-hidden=true href=#実行結果>#</a></h3><p>上記を実行すると以下のような stream と static が結合された結果レコードが流れ続ける。</p><pre tabindex=0><code>2&gt; (FB,Facebook,158.76057838239333)
1&gt; (GOOGL,Google,288.4271251901199)
2&gt; (AAPL,Apple,191.00515338617706)
1&gt; (FB,Facebook,121.98205452369652)
2&gt; (FB,Facebook,140.05023554456997)
</code></pre><p>この状態で会社情報が記載されている <code>data/companies.csv</code> を更新することを考える。<br>例えば &ldquo;GOOGL&rdquo; の社名を &ldquo;Google&rdquo; から &ldquo;Alphabet&rdquo; に変更して保存してみた。<br>するとしばらくしてその修正が反映された結果が流れてくるようになる。</p><pre tabindex=0><code>1&gt; (GOOGL,Alphabet,288.1008081843843)
2&gt; (AMZN,Amazon,137.11135563851838)
1&gt; (GOOGL,Alphabet,121.78368168964735)
2&gt; (FB,Facebook,236.53483047124948)
1&gt; (FB,Facebook,220.44300865769645)
</code></pre><p>static data の更新が反映されることが確認できた。<br>今回は10秒に1回のインターバルで元ファイルを確認するようにファイルを読んでいるため、変更してからそれが反映されるまで最大10秒程度かかる。</p><h2 id=懸念点>懸念点<a hidden class=anchor aria-hidden=true href=#懸念点>#</a></h2><p>join はできたが次のような懸念点がある。</p><ul><li>レコードの削除に対応していない<ul><li>state を上書きしているだけなので <code>companies.csv</code> から削除されたレコードは感知できない</li></ul></li><li>ファイルの更新時に処理が重くなる可能性がある<ul><li><code>companies.csv</code> の更新タイミングでその中の全レコードを処理してしまう</li></ul></li><li>checkpoint が大きくなる<ul><li>state が broadcast されているため、task ごとに重複した state が保存されてしまう</li><li>See <a href=https://ci.apache.org/projects/flink/flink-docs-release-1.11/dev/stream/state/broadcast_state.html#important-considerations>Important Considerations</a></li></ul></li></ul><h2 id=まとめ>まとめ<a hidden class=anchor aria-hidden=true href=#まとめ>#</a></h2><p>このように broadcast state pattern によって stream data と static data との join 処理を行うことができた。<br>ただし、まだちゃんと調べていないが DataStream API ではなく Table API を使えばもう少しカジュアルな感じで近いことができるかもしれない。<br>気が向いたらそちらも試してみる。</p><h3 id=追記>追記<a hidden class=anchor aria-hidden=true href=#追記>#</a></h3><p>Table API を使った場合についての記事を追加しました。</p><ul><li><a href=https://soonraah.github.io/posts/flink-join-by-temporal-table-function/>Apache Flink の Temporary Table Function を用いた stream data と static data の join</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://soonraah.github.io/tags/apache-flink/>Apache Flink</a></li><li><a href=https://soonraah.github.io/tags/stream-processing/>stream processing</a></li></ul><nav class=paginav><a class=prev href=https://soonraah.github.io/posts/flink-join-by-temporal-table-function/><span class=title>« 前へ</span><br><span>Apache Flink の Temporary Table Function を用いた stream data と static data の join</span>
</a><a class=next href=https://soonraah.github.io/posts/no-more-huge-pull-request/><span class=title>次へ »</span><br><span>あまり大きな Pull Request を作ってほしくない</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Apache Flink の Broadcast State Pattern を用いた stream data と static data の join on x" href="https://x.com/intent/tweet/?text=Apache%20Flink%20%e3%81%ae%20Broadcast%20State%20Pattern%20%e3%82%92%e7%94%a8%e3%81%84%e3%81%9f%20stream%20data%20%e3%81%a8%20static%20data%20%e3%81%ae%20join&amp;url=https%3a%2f%2fsoonraah.github.io%2fposts%2fflink-join-by-broadcast-state-pattern%2f&amp;hashtags=ApacheFlink%2cstreamprocessing"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Apache Flink の Broadcast State Pattern を用いた stream data と static data の join on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fsoonraah.github.io%2fposts%2fflink-join-by-broadcast-state-pattern%2f&amp;title=Apache%20Flink%20%e3%81%ae%20Broadcast%20State%20Pattern%20%e3%82%92%e7%94%a8%e3%81%84%e3%81%9f%20stream%20data%20%e3%81%a8%20static%20data%20%e3%81%ae%20join&amp;summary=Apache%20Flink%20%e3%81%ae%20Broadcast%20State%20Pattern%20%e3%82%92%e7%94%a8%e3%81%84%e3%81%9f%20stream%20data%20%e3%81%a8%20static%20data%20%e3%81%ae%20join&amp;source=https%3a%2f%2fsoonraah.github.io%2fposts%2fflink-join-by-broadcast-state-pattern%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Apache Flink の Broadcast State Pattern を用いた stream data と static data の join on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fsoonraah.github.io%2fposts%2fflink-join-by-broadcast-state-pattern%2f&title=Apache%20Flink%20%e3%81%ae%20Broadcast%20State%20Pattern%20%e3%82%92%e7%94%a8%e3%81%84%e3%81%9f%20stream%20data%20%e3%81%a8%20static%20data%20%e3%81%ae%20join"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Apache Flink の Broadcast State Pattern を用いた stream data と static data の join on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fsoonraah.github.io%2fposts%2fflink-join-by-broadcast-state-pattern%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Apache Flink の Broadcast State Pattern を用いた stream data と static data の join on whatsapp" href="https://api.whatsapp.com/send?text=Apache%20Flink%20%e3%81%ae%20Broadcast%20State%20Pattern%20%e3%82%92%e7%94%a8%e3%81%84%e3%81%9f%20stream%20data%20%e3%81%a8%20static%20data%20%e3%81%ae%20join%20-%20https%3a%2f%2fsoonraah.github.io%2fposts%2fflink-join-by-broadcast-state-pattern%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Apache Flink の Broadcast State Pattern を用いた stream data と static data の join on telegram" href="https://telegram.me/share/url?text=Apache%20Flink%20%e3%81%ae%20Broadcast%20State%20Pattern%20%e3%82%92%e7%94%a8%e3%81%84%e3%81%9f%20stream%20data%20%e3%81%a8%20static%20data%20%e3%81%ae%20join&amp;url=https%3a%2f%2fsoonraah.github.io%2fposts%2fflink-join-by-broadcast-state-pattern%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Apache Flink の Broadcast State Pattern を用いた stream data と static data の join on ycombinator" href="https://news.ycombinator.com/submitlink?t=Apache%20Flink%20%e3%81%ae%20Broadcast%20State%20Pattern%20%e3%82%92%e7%94%a8%e3%81%84%e3%81%9f%20stream%20data%20%e3%81%a8%20static%20data%20%e3%81%ae%20join&u=https%3a%2f%2fsoonraah.github.io%2fposts%2fflink-join-by-broadcast-state-pattern%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://soonraah.github.io>Froglog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="コピー";function s(){t.innerHTML="コピーされました!",setTimeout(()=>{t.innerHTML="コピー"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>