<!doctype html><html lang=ja dir=auto><head><script async src="https://www.googletagmanager.com/gtag/js?id=G-NSEGH2YT17"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-NSEGH2YT17")</script><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Data Contract について調べた | Froglog</title>
<meta name=keywords content="data contract"><meta name=description content="データエンジニアリングの領域で少し前から目にするようになった &ldquo;data contract&rdquo; という言葉。
なんとなく今の業務で困っている課題の解決になりそうな気がしつつもよくわかっていなかったので調べてみた。
data contract について語られているいくつかのブログ記事などを参考にしている。
Data Contract とは データの schema というのはナマモノで、いろいろな理由で変更されることがある。
schema を変更する場合、その schema のデータ (table や log) が所属する単一のビジネス機能や application のドメインで行われることになる。
そのドメインの閉じた世界で考える分にはこれで問題ないのだが、DWH や data lake など組織レベルのデータ基盤でデータを流通していた場合はその先のことも考えないといけなくなる。
このようにチームを超える影響というのは、ビジネス機能に責任を持っているチームからは見えにくくなっていることが多い。
上流の application 側で schema を変更したら下流のデータ基盤の ETL 処理がぶっ壊れてしまった、というのはデータ基盤運用あるあるではないだろうか。
というところを解決して平和に過ごせるようにすることが data contract の主なモチベーションだと思われる。
&ldquo;contract&rdquo; は日本語で言うところの「契約」。
組織におけるデータ流通において、データの送り手である producer 側と受け手である consumer 側との間で合意した契約を遵守することにより、前述のような問題を避けることができるというのが data contract である。
組織内のデータの見通しがよくなったり、パイプラインを宣言的に開発することができるようになるというメリットもある。
エンジニアにとっては Datafold のブログ記事の例を読むとイメージしやすいかもしれない。
To provide another analogy, data contracts are what API is for the web services. Say we want to get data from Twitter."><meta name=author content="soonraah"><link rel=canonical href=https://soonraah.github.io/posts/looked-into-data-contracts/><meta name=google-site-verification content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.5cfc680b1eeaeef9efbced92d46c2a9e876b72ee14fba85846afc4cff9e6e6f8.css integrity="sha256-XPxoCx7q7vnvvO2S1Gwqnodrcu4U+6hYRq/Ez/nm5vg=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://soonraah.github.io/favicon2.ico><link rel=icon type=image/png sizes=16x16 href=https://soonraah.github.io/image/favicon/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://soonraah.github.io/image/favicon/favicon-32x32.png><link rel=apple-touch-icon href=https://soonraah.github.io/static/image/favicon/apple-touch-icon.png><link rel=mask-icon href=https://soonraah.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-73329599-2","auto"),ga("send","pageview"))</script><meta property="og:title" content="Data Contract について調べた"><meta property="og:description" content="データエンジニアリングの領域で少し前から目にするようになった &ldquo;data contract&rdquo; という言葉。
なんとなく今の業務で困っている課題の解決になりそうな気がしつつもよくわかっていなかったので調べてみた。
data contract について語られているいくつかのブログ記事などを参考にしている。
Data Contract とは データの schema というのはナマモノで、いろいろな理由で変更されることがある。
schema を変更する場合、その schema のデータ (table や log) が所属する単一のビジネス機能や application のドメインで行われることになる。
そのドメインの閉じた世界で考える分にはこれで問題ないのだが、DWH や data lake など組織レベルのデータ基盤でデータを流通していた場合はその先のことも考えないといけなくなる。
このようにチームを超える影響というのは、ビジネス機能に責任を持っているチームからは見えにくくなっていることが多い。
上流の application 側で schema を変更したら下流のデータ基盤の ETL 処理がぶっ壊れてしまった、というのはデータ基盤運用あるあるではないだろうか。
というところを解決して平和に過ごせるようにすることが data contract の主なモチベーションだと思われる。
&ldquo;contract&rdquo; は日本語で言うところの「契約」。
組織におけるデータ流通において、データの送り手である producer 側と受け手である consumer 側との間で合意した契約を遵守することにより、前述のような問題を避けることができるというのが data contract である。
組織内のデータの見通しがよくなったり、パイプラインを宣言的に開発することができるようになるというメリットもある。
エンジニアにとっては Datafold のブログ記事の例を読むとイメージしやすいかもしれない。
To provide another analogy, data contracts are what API is for the web services. Say we want to get data from Twitter."><meta property="og:type" content="article"><meta property="og:url" content="https://soonraah.github.io/posts/looked-into-data-contracts/"><meta property="og:image" content="https://soonraah.github.io/image/photo/sebastian-herrmann-NbtIDoFKGO8-unsplash.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-04-08T17:00:00+09:00"><meta property="article:modified_time" content="2023-04-08T17:00:00+09:00"><meta property="og:site_name" content="Froglog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://soonraah.github.io/image/photo/sebastian-herrmann-NbtIDoFKGO8-unsplash.jpg"><meta name=twitter:title content="Data Contract について調べた"><meta name=twitter:description content="データエンジニアリングの領域で少し前から目にするようになった &ldquo;data contract&rdquo; という言葉。
なんとなく今の業務で困っている課題の解決になりそうな気がしつつもよくわかっていなかったので調べてみた。
data contract について語られているいくつかのブログ記事などを参考にしている。
Data Contract とは データの schema というのはナマモノで、いろいろな理由で変更されることがある。
schema を変更する場合、その schema のデータ (table や log) が所属する単一のビジネス機能や application のドメインで行われることになる。
そのドメインの閉じた世界で考える分にはこれで問題ないのだが、DWH や data lake など組織レベルのデータ基盤でデータを流通していた場合はその先のことも考えないといけなくなる。
このようにチームを超える影響というのは、ビジネス機能に責任を持っているチームからは見えにくくなっていることが多い。
上流の application 側で schema を変更したら下流のデータ基盤の ETL 処理がぶっ壊れてしまった、というのはデータ基盤運用あるあるではないだろうか。
というところを解決して平和に過ごせるようにすることが data contract の主なモチベーションだと思われる。
&ldquo;contract&rdquo; は日本語で言うところの「契約」。
組織におけるデータ流通において、データの送り手である producer 側と受け手である consumer 側との間で合意した契約を遵守することにより、前述のような問題を避けることができるというのが data contract である。
組織内のデータの見通しがよくなったり、パイプラインを宣言的に開発することができるようになるというメリットもある。
エンジニアにとっては Datafold のブログ記事の例を読むとイメージしやすいかもしれない。
To provide another analogy, data contracts are what API is for the web services. Say we want to get data from Twitter."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://soonraah.github.io/posts/"},{"@type":"ListItem","position":3,"name":"Data Contract について調べた","item":"https://soonraah.github.io/posts/looked-into-data-contracts/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Data Contract について調べた","name":"Data Contract について調べた","description":"データエンジニアリングの領域で少し前から目にするようになった \u0026ldquo;data contract\u0026rdquo; という言葉。\nなんとなく今の業務で困っている課題の解決になりそうな気がしつつもよくわかっていなかったので調べてみた。\ndata contract について語られているいくつかのブログ記事などを参考にしている。\nData Contract とは データの schema というのはナマモノで、いろいろな理由で変更されることがある。\nschema を変更する場合、その schema のデータ (table や log) が所属する単一のビジネス機能や application のドメインで行われることになる。\nそのドメインの閉じた世界で考える分にはこれで問題ないのだが、DWH や data lake など組織レベルのデータ基盤でデータを流通していた場合はその先のことも考えないといけなくなる。\nこのようにチームを超える影響というのは、ビジネス機能に責任を持っているチームからは見えにくくなっていることが多い。\n上流の application 側で schema を変更したら下流のデータ基盤の ETL 処理がぶっ壊れてしまった、というのはデータ基盤運用あるあるではないだろうか。\nというところを解決して平和に過ごせるようにすることが data contract の主なモチベーションだと思われる。\n\u0026ldquo;contract\u0026rdquo; は日本語で言うところの「契約」。\n組織におけるデータ流通において、データの送り手である producer 側と受け手である consumer 側との間で合意した契約を遵守することにより、前述のような問題を避けることができるというのが data contract である。\n組織内のデータの見通しがよくなったり、パイプラインを宣言的に開発することができるようになるというメリットもある。\nエンジニアにとっては Datafold のブログ記事の例を読むとイメージしやすいかもしれない。\nTo provide another analogy, data contracts are what API is for the web services. Say we want to get data from Twitter.","keywords":["data contract"],"articleBody":"データエンジニアリングの領域で少し前から目にするようになった “data contract” という言葉。\nなんとなく今の業務で困っている課題の解決になりそうな気がしつつもよくわかっていなかったので調べてみた。\ndata contract について語られているいくつかのブログ記事などを参考にしている。\nData Contract とは データの schema というのはナマモノで、いろいろな理由で変更されることがある。\nschema を変更する場合、その schema のデータ (table や log) が所属する単一のビジネス機能や application のドメインで行われることになる。\nそのドメインの閉じた世界で考える分にはこれで問題ないのだが、DWH や data lake など組織レベルのデータ基盤でデータを流通していた場合はその先のことも考えないといけなくなる。\nこのようにチームを超える影響というのは、ビジネス機能に責任を持っているチームからは見えにくくなっていることが多い。\n上流の application 側で schema を変更したら下流のデータ基盤の ETL 処理がぶっ壊れてしまった、というのはデータ基盤運用あるあるではないだろうか。\nというところを解決して平和に過ごせるようにすることが data contract の主なモチベーションだと思われる。\n“contract” は日本語で言うところの「契約」。\n組織におけるデータ流通において、データの送り手である producer 側と受け手である consumer 側との間で合意した契約を遵守することにより、前述のような問題を避けることができるというのが data contract である。\n組織内のデータの見通しがよくなったり、パイプラインを宣言的に開発することができるようになるというメリットもある。\nエンジニアにとっては Datafold のブログ記事の例を読むとイメージしやすいかもしれない。\nTo provide another analogy, data contracts are what API is for the web services. Say we want to get data from Twitter. One way is to scrape it by downloading and parsing the HTML of Twitter’s webpage. This may work, but our scraper will likely break occasionally, if Twitter, for instance, changes a name of a CSS class or HTML structure. There is no contract between Twitter’s web page and our scraper. However, if we access the same data via Twitter’s API, we know exactly the structure of the response we’re going to get. An API has required inputs, predictable outputs, error codes, SLAs (service level agreements – e.g. uptime), and terms of use, and other important properties. Importantly, API is also versioned which helps ensure that changes to the API won’t break end user’s applications, and to take advantage of those changes users would graciously migrate to the new version.\nThe Best Data Contract is the Pull Request - datafold.com\nTwitter から情報を取ることを考えたとき、scraping する場合は UI の変更などで処理が壊れてしまうがちゃんと定義された API を使う場合は処理が壊れない。\nこの違いは約束事があるかどうかであり、data contract がない場合は約束事がない scraping のようなものだよね、という話。\n最初の例ではデータ基盤に流れてくるデータの schema が変わることを示したが consumer は中央集権的なデータ基盤である必要はなく、どちらかというと data mesh のような非中央集権的なコンテキストで話題に上がる方が多い。\nまた契約の対象となるのは schema だけではなく、次のような様々な情報を含んでよい。\nschema 所有者 利用者 セマンティクス 更新頻度 etc. 扱っている情報としては data catalog に近かったりもするが、data catalog はどうなっているかを示しているのに対して data contract はどうなっているべきかを示すという違いがある。\nData Contract の概況 data contract についてはいろいろな人が語っているが、なんとなく現時点でコミュニティにおいてある程度合意がありそうなことをいくつか挙げる。\n議論はまだまだこれからという感じなので、これらは時間が経つと変わっていく可能性が高いことに注意。\nスタンダードになるようなサービスや製品はまだない まるっと data contract をやってくれるようなサービスや製品はまだないので、data contract をやりたければある程度自社で作り込んだりルール整備したりする必要がある。\nこのようなサービスや製品がまだない理由については The Case for Data Contracts - uncomfortablyidiosyncratic.substack.com で議論があったのでご興味のある方はご確認ください。\nSchemata という OSS の schema modeling のフレームワークがあるがそんなに広まっていない？\nschema metadata についてはわかるけど schema score がどう使われるのかがイメージつかない。\nschema は IDL で表現して data contract に含める data contract の対象の中ではデータの schema は重要視されている。\nschema は IDL (Interface Description Language) で記述される。\nIDL として代表的なものとして Protocol Buffer と Apache Avro が挙げられる。\nschema を記述するための規定の方法が open source で提供されており、これを使ってレコード単位のチェックを行うことができる。\n他にも JSON Schema もあるが、DB の世界との間で型の扱いに差があるので個人的にはおすすめできない。\n契約の形は様々 契約 (contract) の形は data contract を語る人によっていろいろあってこれが議論になっている模様。\nproducer 側が主体的な場合もあれば consumer 側が主体的な場合もある。\n比較的よく挙げられれているのが pull-request のレビューをもって契約の合意とするという方式。\ndata contract が規定の形式のドキュメントになっていれば、その追加や変更についての二者間の合意はエンジニアにとって慣れ親しんだ pull-request という形で行うことができる。\nThe Best Data Contract is the Pull Request - datafold.com の記事が正にこれについて書かれたものとなっている。\n後述の実装例でもいくつか紹介する。\nData Contract の実装例 そうは言うてもどないして data contract を実現するんや？ってなりますよね。\nというところでその例をいくつか以下に記載してみる。\n詳細はリンク先を参照。\n例 1 An Engineer’s Guide to Data Contracts - Pt. 1 - dataproducts.substac.com\nentity、つまり DB の table の変更を流通させる場合の例 Pt. 2 の記事では event log の流通について書かれている data contract は Protocol Buffers で記載 data contract は CI/CD でテストや互換性チェックが行われ、Schema Registry に登録される production 環境では table の変更が CDC で Kafka の topic に送られている Kafka に送られたレコードを KSQL や Flink のフレームワーク + Schema Registry でチェックして新たな topic に transactional outbox pattern についても配慮 例 2 Aurimas Griciūnas’ Post - LinkedIn\n別の例だが例 1 に近い やはり Kafka や Flink を利用 例 3 Implementing Data Contracts at GoCardless - Medium\nPub/Sub や BigQuery に入る前に data contract による validation が行われる データ所有者が Jsonnet で定義された data contract を Git で merge すると、必要なリソースやサービスが生成される 宣言的でかっこいい 契約の主体が producer 側、つまりデータ所有者に寄っている印象 所有権を意識させる 例 4 Fine, let’s talk about data contracts - benn.substack.com\ndbt を使った例 なのでバッチ処理的なチェック 契約の主体が consumer 側、つまりデータ基盤に寄っている印象 (data contract というよりもデータ品質テストに近い気が) 所感 私がお仕事で運用しているデータ基盤では、最初に挙げたあるあるのような上流のデータの問題で ETL が影響を受けるということが度々あり課題となっていた。\nなので data contract という概念には期待がある。\n前回の記事 では Glue Schema Registry の導入を諦めた旨を書いたが、data contract という文脈で再度 Glue Schema Registry の採用を検討してみてもいいかもしれない。\n一方、国内ではあまり data contract の事例を聞いたことがなく、この辺不思議に思っている。\n理由としては\nこのような課題が存在しない -\u003e んなわけない 課題はあるが認識されていない -\u003e あるかもしれない 認識されて data contract 的なことをしているが data contract という言葉が使われていない -\u003e 某社の事例を噂で聞いたことがある などが考えられる。\n国内企業の事例も聞いてみたいところだし、自分のところで事例を出せるといいなとも思っている。\nあと CDC とかのリアルタイム処理はもう当たり前になってるんだな。\n参考 Data Contracts — From Zero To Hero The Best Data Contract is the Pull Request The Case for Data Contracts An Engineer’s Guide to Data Contracts - Pt. 1 Aurimas Griciūnas Post - LinkedIn Implementing Data Contracts at GoCardless Fine, let’s talk about data contracts ","wordCount":"588","inLanguage":"ja","image":"https://soonraah.github.io/image/photo/sebastian-herrmann-NbtIDoFKGO8-unsplash.jpg","datePublished":"2023-04-08T17:00:00+09:00","dateModified":"2023-04-08T17:00:00+09:00","author":{"@type":"Person","name":"soonraah"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://soonraah.github.io/posts/looked-into-data-contracts/"},"publisher":{"@type":"Organization","name":"Froglog","logo":{"@type":"ImageObject","url":"https://soonraah.github.io/favicon2.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://soonraah.github.io accesskey=h title="Home (Alt + H)"><img src=https://soonraah.github.io/image/brand/favicon.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://soonraah.github.io/about/ title=About><span>About</span></a></li><li><a href=https://soonraah.github.io/posts/ title=Posts><span>Posts</span></a></li><li><a href=https://soonraah.github.io/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://soonraah.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://soonraah.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://soonraah.github.io>ホーム</a>&nbsp;»&nbsp;<a href=https://soonraah.github.io/posts/>Posts</a></div><h1 class=post-title>Data Contract について調べた</h1><div class=post-meta><span title='2023-04-08 17:00:00 +0900 JST'>4月 8, 2023</span>&nbsp;·&nbsp;soonraah</div></header><figure class=entry-cover><img loading=lazy src=https://soonraah.github.io/image/photo/sebastian-herrmann-NbtIDoFKGO8-unsplash.jpg alt=contract><p><a href=https://unsplash.com/photos/NbtIDoFKGO8>Photo by Sebastian Herrmann on Unsplash</a></p></figure><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>目次</span></summary><div class=inner><ul><li><a href=#data-contract-%e3%81%a8%e3%81%af aria-label="Data Contract とは">Data Contract とは</a></li><li><a href=#data-contract-%e3%81%ae%e6%a6%82%e6%b3%81 aria-label="Data Contract の概況">Data Contract の概況</a><ul><li><a href=#%e3%82%b9%e3%82%bf%e3%83%b3%e3%83%80%e3%83%bc%e3%83%89%e3%81%ab%e3%81%aa%e3%82%8b%e3%82%88%e3%81%86%e3%81%aa%e3%82%b5%e3%83%bc%e3%83%93%e3%82%b9%e3%82%84%e8%a3%bd%e5%93%81%e3%81%af%e3%81%be%e3%81%a0%e3%81%aa%e3%81%84 aria-label=スタンダードになるようなサービスや製品はまだない>スタンダードになるようなサービスや製品はまだない</a></li><li><a href=#schema-%e3%81%af-idl-%e3%81%a7%e8%a1%a8%e7%8f%be%e3%81%97%e3%81%a6-data-contract-%e3%81%ab%e5%90%ab%e3%82%81%e3%82%8b aria-label="schema は IDL で表現して data contract に含める">schema は IDL で表現して data contract に含める</a></li><li><a href=#%e5%a5%91%e7%b4%84%e3%81%ae%e5%bd%a2%e3%81%af%e6%a7%98%e3%80%85 aria-label=契約の形は様々>契約の形は様々</a></li></ul></li><li><a href=#data-contract-%e3%81%ae%e5%ae%9f%e8%a3%85%e4%be%8b aria-label="Data Contract の実装例">Data Contract の実装例</a><ul><li><a href=#%e4%be%8b-1 aria-label="例 1">例 1</a></li><li><a href=#%e4%be%8b-2 aria-label="例 2">例 2</a></li><li><a href=#%e4%be%8b-3 aria-label="例 3">例 3</a></li><li><a href=#%e4%be%8b-4 aria-label="例 4">例 4</a></li></ul></li><li><a href=#%e6%89%80%e6%84%9f aria-label=所感>所感</a></li><li><a href=#%e5%8f%82%e8%80%83 aria-label=参考>参考</a></li></ul></div></details></div><div class=post-content><p>データエンジニアリングの領域で少し前から目にするようになった &ldquo;data contract&rdquo; という言葉。<br>なんとなく今の業務で困っている課題の解決になりそうな気がしつつもよくわかっていなかったので調べてみた。<br>data contract について語られているいくつかのブログ記事などを参考にしている。</p><h2 id=data-contract-とは>Data Contract とは<a hidden class=anchor aria-hidden=true href=#data-contract-とは>#</a></h2><p>データの schema というのはナマモノで、いろいろな理由で変更されることがある。<br>schema を変更する場合、その schema のデータ (table や log) が所属する単一のビジネス機能や application のドメインで行われることになる。<br>そのドメインの閉じた世界で考える分にはこれで問題ないのだが、DWH や data lake など組織レベルのデータ基盤でデータを流通していた場合はその先のことも考えないといけなくなる。<br>このようにチームを超える影響というのは、ビジネス機能に責任を持っているチームからは見えにくくなっていることが多い。<br>上流の application 側で schema を変更したら下流のデータ基盤の ETL 処理がぶっ壊れてしまった、というのはデータ基盤運用あるあるではないだろうか。</p><p>というところを解決して平和に過ごせるようにすることが data contract の主なモチベーションだと思われる。<br>&ldquo;contract&rdquo; は日本語で言うところの「契約」。<br>組織におけるデータ流通において、データの送り手である producer 側と受け手である consumer 側との間で合意した契約を遵守することにより、前述のような問題を避けることができるというのが data contract である。<br>組織内のデータの見通しがよくなったり、パイプラインを宣言的に開発することができるようになるというメリットもある。</p><p>エンジニアにとっては Datafold のブログ記事の例を読むとイメージしやすいかもしれない。</p><blockquote><p>To provide another analogy, data contracts are what API is for the web services. Say we want to get data from Twitter. One way is to scrape it by downloading and parsing the HTML of Twitter’s webpage. This may work, but our scraper will likely break occasionally, if Twitter, for instance, changes a name of a CSS class or HTML structure. There is no contract between Twitter’s web page and our scraper. However, if we access the same data via Twitter’s API, we know exactly the structure of the response we’re going to get. An API has required inputs, predictable outputs, error codes, SLAs (service level agreements – e.g. uptime), and terms of use, and other important properties. Importantly, API is also versioned which helps ensure that changes to the API won’t break end user’s applications, and to take advantage of those changes users would graciously migrate to the new version.</p></blockquote><p><a href=https://www.datafold.com/blog/the-best-data-contract-is-the-pull-request>The Best Data Contract is the Pull Request - datafold.com</a></p><p>Twitter から情報を取ることを考えたとき、scraping する場合は UI の変更などで処理が壊れてしまうがちゃんと定義された API を使う場合は処理が壊れない。<br>この違いは約束事があるかどうかであり、data contract がない場合は約束事がない scraping のようなものだよね、という話。</p><p>最初の例ではデータ基盤に流れてくるデータの schema が変わることを示したが consumer は中央集権的なデータ基盤である必要はなく、どちらかというと data mesh のような非中央集権的なコンテキストで話題に上がる方が多い。<br>また契約の対象となるのは schema だけではなく、次のような様々な情報を含んでよい。</p><ul><li>schema</li><li>所有者</li><li>利用者</li><li>セマンティクス</li><li>更新頻度</li><li>etc.</li></ul><p>扱っている情報としては data catalog に近かったりもするが、data catalog はどうなっているかを示しているのに対して data contract はどうなっているべきかを示すという違いがある。</p><h2 id=data-contract-の概況>Data Contract の概況<a hidden class=anchor aria-hidden=true href=#data-contract-の概況>#</a></h2><p>data contract についてはいろいろな人が語っているが、なんとなく現時点でコミュニティにおいてある程度合意がありそうなことをいくつか挙げる。<br>議論はまだまだこれからという感じなので、これらは時間が経つと変わっていく可能性が高いことに注意。</p><h3 id=スタンダードになるようなサービスや製品はまだない>スタンダードになるようなサービスや製品はまだない<a hidden class=anchor aria-hidden=true href=#スタンダードになるようなサービスや製品はまだない>#</a></h3><p>まるっと data contract をやってくれるようなサービスや製品はまだないので、data contract をやりたければある程度自社で作り込んだりルール整備したりする必要がある。<br>このようなサービスや製品がまだない理由については <a href=https://uncomfortablyidiosyncratic.substack.com/p/the-case-for-data-contracts>The Case for Data Contracts - uncomfortablyidiosyncratic.substack.com</a> で議論があったのでご興味のある方はご確認ください。</p><p><a href=https://github.com/ananthdurai/schemata>Schemata</a> という OSS の schema modeling のフレームワークがあるがそんなに広まっていない？<br>schema metadata についてはわかるけど schema score がどう使われるのかがイメージつかない。</p><h3 id=schema-は-idl-で表現して-data-contract-に含める>schema は IDL で表現して data contract に含める<a hidden class=anchor aria-hidden=true href=#schema-は-idl-で表現して-data-contract-に含める>#</a></h3><p>data contract の対象の中ではデータの schema は重要視されている。<br>schema は IDL (Interface Description Language) で記述される。<br>IDL として代表的なものとして Protocol Buffer と Apache Avro が挙げられる。<br>schema を記述するための規定の方法が open source で提供されており、これを使ってレコード単位のチェックを行うことができる。<br>他にも JSON Schema もあるが、DB の世界との間で型の扱いに差があるので個人的にはおすすめできない。</p><h3 id=契約の形は様々>契約の形は様々<a hidden class=anchor aria-hidden=true href=#契約の形は様々>#</a></h3><p>契約 (contract) の形は data contract を語る人によっていろいろあってこれが議論になっている模様。<br>producer 側が主体的な場合もあれば consumer 側が主体的な場合もある。</p><p>比較的よく挙げられれているのが pull-request のレビューをもって契約の合意とするという方式。<br>data contract が規定の形式のドキュメントになっていれば、その追加や変更についての二者間の合意はエンジニアにとって慣れ親しんだ pull-request という形で行うことができる。<br><a href=https://www.datafold.com/blog/the-best-data-contract-is-the-pull-request>The Best Data Contract is the Pull Request - datafold.com</a> の記事が正にこれについて書かれたものとなっている。</p><p>後述の実装例でもいくつか紹介する。</p><h2 id=data-contract-の実装例>Data Contract の実装例<a hidden class=anchor aria-hidden=true href=#data-contract-の実装例>#</a></h2><p>そうは言うてもどないして data contract を実現するんや？ってなりますよね。<br>というところでその例をいくつか以下に記載してみる。<br>詳細はリンク先を参照。</p><h3 id=例-1>例 1<a hidden class=anchor aria-hidden=true href=#例-1>#</a></h3><p><a href=https://dataproducts.substack.com/p/an-engineers-guide-to-data-contracts>An Engineer&rsquo;s Guide to Data Contracts - Pt. 1 - dataproducts.substac.com</a></p><blockquote><p><img loading=lazy src=/image/looked-into-data-contracts/an-engineers-guide-to-data-contracts.png alt></p></blockquote><ul><li>entity、つまり DB の table の変更を流通させる場合の例<ul><li><a href=https://dataproducts.substack.com/p/an-engineers-guide-to-data-contracts-6df>Pt. 2</a> の記事では event log の流通について書かれている</li></ul></li><li>data contract は Protocol Buffers で記載</li><li>data contract は CI/CD でテストや互換性チェックが行われ、Schema Registry に登録される</li><li>production 環境では table の変更が CDC で Kafka の topic に送られている</li><li>Kafka に送られたレコードを KSQL や Flink のフレームワーク + Schema Registry でチェックして新たな topic に</li><li><a href=https://microservices.io/patterns/data/transactional-outbox.html>transactional outbox pattern</a> についても配慮</li></ul><h3 id=例-2>例 2<a hidden class=anchor aria-hidden=true href=#例-2>#</a></h3><p><a href=https://www.linkedin.com/posts/aurimas-griciunas_dataengineering-mlops-machinelearning-activity-6993825723899641856-3oPS/>Aurimas Griciūnas’ Post - LinkedIn</a></p><blockquote><p><img loading=lazy src=/image/looked-into-data-contracts/aurimas.png alt></p></blockquote><ul><li>別の例だが例 1 に近い<ul><li>やはり Kafka や Flink を利用</li></ul></li></ul><h3 id=例-3>例 3<a hidden class=anchor aria-hidden=true href=#例-3>#</a></h3><p><a href=https://medium.com/gocardless-tech/implementing-data-contracts-at-gocardless-3b5c49074d13>Implementing Data Contracts at GoCardless - Medium</a></p><blockquote><p><img loading=lazy src=/image/looked-into-data-contracts/implementing-data-contracts-at-gocardless.png alt></p></blockquote><ul><li>Pub/Sub や BigQuery に入る前に data contract による validation が行われる</li><li>データ所有者が <a href=https://jsonnet.org/>Jsonnet</a> で定義された data contract を Git で merge すると、必要なリソースやサービスが生成される<ul><li>宣言的でかっこいい</li></ul></li><li>契約の主体が producer 側、つまりデータ所有者に寄っている印象<ul><li>所有権を意識させる</li></ul></li></ul><h3 id=例-4>例 4<a hidden class=anchor aria-hidden=true href=#例-4>#</a></h3><p><a href=https://benn.substack.com/p/data-contracts>Fine, let&rsquo;s talk about data contracts - benn.substack.com</a></p><blockquote><p><img loading=lazy src=/image/looked-into-data-contracts/fine-lets-talk-about-data-contracts.png alt></p></blockquote><ul><li>dbt を使った例<ul><li>なのでバッチ処理的なチェック</li></ul></li><li>契約の主体が consumer 側、つまりデータ基盤に寄っている印象<ul><li>(data contract というよりもデータ品質テストに近い気が)</li></ul></li></ul><h2 id=所感>所感<a hidden class=anchor aria-hidden=true href=#所感>#</a></h2><p>私がお仕事で運用しているデータ基盤では、最初に挙げたあるあるのような上流のデータの問題で ETL が影響を受けるということが度々あり課題となっていた。<br>なので data contract という概念には期待がある。<br><a href=https://soonraah.github.io/posts/give-up-on-schema-registry/>前回の記事</a> では Glue Schema Registry の導入を諦めた旨を書いたが、data contract という文脈で再度 Glue Schema Registry の採用を検討してみてもいいかもしれない。</p><p>一方、国内ではあまり data contract の事例を聞いたことがなく、この辺不思議に思っている。<br>理由としては</p><ul><li>このような課題が存在しない -> んなわけない</li><li>課題はあるが認識されていない -> あるかもしれない</li><li>認識されて data contract 的なことをしているが data contract という言葉が使われていない -> 某社の事例を噂で聞いたことがある</li></ul><p>などが考えられる。<br>国内企業の事例も聞いてみたいところだし、自分のところで事例を出せるといいなとも思っている。</p><p>あと CDC とかのリアルタイム処理はもう当たり前になってるんだな。</p><h2 id=参考>参考<a hidden class=anchor aria-hidden=true href=#参考>#</a></h2><ul><li><a href=https://towardsdatascience.com/data-contracts-from-zero-to-hero-343717ac4d5e>Data Contracts — From Zero To Hero</a></li><li><a href=https://www.datafold.com/blog/the-best-data-contract-is-the-pull-request>The Best Data Contract is the Pull Request</a></li><li><a href=https://uncomfortablyidiosyncratic.substack.com/p/the-case-for-data-contracts>The Case for Data Contracts</a></li><li><a href=https://dataproducts.substack.com/p/an-engineers-guide-to-data-contracts>An Engineer&rsquo;s Guide to Data Contracts - Pt. 1</a></li><li><a href="https://www.linkedin.com/posts/aurimas-griciunas_dataengineering-mlops-machinelearning-activity-6993825723899641856-3oPS/?utm_source=share&amp;utm_medium=member_desktop">Aurimas Griciūnas Post - LinkedIn</a></li><li><a href=https://medium.com/gocardless-tech/implementing-data-contracts-at-gocardless-3b5c49074d13>Implementing Data Contracts at GoCardless</a></li><li><a href=https://benn.substack.com/p/data-contracts>Fine, let&rsquo;s talk about data contracts</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://soonraah.github.io/tags/data-contract/>data contract</a></li></ul><nav class=paginav><a class=prev href=https://soonraah.github.io/posts/update-iceberg-table-in-near-real-time/><span class=title>« 前へ</span><br><span>Apache Iceberg の table を near real time で更新する</span>
</a><a class=next href=https://soonraah.github.io/posts/give-up-on-schema-registry/><span class=title>次へ »</span><br><span>Glue Schema Registry の導入を断念した話</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Data Contract について調べた on x" href="https://x.com/intent/tweet/?text=Data%20Contract%20%e3%81%ab%e3%81%a4%e3%81%84%e3%81%a6%e8%aa%bf%e3%81%b9%e3%81%9f&amp;url=https%3a%2f%2fsoonraah.github.io%2fposts%2flooked-into-data-contracts%2f&amp;hashtags=datacontract"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Data Contract について調べた on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fsoonraah.github.io%2fposts%2flooked-into-data-contracts%2f&amp;title=Data%20Contract%20%e3%81%ab%e3%81%a4%e3%81%84%e3%81%a6%e8%aa%bf%e3%81%b9%e3%81%9f&amp;summary=Data%20Contract%20%e3%81%ab%e3%81%a4%e3%81%84%e3%81%a6%e8%aa%bf%e3%81%b9%e3%81%9f&amp;source=https%3a%2f%2fsoonraah.github.io%2fposts%2flooked-into-data-contracts%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Data Contract について調べた on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fsoonraah.github.io%2fposts%2flooked-into-data-contracts%2f&title=Data%20Contract%20%e3%81%ab%e3%81%a4%e3%81%84%e3%81%a6%e8%aa%bf%e3%81%b9%e3%81%9f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Data Contract について調べた on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fsoonraah.github.io%2fposts%2flooked-into-data-contracts%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Data Contract について調べた on whatsapp" href="https://api.whatsapp.com/send?text=Data%20Contract%20%e3%81%ab%e3%81%a4%e3%81%84%e3%81%a6%e8%aa%bf%e3%81%b9%e3%81%9f%20-%20https%3a%2f%2fsoonraah.github.io%2fposts%2flooked-into-data-contracts%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Data Contract について調べた on telegram" href="https://telegram.me/share/url?text=Data%20Contract%20%e3%81%ab%e3%81%a4%e3%81%84%e3%81%a6%e8%aa%bf%e3%81%b9%e3%81%9f&amp;url=https%3a%2f%2fsoonraah.github.io%2fposts%2flooked-into-data-contracts%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Data Contract について調べた on ycombinator" href="https://news.ycombinator.com/submitlink?t=Data%20Contract%20%e3%81%ab%e3%81%a4%e3%81%84%e3%81%a6%e8%aa%bf%e3%81%b9%e3%81%9f&u=https%3a%2f%2fsoonraah.github.io%2fposts%2flooked-into-data-contracts%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://soonraah.github.io>Froglog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="コピー";function s(){t.innerHTML="コピーされました!",setTimeout(()=>{t.innerHTML="コピー"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>