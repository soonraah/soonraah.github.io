<!doctype html><html lang=ja dir=auto><head><script async src="https://www.googletagmanager.com/gtag/js?id=G-NSEGH2YT17"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-NSEGH2YT17")</script><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Glue Schema Registry の導入を断念した話 | Froglog</title>
<meta name=keywords content="AWS,Data Lake,Apache Hudi,stream processing"><meta name=description content="業務で AWS Glue Schema Registry を使おうとしたけど、やっぱりやめたというお話。
Glue Schema Registry What&rsquo;s Schema Registry? AWS Glue Schema Registry は2020年に発表された AWS の機能だ。
Control the evolution of data streams using the AWS Glue Schema Registry 一方、私が最初に schema registry 的なものを見たのは Confluent の例。
Schema Registry の概要 - Confluent AWS の Glue Schema Registry はこれより後のリリースであり、同等のものの AWS マネージド版といったところだろうか。
schema registry で何ができるかは Confluent のリンク先の図がとてもわかりやすいので参考にしていただきたい。
Glue Schema Registry もだいたい同じで、ストリーム処理のための機能である。
Glue Schema Registry で解決したい課題とその機能 データ基盤上のストリーム処理における schema 管理はバッチ処理のそれとは異なる難しさがある。
これは schema evolution と呼ばれる問題で以前のポストでも述べている。"><meta name=author content="soonraah"><link rel=canonical href=https://soonraah.github.io/posts/give-up-on-schema-registry/><meta name=google-site-verification content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.5cfc680b1eeaeef9efbced92d46c2a9e876b72ee14fba85846afc4cff9e6e6f8.css integrity="sha256-XPxoCx7q7vnvvO2S1Gwqnodrcu4U+6hYRq/Ez/nm5vg=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://soonraah.github.io/favicon2.ico><link rel=icon type=image/png sizes=16x16 href=https://soonraah.github.io/image/favicon/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://soonraah.github.io/image/favicon/favicon-32x32.png><link rel=apple-touch-icon href=https://soonraah.github.io/static/image/favicon/apple-touch-icon.png><link rel=mask-icon href=https://soonraah.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-73329599-2","auto"),ga("send","pageview"))</script><meta property="og:title" content="Glue Schema Registry の導入を断念した話"><meta property="og:description" content="業務で AWS Glue Schema Registry を使おうとしたけど、やっぱりやめたというお話。
Glue Schema Registry What&rsquo;s Schema Registry? AWS Glue Schema Registry は2020年に発表された AWS の機能だ。
Control the evolution of data streams using the AWS Glue Schema Registry 一方、私が最初に schema registry 的なものを見たのは Confluent の例。
Schema Registry の概要 - Confluent AWS の Glue Schema Registry はこれより後のリリースであり、同等のものの AWS マネージド版といったところだろうか。
schema registry で何ができるかは Confluent のリンク先の図がとてもわかりやすいので参考にしていただきたい。
Glue Schema Registry もだいたい同じで、ストリーム処理のための機能である。
Glue Schema Registry で解決したい課題とその機能 データ基盤上のストリーム処理における schema 管理はバッチ処理のそれとは異なる難しさがある。
これは schema evolution と呼ばれる問題で以前のポストでも述べている。"><meta property="og:type" content="article"><meta property="og:url" content="https://soonraah.github.io/posts/give-up-on-schema-registry/"><meta property="og:image" content="https://soonraah.github.io/image/photo/matteo-vistocco-JISJeV-pXaQ-unsplash.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-12-13T00:30:00+09:00"><meta property="article:modified_time" content="2022-12-13T00:30:00+09:00"><meta property="og:site_name" content="Froglog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://soonraah.github.io/image/photo/matteo-vistocco-JISJeV-pXaQ-unsplash.jpg"><meta name=twitter:title content="Glue Schema Registry の導入を断念した話"><meta name=twitter:description content="業務で AWS Glue Schema Registry を使おうとしたけど、やっぱりやめたというお話。
Glue Schema Registry What&rsquo;s Schema Registry? AWS Glue Schema Registry は2020年に発表された AWS の機能だ。
Control the evolution of data streams using the AWS Glue Schema Registry 一方、私が最初に schema registry 的なものを見たのは Confluent の例。
Schema Registry の概要 - Confluent AWS の Glue Schema Registry はこれより後のリリースであり、同等のものの AWS マネージド版といったところだろうか。
schema registry で何ができるかは Confluent のリンク先の図がとてもわかりやすいので参考にしていただきたい。
Glue Schema Registry もだいたい同じで、ストリーム処理のための機能である。
Glue Schema Registry で解決したい課題とその機能 データ基盤上のストリーム処理における schema 管理はバッチ処理のそれとは異なる難しさがある。
これは schema evolution と呼ばれる問題で以前のポストでも述べている。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://soonraah.github.io/posts/"},{"@type":"ListItem","position":3,"name":"Glue Schema Registry の導入を断念した話","item":"https://soonraah.github.io/posts/give-up-on-schema-registry/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Glue Schema Registry の導入を断念した話","name":"Glue Schema Registry の導入を断念した話","description":"業務で AWS Glue Schema Registry を使おうとしたけど、やっぱりやめたというお話。\nGlue Schema Registry What\u0026rsquo;s Schema Registry? AWS Glue Schema Registry は2020年に発表された AWS の機能だ。\nControl the evolution of data streams using the AWS Glue Schema Registry 一方、私が最初に schema registry 的なものを見たのは Confluent の例。\nSchema Registry の概要 - Confluent AWS の Glue Schema Registry はこれより後のリリースであり、同等のものの AWS マネージド版といったところだろうか。\nschema registry で何ができるかは Confluent のリンク先の図がとてもわかりやすいので参考にしていただきたい。\nGlue Schema Registry もだいたい同じで、ストリーム処理のための機能である。\nGlue Schema Registry で解決したい課題とその機能 データ基盤上のストリーム処理における schema 管理はバッチ処理のそれとは異なる難しさがある。\nこれは schema evolution と呼ばれる問題で以前のポストでも述べている。","keywords":["AWS","Data Lake","Apache Hudi","stream processing"],"articleBody":"業務で AWS Glue Schema Registry を使おうとしたけど、やっぱりやめたというお話。\nGlue Schema Registry What’s Schema Registry? AWS Glue Schema Registry は2020年に発表された AWS の機能だ。\nControl the evolution of data streams using the AWS Glue Schema Registry 一方、私が最初に schema registry 的なものを見たのは Confluent の例。\nSchema Registry の概要 - Confluent AWS の Glue Schema Registry はこれより後のリリースであり、同等のものの AWS マネージド版といったところだろうか。\nschema registry で何ができるかは Confluent のリンク先の図がとてもわかりやすいので参考にしていただきたい。\nGlue Schema Registry もだいたい同じで、ストリーム処理のための機能である。\nGlue Schema Registry で解決したい課題とその機能 データ基盤上のストリーム処理における schema 管理はバッチ処理のそれとは異なる難しさがある。\nこれは schema evolution と呼ばれる問題で以前のポストでも述べている。\nバッチ処理おじさんがストリーム処理のシステムを開発するにあたって調べたこと 難しい点として以下のようなことが挙げられる。\n処理は常に行われており、producer の application 等をしばらく停止させない限りはオンラインで schema 変更をするしかない ただしデータ基盤起因で producer を止めることはなるべくしたくない オンラインの場合、out of orderness に配慮する必要がある deploy 順序、ネットワーク遅延など様々な要因から、新しい schema のレコードが古い schema のレコードより後に届くとはかぎらない consumer 側で新旧 schema に対する互換性 (compatibility) に配慮する必要がある Glue Schema Registry はこの課題に対応する。\nざっと説明すると次のようにして利用される。\nbroker (Apache Kafka, Amazon Kinesis Data Stremas, etc.) を挟んで producer と consumer の両方から参照できる場所にバージョン管理された schema 定義を配置する (これが Glue Schema Registry) producer からレコードを serialize して送信。レコードには schema のバージョン情報を含む consumer はレコードに含まれるバージョン情報と schema registry を参照してレコードの deserialize・解釈を行う これを実現するために Glue Schema Registry では次のような機能が提供されている。\nschema の登録と互換性ルールにもとづく schema のバージョン管理 producer, consumer で利用される SerDe ライブラリの提供 producer 側でのレコード検証、serialize、配信 consumer 側での deserialize これによりストリーム処理における producer と consumer の間で schema 変更を運用することが可能になる。\nやりたかったこと …という Glue Schema Registry が自分の業務でも使えるのではないか、そんなふうに考えていた時期が私にもありました。\n現在私は B to B to C のビジネスをやっている企業でデータ基盤の開発・運用を行うチームに所属している。\nその中で、ある application から発生する JSON 形式のログを near real time でデータ基盤に取り込み、分析したいという案件があった。\n以下のようなアーキテクチャを考えた。\napplication 側から SerDe ライブラリを使い、Kinesis Data Streams (KDS) に逐次的にレコードを配信 Spark Structured Streaming で Glue streaming ETL の job を実装し、KDS を購読してSerDe ライブラリ経由でデータ取得 Spark Structured Streaming から Apache Hudi の形式 (Merge on Read) で S3 へと保存 schema の変更がある場合は Glue Data Catalog 上の Hudi table の schema を変更 Athena でクエリ (ちなみに Glue Schema Registry のアイコンは AWS では提供されていない)\napplication はビジネスロジックに近いシステムを担当しているチームの管理であり、それ以降がデータ基盤チームの管理となっている。\nnear real time 以外でもデータソース側とデータ基盤側の間での schema 管理は以前から課題があり、この Glue Schema Registry を使えばうまくやる前例を作れるのではという期待があった。\n4 の schema 変更は自動で行われ、したがって application ログの schema と Hudi table の schema を別で管理・メンテする必要がない。\napplication 側とデータ基盤側の中間で schema を定義・管理できるのが素晴らしい、そんなふうに考えていた時期が私にもありました。\n断念した理由 が、結局は Glue Schema Registry の採用は断念するという結論になった。\n次のような理由にもとづく。\nSerDe 導入の壁 JSON Schema の折り合い 互換性の運用の難しさ 以下、それぞれについて述べる。\nSerDe 導入の壁 前述のようなアーキテクチャを実現するには、application 側のチームに SerDe ライブラリを導入してもらう必要がある。\nSerDe は Java のライブラリとして提供されているため、application 側が Java 系の言語で開発されている必要がある。\nここに大きなハードルがあると感じた。\nちなみに KDS まわりであれば SDK や KPL 経由で使うことも可能である。\n今回は application は Scala だったので、頼み込めば今回の案件については導入してもらうこともできたかもしれない。\nただ、うまくいけば今回の案件に限らず横展開したいと考えていたので、それを考えるとかなりハードルが高いという判断となった。\nJSON Schema の折り合い application とデータ基盤の間の schema 管理については data contract という考え方が出てきている。\nそれについて書かれたブログ記事 7 Lessons From GoCardless’ Implementation of Data Contracts で\nFor example, most teams didn’t want to use AVRO so we decided to use JSON as the interchange format for the contracts because it’s extensible.\nとあるように、Avro 形式を各 application チームに使ってもらうというのはまあまあハードルが高い。\nGlue Schema Registry ではレコードの形式として Avro, Protobuf, JSON をサポートしている。\n本来はできれば Avro や Protobuf のような、型がしっかりしている形式を使いたいところだが、このようなハードルがあり我々も JSON の仕様を前提に考えていた。\nJSON の場合は JSON Schema の仕様に従うことになる。\nこの JSON Schema、当たり前だが JSON の世界を表現するためのものとなっている。\n何が言いたいかというと JSON の世界の型の表現と Hudi table を含めた DB 的な世界の型の表現とが一致しないのだ。\n例えば数値表現を見てみると、JSON Schema においては integer, number, Multiples, Range の4つの型が定義されている。\n一般的な整数型 short, int, long 等の違いを表現することができない。\nGlue Schema Registry に登録された JSON Schema により Hudi の table の schema を自動更新したかったので、これは困ったぞ、となってしまった。\n互換性の運用の難しさ これはちょっと言葉にしにくいのだが、前方／後方互換性まわりの仕様が直感的に理解しにくかった。\nどういったときにフィールド追加が許容されるのか、互換性の起点となる checkpoint はどういったときに更新されるのか、etc.\nこのあたりいろいろ調査すれば理解できると思うのだが、ここまでの課題もあり気持ちが折れてしまった。\nまた、チームとしてこれを踏まえた schema 更新を運用するのはハードルが高いと感じた。\n結局どうしたか Glue Schema Registry は使わず、では結局どうしたかというと application 側とデータ基盤側の間でシステム的に schema を共有することなく連携する形にした。\nシステム的に共有しないので、人が共有してやるしかない。\nschema 変更する場合は次のようにチーム間で協調して進める。\nチーム間で認識合わせ データ基盤チームによる Glue Data Catalog の schema の変更作業 consumer に前方互換性があるという前提 application チームによる application ログの schema の変更作業 このあたりもっとうまくできる方法があるのではと考えている。\nとりあえず data contract の発展に期待しておく。\nまとめ ストリーム処理における Glue Schema Registry の思想、考え方は正しいものであると感じる。\nただし、扱いが難しい面があり、今回のユースケースやそれを踏まえた横展開には合わないという判断となった。\nチームやシステムをまたいだ schema 管理は簡単ではない。\n","wordCount":"465","inLanguage":"ja","image":"https://soonraah.github.io/image/photo/matteo-vistocco-JISJeV-pXaQ-unsplash.jpg","datePublished":"2022-12-13T00:30:00+09:00","dateModified":"2022-12-13T00:30:00+09:00","author":{"@type":"Person","name":"soonraah"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://soonraah.github.io/posts/give-up-on-schema-registry/"},"publisher":{"@type":"Organization","name":"Froglog","logo":{"@type":"ImageObject","url":"https://soonraah.github.io/favicon2.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://soonraah.github.io accesskey=h title="Home (Alt + H)"><img src=https://soonraah.github.io/image/brand/favicon.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://soonraah.github.io/about/ title=About><span>About</span></a></li><li><a href=https://soonraah.github.io/posts/ title=Posts><span>Posts</span></a></li><li><a href=https://soonraah.github.io/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://soonraah.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://soonraah.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://soonraah.github.io>ホーム</a>&nbsp;»&nbsp;<a href=https://soonraah.github.io/posts/>Posts</a></div><h1 class=post-title>Glue Schema Registry の導入を断念した話</h1><div class=post-meta><span title='2022-12-13 00:30:00 +0900 JST'>12月 13, 2022</span>&nbsp;·&nbsp;soonraah</div></header><figure class=entry-cover><img loading=lazy src=https://soonraah.github.io/image/photo/matteo-vistocco-JISJeV-pXaQ-unsplash.jpg alt=gap><p><a href=https://unsplash.com/photos/JISJeV-pXaQ>Photo by Matteo Vistocco on Unsplash</a></p></figure><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>目次</span></summary><div class=inner><ul><li><a href=#glue-schema-registry aria-label="Glue Schema Registry">Glue Schema Registry</a><ul><li><a href=#whats-schema-registry aria-label="What&amp;rsquo;s Schema Registry?">What&rsquo;s Schema Registry?</a></li><li><a href=#glue-schema-registry-%e3%81%a7%e8%a7%a3%e6%b1%ba%e3%81%97%e3%81%9f%e3%81%84%e8%aa%b2%e9%a1%8c%e3%81%a8%e3%81%9d%e3%81%ae%e6%a9%9f%e8%83%bd aria-label="Glue Schema Registry で解決したい課題とその機能">Glue Schema Registry で解決したい課題とその機能</a></li></ul></li><li><a href=#%e3%82%84%e3%82%8a%e3%81%9f%e3%81%8b%e3%81%a3%e3%81%9f%e3%81%93%e3%81%a8 aria-label=やりたかったこと>やりたかったこと</a></li><li><a href=#%e6%96%ad%e5%bf%b5%e3%81%97%e3%81%9f%e7%90%86%e7%94%b1 aria-label=断念した理由>断念した理由</a><ul><li><a href=#serde-%e5%b0%8e%e5%85%a5%e3%81%ae%e5%a3%81 aria-label="SerDe 導入の壁">SerDe 導入の壁</a></li><li><a href=#json-schema-%e3%81%ae%e6%8a%98%e3%82%8a%e5%90%88%e3%81%84 aria-label="JSON Schema の折り合い">JSON Schema の折り合い</a></li><li><a href=#%e4%ba%92%e6%8f%9b%e6%80%a7%e3%81%ae%e9%81%8b%e7%94%a8%e3%81%ae%e9%9b%a3%e3%81%97%e3%81%95 aria-label=互換性の運用の難しさ>互換性の運用の難しさ</a></li></ul></li><li><a href=#%e7%b5%90%e5%b1%80%e3%81%a9%e3%81%86%e3%81%97%e3%81%9f%e3%81%8b aria-label=結局どうしたか>結局どうしたか</a></li><li><a href=#%e3%81%be%e3%81%a8%e3%82%81 aria-label=まとめ>まとめ</a></li></ul></div></details></div><div class=post-content><p>業務で <a href=https://docs.aws.amazon.com/glue/latest/dg/schema-registry.html>AWS Glue Schema Registry</a> を使おうとしたけど、やっぱりやめたというお話。</p><h2 id=glue-schema-registry>Glue Schema Registry<a hidden class=anchor aria-hidden=true href=#glue-schema-registry>#</a></h2><h3 id=whats-schema-registry>What&rsquo;s Schema Registry?<a hidden class=anchor aria-hidden=true href=#whats-schema-registry>#</a></h3><p><a href=https://docs.aws.amazon.com/glue/latest/dg/schema-registry.html>AWS Glue Schema Registry</a> は2020年に発表された AWS の機能だ。</p><ul><li><a href=https://aws.amazon.com/about-aws/whats-new/2020/11/control-evolution-data-streams-using-aws-glue-schema-registry/>Control the evolution of data streams using the AWS Glue Schema Registry</a></li></ul><p>一方、私が最初に schema registry 的なものを見たのは Confluent の例。</p><ul><li><a href=https://docs.confluent.io/ja-jp/platform/7.1.1/schema-registry/index.html>Schema Registry の概要 - Confluent</a></li></ul><p>AWS の Glue Schema Registry はこれより後のリリースであり、同等のものの AWS マネージド版といったところだろうか。<br>schema registry で何ができるかは Confluent のリンク先の図がとてもわかりやすいので参考にしていただきたい。<br>Glue Schema Registry もだいたい同じで、ストリーム処理のための機能である。</p><h3 id=glue-schema-registry-で解決したい課題とその機能>Glue Schema Registry で解決したい課題とその機能<a hidden class=anchor aria-hidden=true href=#glue-schema-registry-で解決したい課題とその機能>#</a></h3><p>データ基盤上のストリーム処理における schema 管理はバッチ処理のそれとは異なる難しさがある。<br>これは schema evolution と呼ばれる問題で以前のポストでも述べている。</p><ul><li><a href=../study-streaming-system/#schema-evolution>バッチ処理おじさんがストリーム処理のシステムを開発するにあたって調べたこと</a></li></ul><p>難しい点として以下のようなことが挙げられる。</p><ul><li>処理は常に行われており、producer の application 等をしばらく停止させない限りはオンラインで schema 変更をするしかない<ul><li>ただしデータ基盤起因で producer を止めることはなるべくしたくない</li></ul></li><li>オンラインの場合、<a href=https://soonraah.github.io/posts/functionality-of-streaming-system/#out-of-order-data-management>out of orderness</a> に配慮する必要がある<ul><li>deploy 順序、ネットワーク遅延など様々な要因から、新しい schema のレコードが古い schema のレコードより後に届くとはかぎらない</li></ul></li><li>consumer 側で新旧 schema に対する互換性 (compatibility) に配慮する必要がある</li></ul><p>Glue Schema Registry はこの課題に対応する。<br>ざっと説明すると次のようにして利用される。</p><ol><li>broker (Apache Kafka, Amazon Kinesis Data Stremas, etc.) を挟んで producer と consumer の両方から参照できる場所にバージョン管理された schema 定義を配置する (これが Glue Schema Registry)</li><li>producer からレコードを serialize して送信。レコードには schema のバージョン情報を含む</li><li>consumer はレコードに含まれるバージョン情報と schema registry を参照してレコードの deserialize・解釈を行う</li></ol><p>これを実現するために Glue Schema Registry では次のような機能が提供されている。</p><ul><li>schema の登録と互換性ルールにもとづく schema のバージョン管理</li><li>producer, consumer で利用される SerDe ライブラリの提供<ul><li>producer 側でのレコード検証、serialize、配信</li><li>consumer 側での deserialize</li></ul></li></ul><p>これによりストリーム処理における producer と consumer の間で schema 変更を運用することが可能になる。</p><h2 id=やりたかったこと>やりたかったこと<a hidden class=anchor aria-hidden=true href=#やりたかったこと>#</a></h2><p>…という Glue Schema Registry が自分の業務でも使えるのではないか、そんなふうに考えていた時期が私にもありました。</p><p>現在私は B to B to C のビジネスをやっている企業でデータ基盤の開発・運用を行うチームに所属している。<br>その中で、ある application から発生する JSON 形式のログを near real time でデータ基盤に取り込み、分析したいという案件があった。</p><p>以下のようなアーキテクチャを考えた。</p><p><img loading=lazy src=/image/architecture/glue_schema_registry_architecture_ideal.png alt="architecture ideal"></p><ol><li>application 側から SerDe ライブラリを使い、Kinesis Data Streams (KDS) に逐次的にレコードを配信</li><li>Spark Structured Streaming で Glue streaming ETL の job を実装し、KDS を購読してSerDe ライブラリ経由でデータ取得</li><li>Spark Structured Streaming から Apache Hudi の形式 (Merge on Read) で S3 へと保存</li><li>schema の変更がある場合は Glue Data Catalog 上の Hudi table の schema を変更</li><li>Athena でクエリ</li></ol><p>(ちなみに Glue Schema Registry のアイコンは AWS では提供されていない)</p><p>application はビジネスロジックに近いシステムを担当しているチームの管理であり、それ以降がデータ基盤チームの管理となっている。<br>near real time 以外でもデータソース側とデータ基盤側の間での schema 管理は以前から課題があり、この Glue Schema Registry を使えばうまくやる前例を作れるのではという期待があった。<br>4 の schema 変更は自動で行われ、したがって application ログの schema と Hudi table の schema を別で管理・メンテする必要がない。<br>application 側とデータ基盤側の中間で schema を定義・管理できるのが素晴らしい、そんなふうに考えていた時期が私にもありました。</p><h2 id=断念した理由>断念した理由<a hidden class=anchor aria-hidden=true href=#断念した理由>#</a></h2><p>が、結局は Glue Schema Registry の採用は断念するという結論になった。<br>次のような理由にもとづく。</p><ul><li>SerDe 導入の壁</li><li>JSON Schema の折り合い</li><li>互換性の運用の難しさ</li></ul><p>以下、それぞれについて述べる。</p><h3 id=serde-導入の壁>SerDe 導入の壁<a hidden class=anchor aria-hidden=true href=#serde-導入の壁>#</a></h3><p>前述のようなアーキテクチャを実現するには、application 側のチームに SerDe ライブラリを導入してもらう必要がある。<br>SerDe は Java のライブラリとして提供されているため、application 側が Java 系の言語で開発されている必要がある。<br>ここに大きなハードルがあると感じた。<br>ちなみに KDS まわりであれば SDK や KPL 経由で使うことも可能である。</p><p>今回は application は Scala だったので、頼み込めば今回の案件については導入してもらうこともできたかもしれない。<br>ただ、うまくいけば今回の案件に限らず横展開したいと考えていたので、それを考えるとかなりハードルが高いという判断となった。</p><h3 id=json-schema-の折り合い>JSON Schema の折り合い<a hidden class=anchor aria-hidden=true href=#json-schema-の折り合い>#</a></h3><p>application とデータ基盤の間の schema 管理については data contract という考え方が出てきている。<br>それについて書かれたブログ記事 <a href=https://www.montecarlodata.com/data-contracts/>7 Lessons From GoCardless’ Implementation of Data Contracts</a> で</p><blockquote><p>For example, most teams didn’t want to use AVRO so we decided to use JSON as the interchange format for the contracts because it’s extensible.</p></blockquote><p>とあるように、Avro 形式を各 application チームに使ってもらうというのはまあまあハードルが高い。</p><p>Glue Schema Registry ではレコードの形式として Avro, Protobuf, JSON をサポートしている。<br>本来はできれば Avro や Protobuf のような、型がしっかりしている形式を使いたいところだが、このようなハードルがあり我々も JSON の仕様を前提に考えていた。<br>JSON の場合は <a href=https://json-schema.org/>JSON Schema</a> の仕様に従うことになる。</p><p>この JSON Schema、当たり前だが JSON の世界を表現するためのものとなっている。<br>何が言いたいかというと JSON の世界の型の表現と Hudi table を含めた DB 的な世界の型の表現とが一致しないのだ。<br>例えば<a href=https://json-schema.org/understanding-json-schema/reference/numeric.html>数値表現</a>を見てみると、JSON Schema においては <code>integer</code>, <code>number</code>, <code>Multiples</code>, <code>Range</code> の4つの型が定義されている。<br>一般的な整数型 short, int, long 等の違いを表現することができない。<br>Glue Schema Registry に登録された JSON Schema により Hudi の table の schema を自動更新したかったので、これは困ったぞ、となってしまった。</p><h3 id=互換性の運用の難しさ>互換性の運用の難しさ<a hidden class=anchor aria-hidden=true href=#互換性の運用の難しさ>#</a></h3><p>これはちょっと言葉にしにくいのだが、前方／後方互換性まわりの仕様が直感的に理解しにくかった。<br>どういったときにフィールド追加が許容されるのか、互換性の起点となる checkpoint はどういったときに更新されるのか、etc.<br>このあたりいろいろ調査すれば理解できると思うのだが、ここまでの課題もあり気持ちが折れてしまった。<br>また、チームとしてこれを踏まえた schema 更新を運用するのはハードルが高いと感じた。</p><h2 id=結局どうしたか>結局どうしたか<a hidden class=anchor aria-hidden=true href=#結局どうしたか>#</a></h2><p>Glue Schema Registry は使わず、では結局どうしたかというと application 側とデータ基盤側の間でシステム的に schema を共有することなく連携する形にした。</p><p><img loading=lazy src=/image/architecture/glue_schema_registry_architecture_reality.png alt="architecuture reality"></p><p>システム的に共有しないので、人が共有してやるしかない。<br>schema 変更する場合は次のようにチーム間で協調して進める。</p><ol><li>チーム間で認識合わせ</li><li>データ基盤チームによる Glue Data Catalog の schema の変更作業<ul><li>consumer に前方互換性があるという前提</li></ul></li><li>application チームによる application ログの schema の変更作業</li></ol><p>このあたりもっとうまくできる方法があるのではと考えている。<br>とりあえず data contract の発展に期待しておく。</p><h2 id=まとめ>まとめ<a hidden class=anchor aria-hidden=true href=#まとめ>#</a></h2><p>ストリーム処理における Glue Schema Registry の思想、考え方は正しいものであると感じる。<br>ただし、扱いが難しい面があり、今回のユースケースやそれを踏まえた横展開には合わないという判断となった。<br>チームやシステムをまたいだ schema 管理は簡単ではない。</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://soonraah.github.io/tags/aws/>AWS</a></li><li><a href=https://soonraah.github.io/tags/data-lake/>Data Lake</a></li><li><a href=https://soonraah.github.io/tags/apache-hudi/>Apache Hudi</a></li><li><a href=https://soonraah.github.io/tags/stream-processing/>stream processing</a></li></ul><nav class=paginav><a class=prev href=https://soonraah.github.io/posts/looked-into-data-contracts/><span class=title>« 前へ</span><br><span>Data Contract について調べた</span>
</a><a class=next href=https://soonraah.github.io/posts/data-lake-and-data-lake-layer/><span class=title>次へ »</span><br><span>「データレイク」と「データレイク層」</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Glue Schema Registry の導入を断念した話 on x" href="https://x.com/intent/tweet/?text=Glue%20Schema%20Registry%20%e3%81%ae%e5%b0%8e%e5%85%a5%e3%82%92%e6%96%ad%e5%bf%b5%e3%81%97%e3%81%9f%e8%a9%b1&amp;url=https%3a%2f%2fsoonraah.github.io%2fposts%2fgive-up-on-schema-registry%2f&amp;hashtags=AWS%2cDataLake%2cApacheHudi%2cstreamprocessing"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Glue Schema Registry の導入を断念した話 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fsoonraah.github.io%2fposts%2fgive-up-on-schema-registry%2f&amp;title=Glue%20Schema%20Registry%20%e3%81%ae%e5%b0%8e%e5%85%a5%e3%82%92%e6%96%ad%e5%bf%b5%e3%81%97%e3%81%9f%e8%a9%b1&amp;summary=Glue%20Schema%20Registry%20%e3%81%ae%e5%b0%8e%e5%85%a5%e3%82%92%e6%96%ad%e5%bf%b5%e3%81%97%e3%81%9f%e8%a9%b1&amp;source=https%3a%2f%2fsoonraah.github.io%2fposts%2fgive-up-on-schema-registry%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Glue Schema Registry の導入を断念した話 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fsoonraah.github.io%2fposts%2fgive-up-on-schema-registry%2f&title=Glue%20Schema%20Registry%20%e3%81%ae%e5%b0%8e%e5%85%a5%e3%82%92%e6%96%ad%e5%bf%b5%e3%81%97%e3%81%9f%e8%a9%b1"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Glue Schema Registry の導入を断念した話 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fsoonraah.github.io%2fposts%2fgive-up-on-schema-registry%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Glue Schema Registry の導入を断念した話 on whatsapp" href="https://api.whatsapp.com/send?text=Glue%20Schema%20Registry%20%e3%81%ae%e5%b0%8e%e5%85%a5%e3%82%92%e6%96%ad%e5%bf%b5%e3%81%97%e3%81%9f%e8%a9%b1%20-%20https%3a%2f%2fsoonraah.github.io%2fposts%2fgive-up-on-schema-registry%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Glue Schema Registry の導入を断念した話 on telegram" href="https://telegram.me/share/url?text=Glue%20Schema%20Registry%20%e3%81%ae%e5%b0%8e%e5%85%a5%e3%82%92%e6%96%ad%e5%bf%b5%e3%81%97%e3%81%9f%e8%a9%b1&amp;url=https%3a%2f%2fsoonraah.github.io%2fposts%2fgive-up-on-schema-registry%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Glue Schema Registry の導入を断念した話 on ycombinator" href="https://news.ycombinator.com/submitlink?t=Glue%20Schema%20Registry%20%e3%81%ae%e5%b0%8e%e5%85%a5%e3%82%92%e6%96%ad%e5%bf%b5%e3%81%97%e3%81%9f%e8%a9%b1&u=https%3a%2f%2fsoonraah.github.io%2fposts%2fgive-up-on-schema-registry%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://soonraah.github.io>Froglog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="コピー";function s(){t.innerHTML="コピーされました!",setTimeout(()=>{t.innerHTML="コピー"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>