<!doctype html><html lang=ja dir=auto><head><script async src="https://www.googletagmanager.com/gtag/js?id=G-NSEGH2YT17"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-NSEGH2YT17")</script><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Data Contract CLI から考える Data Contracts ファーストのデータパイプラインの未来 | Froglog</title>
<meta name=keywords content="data contracts"><meta name=description content="このポストについて
Data Contract CLI を触ってみたところ、面白かったのとこれからのデータパイプライン開発について思うところがあったので書いてみる。
Data Contract CLI とは？
datacontract/datacontract-cli
Data Contract CLI は data contracts を運用するためのオープンソースのコマンドラインツールである。
data contracts の概念については以前の記事で詳しく書いているのでそちらをご参考いただければと。
ただしこちらの記事は1年前のものであり、今回取り上げる Data Contract CLI の登場などを含めて現在では data contracts を取り巻く状況も変わっている可能性があることに注意。
Data Contract CLI は Python で開発されており、pip でインストールすることができる。
この記事を書いている時点では v0.10.3 が最新であり、この記事の内容はこのバージョンに基づいている。
Data Contract CLI で扱う data contracts は YAML で定義される前提となっており、その仕様は datacontract/datacontract-specification で決められている。
この data contracts に対して Data Contract CLI では次のようなことが行える。

lint によるフォーマットチェック
データソースに接続した上での schema やデータ品質のテスト
data contracts の破壊的な変更の検出
JSON Schema や dbt など、他の形式からの／へのインポートとエクスポート

以下の図がイメージしやすい。"><meta name=author content="soonraah"><link rel=canonical href=https://soonraah.github.io/posts/data-contract-cli/><meta name=google-site-verification content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.d6fcd20a4fb86efa4dfac8ec95da60244cc8871042183da1ef28e3a762ad79c8.css integrity="sha256-1vzSCk+4bvpN+sjsldpgJEzIhxBCGD2h7yjjp2Ktecg=" rel="preload stylesheet" as=style><link rel=icon href=https://soonraah.github.io/favicon2.ico><link rel=icon type=image/png sizes=16x16 href=https://soonraah.github.io/image/favicon/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://soonraah.github.io/image/favicon/favicon-32x32.png><link rel=apple-touch-icon href=https://soonraah.github.io/static/image/favicon/apple-touch-icon.png><link rel=mask-icon href=https://soonraah.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=ja href=https://soonraah.github.io/posts/data-contract-cli/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://soonraah.github.io/posts/data-contract-cli/"><meta property="og:site_name" content="Froglog"><meta property="og:title" content="Data Contract CLI から考える Data Contracts ファーストのデータパイプラインの未来"><meta property="og:description" content="このポストについて Data Contract CLI を触ってみたところ、面白かったのとこれからのデータパイプライン開発について思うところがあったので書いてみる。
Data Contract CLI とは？ datacontract/datacontract-cli
Data Contract CLI は data contracts を運用するためのオープンソースのコマンドラインツールである。
data contracts の概念については以前の記事で詳しく書いているのでそちらをご参考いただければと。
ただしこちらの記事は1年前のものであり、今回取り上げる Data Contract CLI の登場などを含めて現在では data contracts を取り巻く状況も変わっている可能性があることに注意。
Data Contract CLI は Python で開発されており、pip でインストールすることができる。
この記事を書いている時点では v0.10.3 が最新であり、この記事の内容はこのバージョンに基づいている。
Data Contract CLI で扱う data contracts は YAML で定義される前提となっており、その仕様は datacontract/datacontract-specification で決められている。
この data contracts に対して Data Contract CLI では次のようなことが行える。
lint によるフォーマットチェック データソースに接続した上での schema やデータ品質のテスト data contracts の破壊的な変更の検出 JSON Schema や dbt など、他の形式からの／へのインポートとエクスポート 以下の図がイメージしやすい。"><meta property="og:locale" content="ja"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-05-09T22:30:00+09:00"><meta property="article:modified_time" content="2024-05-09T22:30:00+09:00"><meta property="article:tag" content="Data Contracts"><meta property="og:image" content="https://soonraah.github.io/image/dalle/data_contracts.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://soonraah.github.io/image/dalle/data_contracts.jpg"><meta name=twitter:title content="Data Contract CLI から考える Data Contracts ファーストのデータパイプラインの未来"><meta name=twitter:description content="このポストについて
Data Contract CLI を触ってみたところ、面白かったのとこれからのデータパイプライン開発について思うところがあったので書いてみる。
Data Contract CLI とは？
datacontract/datacontract-cli
Data Contract CLI は data contracts を運用するためのオープンソースのコマンドラインツールである。
data contracts の概念については以前の記事で詳しく書いているのでそちらをご参考いただければと。
ただしこちらの記事は1年前のものであり、今回取り上げる Data Contract CLI の登場などを含めて現在では data contracts を取り巻く状況も変わっている可能性があることに注意。
Data Contract CLI は Python で開発されており、pip でインストールすることができる。
この記事を書いている時点では v0.10.3 が最新であり、この記事の内容はこのバージョンに基づいている。
Data Contract CLI で扱う data contracts は YAML で定義される前提となっており、その仕様は datacontract/datacontract-specification で決められている。
この data contracts に対して Data Contract CLI では次のようなことが行える。

lint によるフォーマットチェック
データソースに接続した上での schema やデータ品質のテスト
data contracts の破壊的な変更の検出
JSON Schema や dbt など、他の形式からの／へのインポートとエクスポート

以下の図がイメージしやすい。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://soonraah.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Data Contract CLI から考える Data Contracts ファーストのデータパイプラインの未来","item":"https://soonraah.github.io/posts/data-contract-cli/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Data Contract CLI から考える Data Contracts ファーストのデータパイプラインの未来","name":"Data Contract CLI から考える Data Contracts ファーストのデータパイプラインの未来","description":"このポストについて Data Contract CLI を触ってみたところ、面白かったのとこれからのデータパイプライン開発について思うところがあったので書いてみる。\nData Contract CLI とは？ datacontract/datacontract-cli\nData Contract CLI は data contracts を運用するためのオープンソースのコマンドラインツールである。\ndata contracts の概念については以前の記事で詳しく書いているのでそちらをご参考いただければと。\nただしこちらの記事は1年前のものであり、今回取り上げる Data Contract CLI の登場などを含めて現在では data contracts を取り巻く状況も変わっている可能性があることに注意。\nData Contract CLI は Python で開発されており、pip でインストールすることができる。\nこの記事を書いている時点では v0.10.3 が最新であり、この記事の内容はこのバージョンに基づいている。\nData Contract CLI で扱う data contracts は YAML で定義される前提となっており、その仕様は datacontract/datacontract-specification で決められている。\nこの data contracts に対して Data Contract CLI では次のようなことが行える。\nlint によるフォーマットチェック データソースに接続した上での schema やデータ品質のテスト data contracts の破壊的な変更の検出 JSON Schema や dbt など、他の形式からの／へのインポートとエクスポート 以下の図がイメージしやすい。\n","keywords":["data contracts"],"articleBody":"このポストについて Data Contract CLI を触ってみたところ、面白かったのとこれからのデータパイプライン開発について思うところがあったので書いてみる。\nData Contract CLI とは？ datacontract/datacontract-cli\nData Contract CLI は data contracts を運用するためのオープンソースのコマンドラインツールである。\ndata contracts の概念については以前の記事で詳しく書いているのでそちらをご参考いただければと。\nただしこちらの記事は1年前のものであり、今回取り上げる Data Contract CLI の登場などを含めて現在では data contracts を取り巻く状況も変わっている可能性があることに注意。\nData Contract CLI は Python で開発されており、pip でインストールすることができる。\nこの記事を書いている時点では v0.10.3 が最新であり、この記事の内容はこのバージョンに基づいている。\nData Contract CLI で扱う data contracts は YAML で定義される前提となっており、その仕様は datacontract/datacontract-specification で決められている。\nこの data contracts に対して Data Contract CLI では次のようなことが行える。\nlint によるフォーマットチェック データソースに接続した上での schema やデータ品質のテスト data contracts の破壊的な変更の検出 JSON Schema や dbt など、他の形式からの／へのインポートとエクスポート 以下の図がイメージしやすい。\ndatacontract/datacontract-cli より\nData Contract CLI の開発者が何を考えているか、この図から推測できる部分があるので後ほど考察したい。\nData Contract CLI を使ってみる 前提 手元に個人開発用の BigQuery の table があったので、これについて data contract を用意して Data Contract CLI を使ってみることにした。\n個人の MoneyForward の情報を取り込んでいる table であり、収支詳細のカテゴリを扱う table である。\ndata contract (YAML ファイル) の作成は基本的には best practice に従う。\ndata contract の作成後は export や変更の検出などを試してみる。\n準備 今回は Poetry で Python 環境を用意した。\ndatacontract-cli および BigQuery を扱うのに必要となる google-cloud-bigquery-storage を install しておく。\n[tool.poetry.dependencies] python = \"^3.10\" datacontract-cli = \"^0.10.3\" google-cloud-bigquery-storage = \"^2.24.0\" バージョンを確認。\n$ datacontract --version 0.10.3 DDL からの import して data contract を作成 まず data contract を用意する必要がある。\ndata contract は YAML ファイルなので仕様を見ながら一から書くこともできるが、既存の table などがある場合は import を使うことができる。\nちなみに v0.10.3 の時点で対応している import のソースは sql, avro, glue の3つ。\nBigQuery では INFORMATION_SCHEMA.TABLES から既存 table の DDL を得ることができるため、それを利用して money_forward_main_group.sql を用意した。\nCREATE TABLE `\u003cPROJECT_ID\u003e.\u003cDATASET_ID\u003e.money_forward_main_group` ( mf_main_group_id INT64, name STRING, is_income BOOL ); この DDL ファイルを使って import サブコマンドにより data contract を作成する。\n$ datacontract import --format sql --source money_forward_main_group.sql \u003e datacontract_v1.yml 作成された datacontract_v1.yml の中は次のようになっている。\ndataContractSpecification: 0.9.3 id: my-data-contract-id info: title: My Data Contract version: 0.0.1 models: money_forward_main_group`: type: table fields: mf_main_group_id: type: integer name: type: string is_income: type: boolean この時点で一度 lint サブコマンドでフォーマットチェックしておく。\ndatacontract lint datacontract_v1.yml WARNING:root:Data Contract YAML is invalid. Validation error: data.models must be named by propertyName definition ERROR:root:Run operation failed: [lint] Check that data contract YAML is valid - None - failed - data.models must be named by propertyName definition - datacontract ╭────────┬────────────────────────────────────────┬───────┬────────────────────────────────────────────────────╮ │ Result │ Check │ Field │ Details │ ├────────┼────────────────────────────────────────┼───────┼────────────────────────────────────────────────────┤ │ failed │ Check that data contract YAML is valid │ │ data.models must be named by propertyName │ │ │ │ │ definition │ ╰────────┴────────────────────────────────────────┴───────┴────────────────────────────────────────────────────╯ 🔴 data contract is invalid, found the following errors: 1) data.models must be named by propertyName definition エラーになってしまった。\n実はこの時点で datacontract_v1.yml にいくつか問題があり、修正することに。\n不要な “`” が含まれている servers ブロックがない (確かに DDL を与えるだけだと BigQuery なのか Snowflake なのかわからんな…) 次のように修正して datacontract_v2.yml を作った。\n@@ -3,8 +3,13 @@ info: title: My Data Contract version: 0.0.1 +servers: + dev: + type: bigquery + project: + dataset: models: - money_forward_main_group`: + money_forward_main_group: type: table fields: mf_main_group_id: 再度 lint サブコマンドを実行すると成功した。\nただし description がない旨の warning が出ている。\ntable や column の description や制約事項を追加して datacontract_v3.yml とする。\n@@ -3,6 +3,9 @@ info: title: My Data Contract version: 0.0.1 + description: | + MoneyForward の収支における分類 (項目)。 + ダウンロードできる収支詳細に記載される情報を元に作成されている。 servers: dev: type: bigquery @@ -11,10 +14,18 @@ models: money_forward_main_group: type: table + description: MoneyForward の収支における大項目 fields: mf_main_group_id: + description: 大項目 ID type: integer + required: true + primary: true + unique: true name: + description: 大項目の項目名 type: string + required: true is_income: + description: 大項目が収入の場合は true, 支出の場合は false type: boolean lint サブコマンドが成功するようになった。\n$ datacontract lint datacontract_v3.yml ╭────────┬──────────────────────────────────────────┬───────┬─────────╮ │ Result │ Check │ Field │ Details │ ├────────┼──────────────────────────────────────────┼───────┼─────────┤ │ passed │ Data contract is syntactically valid │ │ │ │ passed │ Linter 'Field pattern is correct regex' │ │ │ │ passed │ Linter 'Objects have descriptions' │ │ │ │ passed │ Linter 'Field references existing field' │ │ │ │ passed │ Linter 'Example(s) match model' │ │ │ │ passed │ Linter 'Fields use valid constraints' │ │ │ │ passed │ Linter 'Quality check(s) use model' │ │ │ │ passed │ Linter 'noticePeriod in ISO8601 format' │ │ │ ╰────────┴──────────────────────────────────────────┴───────┴─────────╯ 🟢 data contract is valid. Run 8 checks. Took 0.304237 seconds. 初回テスト 次に test サブコマンドでテストを実行する。\nちなみに test では BiqQuery にアクセスするため、環境変数 DATACONTRACT_BIGQUERY_ACCOUNT_INFO_JSON_PATH に認証情報の JSON ファイルを指定しておく必要がある。\n$ datacontract test datacontract_v3.yml Testing datacontract_v3.yml Column,Event,Details is_income,:icon-fail: Type Mismatch, Expected Type: boolean; Actual Type: BOOL Type Mismatch, Expected Type: boolean; Actual Type: BOOL ╭────────┬──────────────────────────────────────────────────────────────────┬──────────────────┬────────────────────────────────────────────────────╮ │ Result │ Check │ Field │ Details │ ├────────┼──────────────────────────────────────────────────────────────────┼──────────────────┼────────────────────────────────────────────────────┤ │ passed │ Check that field mf_main_group_id is present │ │ │ │ passed │ Check that field mf_main_group_id has type integer │ │ │ │ passed │ Check that field name is present │ │ │ │ passed │ Check that field name has type string │ │ │ │ passed │ Check that field is_income is present │ │ │ │ failed │ Check that field is_income has type boolean │ │ Type Mismatch, Expected Type: boolean; Actual │ │ │ │ │ Type: BOOL │ │ passed │ Check that required field mf_main_group_id has no null values │ mf_main_group_id │ │ │ passed │ Check that unique field mf_main_group_id has no duplicate values │ mf_main_group_id │ │ │ passed │ Check that required field name has no null values │ name │ │ ╰────────┴──────────────────────────────────────────────────────────────────┴──────────────────┴────────────────────────────────────────────────────╯ 🔴 data contract is invalid, found the following errors: 1) Type Mismatch, Expected Type: boolean; Actual Type: BOOL エラーになってしまった。\ncolumn is_income の型が boolean ではなく BOOL だと言われている。\n確かに BiqQuery としての型は BOOL であるが、一方で data contracts の仕様としては boolean しか指定できない。\nバグっぽいのでいったん is_income の型指定をはずしておく…\n出力された内容を見るとどういったことがチェックされているかがわかる。\nこの時点では column の存在および型がチェックされていて、さらに制約事項を記載した column についてはその制約を満たしているかがチェックされている。\nデータ例の追加 次に data contract に examples ブロックを追加する。\n名前のとおりでデータの例を記載することができる。\nまず data contract を宣言して開発することを考えると、例が示されているのはとても助かる。\n次のように修正して datacontract_v4.yml を作った。\n@@ -28,4 +28,14 @@ required: true is_income: description: 大項目が収入の場合は true, 支出の場合は false - type: boolean + # type mismatch になるバグ？があるため boolean 型のチェックは除外 + # type: boolean +examples: + - type: csv + description: money_forward_main_group のレコードの例。 + model: money_forward_main_group + data: | + mf_main_group_id,name,is_income + 1,\"収入\",true + 2,\"食費\",false + 3,\"日用品\",false オプション --examples をつけて test サブコマンドを実行すると、examples ブロックに追加したデータに対してテストを行うことができる。\n$ datacontract test --examples datacontract_v4.yml Testing datacontract_v4.yml ╭────────┬──────────────────────────────────────────────────────────────────┬──────────────────┬─────────╮ │ Result │ Check │ Field │ Details │ ├────────┼──────────────────────────────────────────────────────────────────┼──────────────────┼─────────┤ │ passed │ Check that field mf_main_group_id is present │ │ │ │ passed │ Check that field name is present │ │ │ │ passed │ Check that field is_income is present │ │ │ │ passed │ Check that required field mf_main_group_id has no null values │ mf_main_group_id │ │ │ passed │ Check that unique field mf_main_group_id has no duplicate values │ mf_main_group_id │ │ │ passed │ Check that required field name has no null values │ name │ │ ╰────────┴──────────────────────────────────────────────────────────────────┴──────────────────┴─────────╯ 🟢 data contract is valid. Run 6 checks. Took 0.232013 seconds. データ品質チェックの追加 quality ブロックを追加してデータ品質チェックを行うことができる。\nv0.10.3 の時点では SodaCL, Monte Carlo, greate expectation の記法で品質チェックを書くことができる。\nここでは SodaCL の記法で table の行数が1件以上あることを確認する簡単なチェックを追加して datacontract_v5.yml とする。\n@@ -39,3 +39,8 @@ 1,\"収入\",true 2,\"食費\",false 3,\"日用品\",false +quality: + type: SodaCL + specification: + checks for money_forward_main_group: + - row_count \u003e 0 examples と BigQuery それぞれに対して test サブコマンドを実行。\n$ datacontract test --examples datacontract_v5.yml Testing datacontract_v5.yml ╭────────┬──────────────────────────────────────────────────────────────────┬──────────────────┬─────────╮ │ Result │ Check │ Field │ Details │ ├────────┼──────────────────────────────────────────────────────────────────┼──────────────────┼─────────┤ │ passed │ Check that field mf_main_group_id is present │ │ │ │ passed │ Check that field name is present │ │ │ │ passed │ Check that field is_income is present │ │ │ │ passed │ row_count \u003e 0 │ │ │ │ passed │ Check that required field mf_main_group_id has no null values │ mf_main_group_id │ │ │ passed │ Check that unique field mf_main_group_id has no duplicate values │ mf_main_group_id │ │ │ passed │ Check that required field name has no null values │ name │ │ ╰────────┴──────────────────────────────────────────────────────────────────┴──────────────────┴─────────╯ 🟢 data contract is valid. Run 7 checks. Took 0.48302 seconds. $ datacontract test datacontract_v5.yml Testing datacontract_v5.yml ╭────────┬──────────────────────────────────────────────────────────────────┬──────────────────┬─────────╮ │ Result │ Check │ Field │ Details │ ├────────┼──────────────────────────────────────────────────────────────────┼──────────────────┼─────────┤ │ passed │ Check that field mf_main_group_id is present │ │ │ │ passed │ Check that field mf_main_group_id has type integer │ │ │ │ passed │ Check that field name is present │ │ │ │ passed │ Check that field name has type string │ │ │ │ passed │ Check that field is_income is present │ │ │ │ passed │ row_count \u003e 0 │ │ │ │ passed │ Check that required field mf_main_group_id has no null values │ mf_main_group_id │ │ │ passed │ Check that unique field mf_main_group_id has no duplicate values │ mf_main_group_id │ │ │ passed │ Check that required field name has no null values │ name │ │ ╰────────┴──────────────────────────────────────────────────────────────────┴──────────────────┴─────────╯ 🟢 data contract is valid. Run 9 checks. Took 5.690055 seconds. 行数 (row_count) のチェックが増えていることが確認できる。\nここまでのところで data contract (YAML) はいったん完成とする。\nこの時点での全体像を記載しておく。\ndataContractSpecification: 0.9.3 id: my-data-contract-id info: title: My Data Contract version: 0.0.1 description: | MoneyForward の収支における分類 (項目)。 ダウンロードできる収支詳細に記載される情報を元に作成されている。 servers: dev: type: bigquery project: dataset: models: money_forward_main_group: type: table description: MoneyForward の収支における大項目 fields: mf_main_group_id: description: 大項目 ID type: integer required: true primary: true unique: true name: description: 大項目の項目名 type: string required: true is_income: description: 大項目が収入の場合は true, 支出の場合は false # type mismatch になるバグ？があるため boolean 型のチェックは除外 # type: boolean examples: - type: csv description: money_forward_main_group のレコードの例。 model: money_forward_main_group data: | mf_main_group_id,name,is_income 1,\"収入\",true 2,\"食費\",false 3,\"日用品\",false quality: type: SodaCL specification: checks for money_forward_main_group: - row_count \u003e 0 ここで作った data contract はフルの記載ではない。\n例えば servicelevels ブロックを追加して SLA を記載することもできる。\ndata contract のすべての仕様を知りたい場合は仕様ドキュメントを参照のこと。\nexport を試す JSON Schema data contract ができたところで export を試していきたい。\nv0.10.3 では14種類のフォーマットに対しての export がサポートされており、ここではそのうちのいくつかを使ってみる。\nまずは JSON Schema で出力してみる。\n$ datacontract export --format jsonschema datacontract_v5.yml { \"$schema\": \"http://json-schema.org/draft-07/schema#\", \"type\": \"object\", \"properties\": { \"mf_main_group_id\": { \"type\": \"integer\", \"unique\": true }, \"name\": { \"type\": \"string\" }, \"is_income\": {} }, \"required\": [ \"mf_main_group_id\", \"name\" ] } JSON Schema の記法でモデルが表現されたものが標準出力された。\n同様に Avro, Protobuf などの形式でも export することができる。\nデータ基盤的な話をすると、取り込みの対象であるアプリケーション (data provider) から送られてくるログは JSON 形式になっていることがよくある。\ndata contract をアプリケーション側とデータ基盤側で合意しておけば、アプリケーション側でログ生成時に JSON Schema でログに validation をかけることができる。\nこれによりログの schema の意図しない変更を防ぐ運用が可能になるだろう。\ndbt dbt の形式で export することもできる。\ndbt の YAML ドキュメントを出力してみる。\n$ datacontract export --format dbt --server bigquery datacontract_v5.yml version: 2 models: - name: money_forward_main_group config: meta: data_contract: my-data-contract-id materialized: table contract: enforced: true description: MoneyForward の収支における大項目 columns: - data_type: NUMBER description: 大項目 ID constraints: - type: not_null - type: unique name: mf_main_group_id - data_type: STRING description: 大項目の項目名 constraints: - type: not_null name: name - description: 大項目が収入の場合は true, 支出の場合は false name: is_income data_type が微妙で BigQuery の型定義になっていない。\n--server bigquery を与えているので配慮してほしいところではある。\nsources 用のドキュメントの形式でも export できる。\n$ datacontract export --format dbt-sources --server bigquery datacontract_v5.yml version: 2 sources: - name: my-data-contract-id tables: - name: money_forward_main_group description: MoneyForward の収支における大項目 columns: - tests: - dbt_expectations.dbt_expectations.expect_column_values_to_be_of_type: column_type: NUMBER - not_null - unique description: 大項目 ID name: mf_main_group_id - tests: - dbt_expectations.dbt_expectations.expect_column_values_to_be_of_type: column_type: STRING - not_null description: 大項目の項目名 name: name - description: 大項目が収入の場合は true, 支出の場合は false name: is_income description: 'MoneyForward の収支における分類 (項目)。 ダウンロードできる収支詳細に記載される情報を元に作成されている。 ' staging 用の SQL の形式の export もある。\n$ datacontract export --format dbt-staging-sql --server bigquery datacontract_v5.yml select mf_main_group_id, name, is_income from {{ source('my-data-contract-id', 'money_forward_main_group') }} このようにいくつかの dbt の形式で出力できるが、微妙な部分があるのでこのまま data contract を SSoT として dbt のファイルを CI で自動生成するという運用は現時点では難しいだろう。\nまたリッチなテストなども表現できないため、dbt をがっつり使っているチームには物足りなさがあると思われる。\ndata contract をまず作り、それをもとに dbt モデルを構築していくときのベースを作る用途なら現時点でもありかもしれない。\nHTML HTML 形式で export することもできる。\nホスティングして data contract を web で見せられるようにすることもできるだろう。\n$ datacontract export --format html datacontract_v5.yml \u003e money_forward_main_group.html HTML での export 例\n頑張ればこれで data catalog を作ることもできそう。\nまた今回の data contract には含まれていないが、前述の servicelevels ブロックがあれば web 上で SLA を示せたりできて良さそうだ。\n考察 Data Contract CLI で何ができるかがわかったところで最初の図を再掲。\ndatacontract/datacontract-cli より\nこの図から Data Contract CLI としては data contracts ファーストな運用を考えていることがわかる。\nまず data provider と data consumer の合意のもとに宣言的に data contracts を作成する。\nそれに基づき、それぞれ data provider と data consumer で使われるツール用に data contracts から必要なファイルを自動生成していく。\n例えば data provider である application 向けにはログの validation 用に JSON Schema のファイルを作成する。\ndata consumer である DWH 向けには dbt のファイルを用意する、など。\nまた、data contract に記載の情報からデータに対してテストを実行することができる。\n簡単な column の制約から、SodaCL などを使ったより高度な品質チェックまで。\nデータについてのドキュメントも data contract から生成される。\nこのようにまず data contract ありきで、モデルのメタ情報としてはそれを SSoT とし、data provider / consumer で必要なファイルを CI で自動生成するという未来が見えてくるような気がする。\nただしその未来を実現するための課題も現状では多い。\nData Contract CLI の相互運用性 (interoperatbility) が最も大きなボトルネックになるだろう。\n例えば想定する dbt ドキュメントが一発で作れるか、package を使ったリッチなテストが書けるか、etc.\nそもそも前述したようにバグっぽい挙動や微妙な挙動もあり、このツール自体がまだ発展途上という感がある。\nこれから普及していくかというのは今のところ何とも言えない。\nちなみに作者の1人は Data Mesh Manager というサービスの制作者であり、(ここまでのところでは触れていなかったが) Data Contract CLI にはこの Data Mesh Manager との連携機能が組み込まれている。\ndata contract ファーストの世界のビジョンはとても面白いと思ったので、いい方向でツールが発展していくとうれしい。\n","wordCount":"1841","inLanguage":"ja","image":"https://soonraah.github.io/image/dalle/data_contracts.jpg","datePublished":"2024-05-09T22:30:00+09:00","dateModified":"2024-05-09T22:30:00+09:00","author":{"@type":"Person","name":"soonraah"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://soonraah.github.io/posts/data-contract-cli/"},"publisher":{"@type":"Organization","name":"Froglog","logo":{"@type":"ImageObject","url":"https://soonraah.github.io/favicon2.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://soonraah.github.io/ accesskey=h title="Home (Alt + H)"><img src=https://soonraah.github.io/image/brand/favicon.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://soonraah.github.io/about/ title=About><span>About</span></a></li><li><a href=https://soonraah.github.io/posts/ title=Posts><span>Posts</span></a></li><li><a href=https://soonraah.github.io/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://soonraah.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://soonraah.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://soonraah.github.io/>ホーム</a>&nbsp;»&nbsp;<a href=https://soonraah.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Data Contract CLI から考える Data Contracts ファーストのデータパイプラインの未来</h1><div class=post-meta><span title='2024-05-09 22:30:00 +0900 JST'>5月 9, 2024</span>&nbsp;·&nbsp;soonraah</div></header><figure class=entry-cover><img loading=eager src=https://soonraah.github.io/image/dalle/data_contracts.jpg alt="data contracts"><p>Image by OpenAI DALL·E</p></figure><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>目次</span></summary><div class=inner><ul><li><a href=#%e3%81%93%e3%81%ae%e3%83%9d%e3%82%b9%e3%83%88%e3%81%ab%e3%81%a4%e3%81%84%e3%81%a6 aria-label=このポストについて>このポストについて</a></li><li><a href=#data-contract-cli-%e3%81%a8%e3%81%af aria-label="Data Contract CLI とは？">Data Contract CLI とは？</a></li><li><a href=#data-contract-cli-%e3%82%92%e4%bd%bf%e3%81%a3%e3%81%a6%e3%81%bf%e3%82%8b aria-label="Data Contract CLI を使ってみる">Data Contract CLI を使ってみる</a><ul><li><a href=#%e5%89%8d%e6%8f%90 aria-label=前提>前提</a></li><li><a href=#%e6%ba%96%e5%82%99 aria-label=準備>準備</a></li><li><a href=#ddl-%e3%81%8b%e3%82%89%e3%81%ae-import-%e3%81%97%e3%81%a6-data-contract-%e3%82%92%e4%bd%9c%e6%88%90 aria-label="DDL からの import して data contract を作成">DDL からの import して data contract を作成</a></li><li><a href=#%e5%88%9d%e5%9b%9e%e3%83%86%e3%82%b9%e3%83%88 aria-label=初回テスト>初回テスト</a></li><li><a href=#%e3%83%87%e3%83%bc%e3%82%bf%e4%be%8b%e3%81%ae%e8%bf%bd%e5%8a%a0 aria-label=データ例の追加>データ例の追加</a></li><li><a href=#%e3%83%87%e3%83%bc%e3%82%bf%e5%93%81%e8%b3%aa%e3%83%81%e3%82%a7%e3%83%83%e3%82%af%e3%81%ae%e8%bf%bd%e5%8a%a0 aria-label=データ品質チェックの追加>データ品質チェックの追加</a></li><li><a href=#export-%e3%82%92%e8%a9%a6%e3%81%99 aria-label="export を試す">export を試す</a><ul><li><a href=#json-schema aria-label="JSON Schema">JSON Schema</a></li><li><a href=#dbt aria-label=dbt>dbt</a></li><li><a href=#html aria-label=HTML>HTML</a></li></ul></li></ul></li><li><a href=#%e8%80%83%e5%af%9f aria-label=考察>考察</a></li></ul></div></details></div><div class=post-content><h2 id=このポストについて>このポストについて<a hidden class=anchor aria-hidden=true href=#このポストについて>#</a></h2><p>Data Contract CLI を触ってみたところ、面白かったのとこれからのデータパイプライン開発について思うところがあったので書いてみる。</p><h2 id=data-contract-cli-とは>Data Contract CLI とは？<a hidden class=anchor aria-hidden=true href=#data-contract-cli-とは>#</a></h2><p><a href=https://github.com/datacontract/datacontract-cli>datacontract/datacontract-cli</a></p><p>Data Contract CLI は data contracts を運用するためのオープンソースのコマンドラインツールである。</p><p>data contracts の概念については<a href=/posts/looked-into-data-contracts/>以前の記事</a>で詳しく書いているのでそちらをご参考いただければと。<br>ただしこちらの記事は1年前のものであり、今回取り上げる Data Contract CLI の登場などを含めて現在では data contracts を取り巻く状況も変わっている可能性があることに注意。</p><p>Data Contract CLI は Python で開発されており、pip でインストールすることができる。<br>この記事を書いている時点では v0.10.3 が最新であり、この記事の内容はこのバージョンに基づいている。</p><p>Data Contract CLI で扱う data contracts は YAML で定義される前提となっており、その仕様は <a href=https://github.com/datacontract/datacontract-specification>datacontract/datacontract-specification</a> で決められている。<br>この data contracts に対して Data Contract CLI では次のようなことが行える。</p><ul><li>lint によるフォーマットチェック</li><li>データソースに接続した上での schema やデータ品質のテスト</li><li>data contracts の破壊的な変更の検出</li><li>JSON Schema や dbt など、他の形式からの／へのインポートとエクスポート</li></ul><p>以下の図がイメージしやすい。</p><blockquote><figure class=align-center><img loading=lazy src=/image/data-contract-cli/datacontractcli.png#center alt="datacontract/datacontract-cli より"><figcaption><p><a href=https://github.com/datacontract/datacontract-cli/tree/v0.10.1>datacontract/datacontract-cli</a> より</p></figcaption></figure></blockquote><p>Data Contract CLI の開発者が何を考えているか、この図から推測できる部分があるので後ほど考察したい。</p><h2 id=data-contract-cli-を使ってみる>Data Contract CLI を使ってみる<a hidden class=anchor aria-hidden=true href=#data-contract-cli-を使ってみる>#</a></h2><h3 id=前提>前提<a hidden class=anchor aria-hidden=true href=#前提>#</a></h3><p>手元に個人開発用の BigQuery の table があったので、これについて data contract を用意して Data Contract CLI を使ってみることにした。<br>個人の MoneyForward の情報を取り込んでいる table であり、収支詳細のカテゴリを扱う table である。</p><p>data contract (YAML ファイル) の作成は基本的には <a href="https://github.com/datacontract/datacontract-cli/tree/v0.10.1?tab=readme-ov-file#best-practices">best practice</a> に従う。<br>data contract の作成後は export や変更の検出などを試してみる。</p><h3 id=準備>準備<a hidden class=anchor aria-hidden=true href=#準備>#</a></h3><p>今回は Poetry で Python 環境を用意した。<br><code>datacontract-cli</code> および BigQuery を扱うのに必要となる <code>google-cloud-bigquery-storage</code> を install しておく。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span>[<span style=color:#a6e22e>tool</span>.<span style=color:#a6e22e>poetry</span>.<span style=color:#a6e22e>dependencies</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>python</span> = <span style=color:#e6db74>&#34;^3.10&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>datacontract-cli</span> = <span style=color:#e6db74>&#34;^0.10.3&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>google-cloud-bigquery-storage</span> = <span style=color:#e6db74>&#34;^2.24.0&#34;</span>
</span></span></code></pre></div><p>バージョンを確認。</p><pre tabindex=0><code>$ datacontract --version
0.10.3
</code></pre><h3 id=ddl-からの-import-して-data-contract-を作成>DDL からの import して data contract を作成<a hidden class=anchor aria-hidden=true href=#ddl-からの-import-して-data-contract-を作成>#</a></h3><p>まず data contract を用意する必要がある。<br>data contract は YAML ファイルなので仕様を見ながら一から書くこともできるが、既存の table などがある場合は import を使うことができる。<br>ちなみに v0.10.3 の時点で対応している import のソースは <code>sql</code>, <code>avro</code>, <code>glue</code> の3つ。</p><p>BigQuery では <a href="https://cloud.google.com/bigquery/docs/information-schema-tables?hl=ja#tables_view"><code>INFORMATION_SCHEMA.TABLES</code></a> から既存 table の DDL を得ることができるため、それを利用して money_forward_main_group.sql を用意した。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#f92672>`&lt;</span>PROJECT_ID<span style=color:#f92672>&gt;</span>.<span style=color:#f92672>&lt;</span>DATASET_ID<span style=color:#f92672>&gt;</span>.money_forward_main_group<span style=color:#f92672>`</span>
</span></span><span style=display:flex><span>(
</span></span><span style=display:flex><span>  mf_main_group_id INT64,
</span></span><span style=display:flex><span>  name STRING,
</span></span><span style=display:flex><span>  is_income BOOL
</span></span><span style=display:flex><span>);
</span></span></code></pre></div><p>この DDL ファイルを使って import サブコマンドにより data contract を作成する。</p><pre tabindex=0><code>$ datacontract import --format sql --source money_forward_main_group.sql &gt; datacontract_v1.yml
</code></pre><p>作成された datacontract_v1.yml の中は次のようになっている。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>dataContractSpecification</span>: <span style=color:#ae81ff>0.9.3</span>
</span></span><span style=display:flex><span><span style=color:#f92672>id</span>: <span style=color:#ae81ff>my-data-contract-id</span>
</span></span><span style=display:flex><span><span style=color:#f92672>info</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>title</span>: <span style=color:#ae81ff>My Data Contract</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>version</span>: <span style=color:#ae81ff>0.0.1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>models</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>money_forward_main_group`</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>type</span>: <span style=color:#ae81ff>table</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>fields</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>mf_main_group_id</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>type</span>: <span style=color:#ae81ff>integer</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>type</span>: <span style=color:#ae81ff>string</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>is_income</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>type</span>: <span style=color:#ae81ff>boolean</span>
</span></span></code></pre></div><p>この時点で一度 <code>lint</code> サブコマンドでフォーマットチェックしておく。</p><pre tabindex=0><code>datacontract lint datacontract_v1.yml 
WARNING:root:Data Contract YAML is invalid. Validation error: data.models must be named by propertyName definition
ERROR:root:Run operation failed: [lint] Check that data contract YAML is valid - None - failed - data.models must be named by propertyName definition - datacontract
╭────────┬────────────────────────────────────────┬───────┬────────────────────────────────────────────────────╮
│ Result │ Check                                  │ Field │ Details                                            │
├────────┼────────────────────────────────────────┼───────┼────────────────────────────────────────────────────┤
│ failed │ Check that data contract YAML is valid │       │ data.models must be named by propertyName          │
│        │                                        │       │ definition                                         │
╰────────┴────────────────────────────────────────┴───────┴────────────────────────────────────────────────────╯
🔴 data contract is invalid, found the following errors:
1) data.models must be named by propertyName definition
</code></pre><p>エラーになってしまった。<br>実はこの時点で datacontract_v1.yml にいくつか問題があり、修正することに。</p><ul><li>不要な &ldquo;`&rdquo; が含まれている</li><li><code>servers</code> ブロックがない<ul><li>(確かに DDL を与えるだけだと BigQuery なのか Snowflake なのかわからんな…)</li></ul></li></ul><p>次のように修正して datacontract_v2.yml を作った。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span><span style=color:#75715e>@@ -3,8 +3,13 @@
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> info:
</span></span><span style=display:flex><span>   title: My Data Contract
</span></span><span style=display:flex><span>   version: 0.0.1
</span></span><span style=display:flex><span><span style=color:#a6e22e>+servers:
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+  dev:
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+    type: bigquery
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+    project: &lt;PROJECT_ID&gt;
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+    dataset: &lt;DATASET_ID&gt;
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span> models:
</span></span><span style=display:flex><span><span style=color:#f92672>-  money_forward_main_group`:
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+  money_forward_main_group:
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span>     type: table
</span></span><span style=display:flex><span>     fields:
</span></span><span style=display:flex><span>       mf_main_group_id:
</span></span></code></pre></div><p>再度 lint サブコマンドを実行すると成功した。<br>ただし description がない旨の warning が出ている。<br>table や column の description や制約事項を追加して datacontract_v3.yml とする。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span><span style=color:#75715e>@@ -3,6 +3,9 @@
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> info:
</span></span><span style=display:flex><span>   title: My Data Contract
</span></span><span style=display:flex><span>   version: 0.0.1
</span></span><span style=display:flex><span><span style=color:#a6e22e>+  description: |
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+    MoneyForward の収支における分類 (項目)。
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+    ダウンロードできる収支詳細に記載される情報を元に作成されている。
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span> servers:
</span></span><span style=display:flex><span>   dev:
</span></span><span style=display:flex><span>     type: bigquery
</span></span><span style=display:flex><span><span style=color:#75715e>@@ -11,10 +14,18 @@
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> models:
</span></span><span style=display:flex><span>   money_forward_main_group:
</span></span><span style=display:flex><span>     type: table
</span></span><span style=display:flex><span><span style=color:#a6e22e>+    description: MoneyForward の収支における大項目
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span>     fields:
</span></span><span style=display:flex><span>       mf_main_group_id:
</span></span><span style=display:flex><span><span style=color:#a6e22e>+        description: 大項目 ID
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span>         type: integer
</span></span><span style=display:flex><span><span style=color:#a6e22e>+        required: true
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+        primary: true
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+        unique: true
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span>       name:
</span></span><span style=display:flex><span><span style=color:#a6e22e>+        description: 大項目の項目名
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span>         type: string
</span></span><span style=display:flex><span><span style=color:#a6e22e>+        required: true
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span>       is_income:
</span></span><span style=display:flex><span><span style=color:#a6e22e>+        description: 大項目が収入の場合は true, 支出の場合は false
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span>         type: boolean
</span></span></code></pre></div><p><code>lint</code> サブコマンドが成功するようになった。</p><pre tabindex=0><code>$ datacontract lint datacontract_v3.yml          
╭────────┬──────────────────────────────────────────┬───────┬─────────╮
│ Result │ Check                                    │ Field │ Details │
├────────┼──────────────────────────────────────────┼───────┼─────────┤
│ passed │ Data contract is syntactically valid     │       │         │
│ passed │ Linter &#39;Field pattern is correct regex&#39;  │       │         │
│ passed │ Linter &#39;Objects have descriptions&#39;       │       │         │
│ passed │ Linter &#39;Field references existing field&#39; │       │         │
│ passed │ Linter &#39;Example(s) match model&#39;          │       │         │
│ passed │ Linter &#39;Fields use valid constraints&#39;    │       │         │
│ passed │ Linter &#39;Quality check(s) use model&#39;      │       │         │
│ passed │ Linter &#39;noticePeriod in ISO8601 format&#39;  │       │         │
╰────────┴──────────────────────────────────────────┴───────┴─────────╯
🟢 data contract is valid. Run 8 checks. Took 0.304237 seconds.
</code></pre><h3 id=初回テスト>初回テスト<a hidden class=anchor aria-hidden=true href=#初回テスト>#</a></h3><p>次に <code>test</code> サブコマンドでテストを実行する。<br>ちなみに <code>test</code> では BiqQuery にアクセスするため、環境変数 <code>DATACONTRACT_BIGQUERY_ACCOUNT_INFO_JSON_PATH</code> に認証情報の JSON ファイルを指定しておく必要がある。</p><pre tabindex=0><code>$ datacontract test datacontract_v3.yml
Testing datacontract_v3.yml
Column,Event,Details
is_income,:icon-fail: Type Mismatch, Expected Type: boolean; Actual Type: BOOL

Type Mismatch, Expected Type: boolean; Actual Type: BOOL
╭────────┬──────────────────────────────────────────────────────────────────┬──────────────────┬────────────────────────────────────────────────────╮
│ Result │ Check                                                            │ Field            │ Details                                            │
├────────┼──────────────────────────────────────────────────────────────────┼──────────────────┼────────────────────────────────────────────────────┤
│ passed │ Check that field mf_main_group_id is present                     │                  │                                                    │
│ passed │ Check that field mf_main_group_id has type integer               │                  │                                                    │
│ passed │ Check that field name is present                                 │                  │                                                    │
│ passed │ Check that field name has type string                            │                  │                                                    │
│ passed │ Check that field is_income is present                            │                  │                                                    │
│ failed │ Check that field is_income has type boolean                      │                  │ Type Mismatch, Expected Type: boolean; Actual      │
│        │                                                                  │                  │ Type: BOOL                                         │
│ passed │ Check that required field mf_main_group_id has no null values    │ mf_main_group_id │                                                    │
│ passed │ Check that unique field mf_main_group_id has no duplicate values │ mf_main_group_id │                                                    │
│ passed │ Check that required field name has no null values                │ name             │                                                    │
╰────────┴──────────────────────────────────────────────────────────────────┴──────────────────┴────────────────────────────────────────────────────╯
🔴 data contract is invalid, found the following errors:
1) Type Mismatch, Expected Type: boolean; Actual Type: BOOL
</code></pre><p>エラーになってしまった。<br>column <code>is_income</code> の型が <code>boolean</code> ではなく <code>BOOL</code> だと言われている。<br>確かに BiqQuery としての型は <code>BOOL</code> であるが、一方で data contracts の仕様としては <code>boolean</code> しか指定できない。<br>バグっぽいのでいったん <code>is_income</code> の型指定をはずしておく…</p><p>出力された内容を見るとどういったことがチェックされているかがわかる。<br>この時点では column の存在および型がチェックされていて、さらに制約事項を記載した column についてはその制約を満たしているかがチェックされている。</p><h3 id=データ例の追加>データ例の追加<a hidden class=anchor aria-hidden=true href=#データ例の追加>#</a></h3><p>次に data contract に <code>examples</code> ブロックを追加する。<br>名前のとおりでデータの例を記載することができる。<br>まず data contract を宣言して開発することを考えると、例が示されているのはとても助かる。</p><p>次のように修正して datacontract_v4.yml を作った。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span><span style=color:#75715e>@@ -28,4 +28,14 @@
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>         required: true
</span></span><span style=display:flex><span>       is_income:
</span></span><span style=display:flex><span>         description: 大項目が収入の場合は true, 支出の場合は false
</span></span><span style=display:flex><span><span style=color:#f92672>-        type: boolean
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+        # type mismatch になるバグ？があるため boolean 型のチェックは除外
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+        # type: boolean
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+examples:
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+  - type: csv
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+    description: money_forward_main_group のレコードの例。
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+    model: money_forward_main_group
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+    data: |
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+      mf_main_group_id,name,is_income
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+      1,&#34;収入&#34;,true
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+      2,&#34;食費&#34;,false
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+      3,&#34;日用品&#34;,false
</span></span></span></code></pre></div><p>オプション <code>--examples</code> をつけて <code>test</code> サブコマンドを実行すると、<code>examples</code> ブロックに追加したデータに対してテストを行うことができる。</p><pre tabindex=0><code>$ datacontract test --examples datacontract_v4.yml
Testing datacontract_v4.yml
╭────────┬──────────────────────────────────────────────────────────────────┬──────────────────┬─────────╮
│ Result │ Check                                                            │ Field            │ Details │
├────────┼──────────────────────────────────────────────────────────────────┼──────────────────┼─────────┤
│ passed │ Check that field mf_main_group_id is present                     │                  │         │
│ passed │ Check that field name is present                                 │                  │         │
│ passed │ Check that field is_income is present                            │                  │         │
│ passed │ Check that required field mf_main_group_id has no null values    │ mf_main_group_id │         │
│ passed │ Check that unique field mf_main_group_id has no duplicate values │ mf_main_group_id │         │
│ passed │ Check that required field name has no null values                │ name             │         │
╰────────┴──────────────────────────────────────────────────────────────────┴──────────────────┴─────────╯
🟢 data contract is valid. Run 6 checks. Took 0.232013 seconds.
</code></pre><h3 id=データ品質チェックの追加>データ品質チェックの追加<a hidden class=anchor aria-hidden=true href=#データ品質チェックの追加>#</a></h3><p><code>quality</code> ブロックを追加してデータ品質チェックを行うことができる。<br>v0.10.3 の時点では <a href=https://docs.soda.io/soda-cl/soda-cl-overview.html>SodaCL</a>, <a href=https://docs.getmontecarlo.com/docs/monitors-as-code>Monte Carlo</a>, <a href=https://greatexpectations.io/expectations/>greate expectation</a> の記法で品質チェックを書くことができる。</p><p>ここでは SodaCL の記法で table の行数が1件以上あることを確認する簡単なチェックを追加して datacontract_v5.yml とする。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span><span style=color:#75715e>@@ -39,3 +39,8 @@
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>       1,&#34;収入&#34;,true
</span></span><span style=display:flex><span>       2,&#34;食費&#34;,false
</span></span><span style=display:flex><span>       3,&#34;日用品&#34;,false
</span></span><span style=display:flex><span><span style=color:#a6e22e>+quality:
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+  type: SodaCL
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+  specification:
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+    checks for money_forward_main_group:
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+      - row_count &gt; 0
</span></span></span></code></pre></div><p><code>examples</code> と BigQuery それぞれに対して <code>test</code> サブコマンドを実行。</p><pre tabindex=0><code>$ datacontract test --examples datacontract_v5.yml
Testing datacontract_v5.yml
╭────────┬──────────────────────────────────────────────────────────────────┬──────────────────┬─────────╮
│ Result │ Check                                                            │ Field            │ Details │
├────────┼──────────────────────────────────────────────────────────────────┼──────────────────┼─────────┤
│ passed │ Check that field mf_main_group_id is present                     │                  │         │
│ passed │ Check that field name is present                                 │                  │         │
│ passed │ Check that field is_income is present                            │                  │         │
│ passed │ row_count &gt; 0                                                    │                  │         │
│ passed │ Check that required field mf_main_group_id has no null values    │ mf_main_group_id │         │
│ passed │ Check that unique field mf_main_group_id has no duplicate values │ mf_main_group_id │         │
│ passed │ Check that required field name has no null values                │ name             │         │
╰────────┴──────────────────────────────────────────────────────────────────┴──────────────────┴─────────╯
🟢 data contract is valid. Run 7 checks. Took 0.48302 seconds.
</code></pre><pre tabindex=0><code>$ datacontract test datacontract_v5.yml  
Testing datacontract_v5.yml
╭────────┬──────────────────────────────────────────────────────────────────┬──────────────────┬─────────╮
│ Result │ Check                                                            │ Field            │ Details │
├────────┼──────────────────────────────────────────────────────────────────┼──────────────────┼─────────┤
│ passed │ Check that field mf_main_group_id is present                     │                  │         │
│ passed │ Check that field mf_main_group_id has type integer               │                  │         │
│ passed │ Check that field name is present                                 │                  │         │
│ passed │ Check that field name has type string                            │                  │         │
│ passed │ Check that field is_income is present                            │                  │         │
│ passed │ row_count &gt; 0                                                    │                  │         │
│ passed │ Check that required field mf_main_group_id has no null values    │ mf_main_group_id │         │
│ passed │ Check that unique field mf_main_group_id has no duplicate values │ mf_main_group_id │         │
│ passed │ Check that required field name has no null values                │ name             │         │
╰────────┴──────────────────────────────────────────────────────────────────┴──────────────────┴─────────╯
🟢 data contract is valid. Run 9 checks. Took 5.690055 seconds.
</code></pre><p>行数 (row_count) のチェックが増えていることが確認できる。</p><p>ここまでのところで data contract (YAML) はいったん完成とする。<br>この時点での全体像を記載しておく。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>dataContractSpecification</span>: <span style=color:#ae81ff>0.9.3</span>
</span></span><span style=display:flex><span><span style=color:#f92672>id</span>: <span style=color:#ae81ff>my-data-contract-id</span>
</span></span><span style=display:flex><span><span style=color:#f92672>info</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>title</span>: <span style=color:#ae81ff>My Data Contract</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>version</span>: <span style=color:#ae81ff>0.0.1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>description</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    MoneyForward の収支における分類 (項目)。
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    ダウンロードできる収支詳細に記載される情報を元に作成されている。</span>
</span></span><span style=display:flex><span><span style=color:#f92672>servers</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>dev</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>type</span>: <span style=color:#ae81ff>bigquery</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>project</span>: <span style=color:#ae81ff>&lt;PROJECT_ID&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>dataset</span>: <span style=color:#ae81ff>&lt;DATASET_ID&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>models</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>money_forward_main_group</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>type</span>: <span style=color:#ae81ff>table</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>description</span>: <span style=color:#ae81ff>MoneyForward の収支における大項目</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>fields</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>mf_main_group_id</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>description</span>: <span style=color:#ae81ff>大項目 ID</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>type</span>: <span style=color:#ae81ff>integer</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>required</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>primary</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>unique</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>description</span>: <span style=color:#ae81ff>大項目の項目名</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>type</span>: <span style=color:#ae81ff>string</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>required</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>is_income</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>description</span>: <span style=color:#ae81ff>大項目が収入の場合は true, 支出の場合は false</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># type mismatch になるバグ？があるため boolean 型のチェックは除外</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># type: boolean</span>
</span></span><span style=display:flex><span><span style=color:#f92672>examples</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>type</span>: <span style=color:#ae81ff>csv</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>description</span>: <span style=color:#ae81ff>money_forward_main_group のレコードの例。</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>model</span>: <span style=color:#ae81ff>money_forward_main_group</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>data</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      mf_main_group_id,name,is_income
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      1,&#34;収入&#34;,true
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      2,&#34;食費&#34;,false
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      3,&#34;日用品&#34;,false</span>
</span></span><span style=display:flex><span><span style=color:#f92672>quality</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>type</span>: <span style=color:#ae81ff>SodaCL</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>specification</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>checks for money_forward_main_group</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>row_count &gt; 0</span>
</span></span></code></pre></div><p>ここで作った data contract はフルの記載ではない。<br>例えば <code>servicelevels</code> ブロックを追加して SLA を記載することもできる。<br>data contract のすべての仕様を知りたい場合は<a href=https://github.com/datacontract/datacontract-specification>仕様ドキュメント</a>を参照のこと。</p><h3 id=export-を試す>export を試す<a hidden class=anchor aria-hidden=true href=#export-を試す>#</a></h3><h4 id=json-schema>JSON Schema<a hidden class=anchor aria-hidden=true href=#json-schema>#</a></h4><p>data contract ができたところで export を試していきたい。<br>v0.10.3 では14種類のフォーマットに対しての export がサポートされており、ここではそのうちのいくつかを使ってみる。</p><p>まずは <a href=https://json-schema.org/specification>JSON Schema</a> で出力してみる。</p><pre tabindex=0><code>$ datacontract export --format jsonschema datacontract_v5.yml
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;$schema&#34;</span>: <span style=color:#e6db74>&#34;http://json-schema.org/draft-07/schema#&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;object&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;properties&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;mf_main_group_id&#34;</span>: {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;integer&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;unique&#34;</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;name&#34;</span>: {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;string&#34;</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;is_income&#34;</span>: {}
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;required&#34;</span>: [
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;mf_main_group_id&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;name&#34;</span>
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>JSON Schema の記法でモデルが表現されたものが標準出力された。<br>同様に Avro, Protobuf などの形式でも export することができる。</p><p>データ基盤的な話をすると、取り込みの対象であるアプリケーション (data provider) から送られてくるログは JSON 形式になっていることがよくある。<br>data contract をアプリケーション側とデータ基盤側で合意しておけば、アプリケーション側でログ生成時に JSON Schema でログに validation をかけることができる。<br>これによりログの schema の意図しない変更を防ぐ運用が可能になるだろう。</p><h4 id=dbt>dbt<a hidden class=anchor aria-hidden=true href=#dbt>#</a></h4><p>dbt の形式で export することもできる。<br>dbt の YAML ドキュメントを出力してみる。</p><pre tabindex=0><code>$ datacontract export --format dbt --server bigquery datacontract_v5.yml
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>version</span>: <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span><span style=color:#f92672>models</span>:
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>money_forward_main_group</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>config</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>meta</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>data_contract</span>: <span style=color:#ae81ff>my-data-contract-id</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>materialized</span>: <span style=color:#ae81ff>table</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>contract</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>enforced</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>description</span>: <span style=color:#ae81ff>MoneyForward の収支における大項目</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>columns</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>data_type</span>: <span style=color:#ae81ff>NUMBER</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>description</span>: <span style=color:#ae81ff>大項目 ID</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>constraints</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>type</span>: <span style=color:#ae81ff>not_null</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>type</span>: <span style=color:#ae81ff>unique</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>mf_main_group_id</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>data_type</span>: <span style=color:#ae81ff>STRING</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>description</span>: <span style=color:#ae81ff>大項目の項目名</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>constraints</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>type</span>: <span style=color:#ae81ff>not_null</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>name</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>description</span>: <span style=color:#ae81ff>大項目が収入の場合は true, 支出の場合は false</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>is_income</span>
</span></span></code></pre></div><p><code>data_type</code> が微妙で BigQuery の型定義になっていない。<br><code>--server bigquery</code> を与えているので配慮してほしいところではある。</p><p>sources 用のドキュメントの形式でも export できる。</p><pre tabindex=0><code>$ datacontract export --format dbt-sources --server bigquery datacontract_v5.yml
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>version</span>: <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span><span style=color:#f92672>sources</span>:
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>my-data-contract-id</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tables</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>money_forward_main_group</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>description</span>: <span style=color:#ae81ff>MoneyForward の収支における大項目</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>columns</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>tests</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>dbt_expectations.dbt_expectations.expect_column_values_to_be_of_type</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>column_type</span>: <span style=color:#ae81ff>NUMBER</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>not_null</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>unique</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>description</span>: <span style=color:#ae81ff>大項目 ID</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span>: <span style=color:#ae81ff>mf_main_group_id</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>tests</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>dbt_expectations.dbt_expectations.expect_column_values_to_be_of_type</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>column_type</span>: <span style=color:#ae81ff>STRING</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>not_null</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>description</span>: <span style=color:#ae81ff>大項目の項目名</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span>: <span style=color:#ae81ff>name</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>description</span>: <span style=color:#ae81ff>大項目が収入の場合は true, 支出の場合は false</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span>: <span style=color:#ae81ff>is_income</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>description</span>: <span style=color:#e6db74>&#39;MoneyForward の収支における分類 (項目)。
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    ダウンロードできる収支詳細に記載される情報を元に作成されている。
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#39;</span>
</span></span></code></pre></div><p>staging 用の SQL の形式の export もある。</p><pre tabindex=0><code>$ datacontract export --format dbt-staging-sql --server bigquery datacontract_v5.yml
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>    <span style=color:#66d9ef>select</span> 
</span></span><span style=display:flex><span>        mf_main_group_id, name, is_income
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>from</span> <span style=color:#960050;background-color:#1e0010>{{</span> <span style=color:#66d9ef>source</span>(<span style=color:#e6db74>&#39;my-data-contract-id&#39;</span>, <span style=color:#e6db74>&#39;money_forward_main_group&#39;</span>) <span style=color:#960050;background-color:#1e0010>}}</span>
</span></span></code></pre></div><p>このようにいくつかの dbt の形式で出力できるが、微妙な部分があるのでこのまま data contract を SSoT として dbt のファイルを CI で自動生成するという運用は現時点では難しいだろう。<br>またリッチなテストなども表現できないため、dbt をがっつり使っているチームには物足りなさがあると思われる。<br>data contract をまず作り、それをもとに dbt モデルを構築していくときのベースを作る用途なら現時点でもありかもしれない。</p><h4 id=html>HTML<a hidden class=anchor aria-hidden=true href=#html>#</a></h4><p>HTML 形式で export することもできる。<br>ホスティングして data contract を web で見せられるようにすることもできるだろう。</p><pre tabindex=0><code>$ datacontract export --format html datacontract_v5.yml &gt; money_forward_main_group.html
</code></pre><figure class=align-center><img loading=lazy src=/image/data-contract-cli/datacontract_html.png#center alt="HTML での export 例"><figcaption><p>HTML での export 例</p></figcaption></figure><p>頑張ればこれで data catalog を作ることもできそう。<br>また今回の data contract には含まれていないが、前述の <code>servicelevels</code> ブロックがあれば web 上で SLA を示せたりできて良さそうだ。</p><h2 id=考察>考察<a hidden class=anchor aria-hidden=true href=#考察>#</a></h2><p>Data Contract CLI で何ができるかがわかったところで最初の図を再掲。</p><blockquote><figure class=align-center><img loading=lazy src=/image/data-contract-cli/datacontractcli.png#center alt="datacontract/datacontract-cli より"><figcaption><p><a href=https://github.com/datacontract/datacontract-cli/tree/v0.10.1>datacontract/datacontract-cli</a> より</p></figcaption></figure></blockquote><p>この図から Data Contract CLI としては data contracts ファーストな運用を考えていることがわかる。<br>まず data provider と data consumer の合意のもとに宣言的に data contracts を作成する。<br>それに基づき、それぞれ data provider と data consumer で使われるツール用に data contracts から必要なファイルを自動生成していく。<br>例えば data provider である application 向けにはログの validation 用に JSON Schema のファイルを作成する。<br>data consumer である DWH 向けには dbt のファイルを用意する、など。</p><p>また、data contract に記載の情報からデータに対してテストを実行することができる。<br>簡単な column の制約から、SodaCL などを使ったより高度な品質チェックまで。<br>データについてのドキュメントも data contract から生成される。</p><p>このようにまず data contract ありきで、モデルのメタ情報としてはそれを SSoT とし、data provider / consumer で必要なファイルを CI で自動生成するという未来が見えてくるような気がする。<br>ただしその未来を実現するための課題も現状では多い。<br>Data Contract CLI の相互運用性 (interoperatbility) が最も大きなボトルネックになるだろう。<br>例えば想定する dbt ドキュメントが一発で作れるか、package を使ったリッチなテストが書けるか、etc.</p><p>そもそも前述したようにバグっぽい挙動や微妙な挙動もあり、このツール自体がまだ発展途上という感がある。<br>これから普及していくかというのは今のところ何とも言えない。<br>ちなみに作者の1人は <a href=https://datamesh-manager.com/>Data Mesh Manager</a> というサービスの制作者であり、(ここまでのところでは触れていなかったが) Data Contract CLI にはこの Data Mesh Manager との連携機能が組み込まれている。<br>data contract ファーストの世界のビジョンはとても面白いと思ったので、いい方向でツールが発展していくとうれしい。</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://soonraah.github.io/tags/data-contracts/>Data Contracts</a></li></ul><nav class=paginav><a class=prev href=https://soonraah.github.io/posts/dmbok-chapter-13/><span class=title>« 前へ</span><br><span>読書メモ: DMBOK2 第13章 データ品質</span>
</a><a class=next href=https://soonraah.github.io/posts/dmbok-chapter-8/><span class=title>次へ »</span><br><span>読書メモ: DMBOK2 第8章 データ統合と相互運用性</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Data Contract CLI から考える Data Contracts ファーストのデータパイプラインの未来 on x" href="https://x.com/intent/tweet/?text=Data%20Contract%20CLI%20%e3%81%8b%e3%82%89%e8%80%83%e3%81%88%e3%82%8b%20Data%20Contracts%20%e3%83%95%e3%82%a1%e3%83%bc%e3%82%b9%e3%83%88%e3%81%ae%e3%83%87%e3%83%bc%e3%82%bf%e3%83%91%e3%82%a4%e3%83%97%e3%83%a9%e3%82%a4%e3%83%b3%e3%81%ae%e6%9c%aa%e6%9d%a5&amp;url=https%3a%2f%2fsoonraah.github.io%2fposts%2fdata-contract-cli%2f&amp;hashtags=datacontracts"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Data Contract CLI から考える Data Contracts ファーストのデータパイプラインの未来 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fsoonraah.github.io%2fposts%2fdata-contract-cli%2f&amp;title=Data%20Contract%20CLI%20%e3%81%8b%e3%82%89%e8%80%83%e3%81%88%e3%82%8b%20Data%20Contracts%20%e3%83%95%e3%82%a1%e3%83%bc%e3%82%b9%e3%83%88%e3%81%ae%e3%83%87%e3%83%bc%e3%82%bf%e3%83%91%e3%82%a4%e3%83%97%e3%83%a9%e3%82%a4%e3%83%b3%e3%81%ae%e6%9c%aa%e6%9d%a5&amp;summary=Data%20Contract%20CLI%20%e3%81%8b%e3%82%89%e8%80%83%e3%81%88%e3%82%8b%20Data%20Contracts%20%e3%83%95%e3%82%a1%e3%83%bc%e3%82%b9%e3%83%88%e3%81%ae%e3%83%87%e3%83%bc%e3%82%bf%e3%83%91%e3%82%a4%e3%83%97%e3%83%a9%e3%82%a4%e3%83%b3%e3%81%ae%e6%9c%aa%e6%9d%a5&amp;source=https%3a%2f%2fsoonraah.github.io%2fposts%2fdata-contract-cli%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Data Contract CLI から考える Data Contracts ファーストのデータパイプラインの未来 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fsoonraah.github.io%2fposts%2fdata-contract-cli%2f&title=Data%20Contract%20CLI%20%e3%81%8b%e3%82%89%e8%80%83%e3%81%88%e3%82%8b%20Data%20Contracts%20%e3%83%95%e3%82%a1%e3%83%bc%e3%82%b9%e3%83%88%e3%81%ae%e3%83%87%e3%83%bc%e3%82%bf%e3%83%91%e3%82%a4%e3%83%97%e3%83%a9%e3%82%a4%e3%83%b3%e3%81%ae%e6%9c%aa%e6%9d%a5"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Data Contract CLI から考える Data Contracts ファーストのデータパイプラインの未来 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fsoonraah.github.io%2fposts%2fdata-contract-cli%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Data Contract CLI から考える Data Contracts ファーストのデータパイプラインの未来 on whatsapp" href="https://api.whatsapp.com/send?text=Data%20Contract%20CLI%20%e3%81%8b%e3%82%89%e8%80%83%e3%81%88%e3%82%8b%20Data%20Contracts%20%e3%83%95%e3%82%a1%e3%83%bc%e3%82%b9%e3%83%88%e3%81%ae%e3%83%87%e3%83%bc%e3%82%bf%e3%83%91%e3%82%a4%e3%83%97%e3%83%a9%e3%82%a4%e3%83%b3%e3%81%ae%e6%9c%aa%e6%9d%a5%20-%20https%3a%2f%2fsoonraah.github.io%2fposts%2fdata-contract-cli%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Data Contract CLI から考える Data Contracts ファーストのデータパイプラインの未来 on telegram" href="https://telegram.me/share/url?text=Data%20Contract%20CLI%20%e3%81%8b%e3%82%89%e8%80%83%e3%81%88%e3%82%8b%20Data%20Contracts%20%e3%83%95%e3%82%a1%e3%83%bc%e3%82%b9%e3%83%88%e3%81%ae%e3%83%87%e3%83%bc%e3%82%bf%e3%83%91%e3%82%a4%e3%83%97%e3%83%a9%e3%82%a4%e3%83%b3%e3%81%ae%e6%9c%aa%e6%9d%a5&amp;url=https%3a%2f%2fsoonraah.github.io%2fposts%2fdata-contract-cli%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Data Contract CLI から考える Data Contracts ファーストのデータパイプラインの未来 on ycombinator" href="https://news.ycombinator.com/submitlink?t=Data%20Contract%20CLI%20%e3%81%8b%e3%82%89%e8%80%83%e3%81%88%e3%82%8b%20Data%20Contracts%20%e3%83%95%e3%82%a1%e3%83%bc%e3%82%b9%e3%83%88%e3%81%ae%e3%83%87%e3%83%bc%e3%82%bf%e3%83%91%e3%82%a4%e3%83%97%e3%83%a9%e3%82%a4%e3%83%b3%e3%81%ae%e6%9c%aa%e6%9d%a5&u=https%3a%2f%2fsoonraah.github.io%2fposts%2fdata-contract-cli%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://soonraah.github.io/>Froglog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="コピー";function s(){t.innerHTML="コピーされました!",setTimeout(()=>{t.innerHTML="コピー"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>